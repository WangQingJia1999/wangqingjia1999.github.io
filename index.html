<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="折纸飞向麦田的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="折纸飞向麦田的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="折纸飞向麦田">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>折纸飞向麦田的博客</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?81afe862f494d24a95a49966a87c3b00"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">折纸飞向麦田的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">折纸飞向麦田</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">63</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/07/note/cpp/asan_extern_error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/07/note/cpp/asan_extern_error/" class="post-title-link" itemprop="url">记录一次 C++ extern 关键字触发的 Asan 报错</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-03-07 20:38:23 / 修改时间：21:14:20" itemprop="dateCreated datePublished" datetime="2024-03-07T20:38:23+08:00">2024-03-07</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>开发中我习惯一直开着 <code>Asan</code>，有次发现同事刚提交的代码中一个有趣的bug，复现流程简化为：</p>
<p><code>lib.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> v = <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p><code>main.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> v;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; v &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译与链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># g++ -c -o lib lib.cpp -fsanitize=address</span></span><br><span class="line"><span class="comment"># g++ -c -o main main.cpp -fsanitize=address</span></span><br><span class="line"><span class="comment"># g++ main lib -fsanitize=address</span></span><br></pre></td></tr></table></figure>

<p>运行程序，<code>Asan</code> 报错 <code>global-buffer-overflow</code> ，这个报错初看很奇怪，哪里来的 <code>buffer</code> ?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># ./a.out </span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">19128</span>==ERROR: AddressSanitizer: global-buffer-overflow on address <span class="number">0x000000602160</span> at pc <span class="number">0x000000400afe</span> bp <span class="number">0x7fffc61ca910</span> sp <span class="number">0x7fffc61ca900</span></span><br><span class="line">READ of size <span class="number">4</span> at <span class="number">0x000000602160</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x400afd</span> in main (/home/demo/asan/a.out+<span class="number">0x400afd</span>)</span><br><span class="line">    #<span class="number">1</span> <span class="number">0x7f7af82423d4</span> in __libc_start_main (/lib64/libc.so<span class="number">.6</span>+<span class="number">0x223d4</span>)</span><br><span class="line">    #<span class="number">2</span> <span class="number">0x400a18</span>  (/home/demo/asan/a.out+<span class="number">0x400a18</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x000000602161</span> is located <span class="number">0</span> bytes to the right of global variable <span class="string">&#x27;v&#x27;</span> defined in <span class="string">&#x27;lib.cpp:1:6&#x27;</span> (<span class="number">0x602160</span>) of size <span class="number">1</span></span><br><span class="line">SUMMARY: AddressSanitizer: global-buffer-overflow (/home/demo/asan/a.out+<span class="number">0x400afd</span>) in main</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0000800b83d0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000800b83e0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000800b83f0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000800b8400</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000800b8410</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f9 f9 f9 f9</span><br><span class="line">=&gt;<span class="number">0x0000800b8420</span>: f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9[<span class="number">01</span>]f9 f9 f9</span><br><span class="line">  <span class="number">0x0000800b8430</span>: f9 f9 f9 f9 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9 f9</span><br><span class="line">  <span class="number">0x0000800b8440</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000800b8450</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000800b8460</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000800b8470</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">Shadow byte legend (one shadow byte represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">==<span class="number">19128</span>==ABORTING</span><br></pre></td></tr></table></figure>

<p>参考 <a href="/2024/03/07/note/cpp/asan_shadow_bytes/" title="解读 ASan 的 Shadow bytes">解读 ASan 的 Shadow bytes</a>，可解读出如下关键信息</p>
<ul>
<li><code>0x000000602161 is located 0 bytes to the right of global variable &#39;v&#39; defined in &#39;lib.cpp:1:6&#39; (0x602160) of size 1</code><ul>
<li>指明是读变量 <code>v</code> 时触发</li>
</ul>
</li>
<li><code>=&gt;0x0000800b8420: f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9 f9[01]f9 f9 f9</code> <ul>
<li>要读取的8字节内存，只有1个字节可读</li>
</ul>
</li>
</ul>
<p>发现是在 <code>main</code> 用 <code>extern</code> 声明的变量 <code>v</code> 为 <code>int</code> 即4字节，但 <code>lib</code> 模块定义为 <code>bool v = 10;</code>，即声明与定义的类型没匹配上，只定义了4个字节中首个字节，因此在 <code>main</code> 中访问时，<code>Asan</code> 检测到内存问题，所以 <code>buffer</code> 指代 <code>v</code> 所占用的4字节。</p>
<p>如果不是 <code>Asan</code> ，这个问题很难注意到，因为编译器和链接器无法发现，且运行时也大概率无 <code>segmentation fault</code>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/07/note/cpp/asan_shadow_bytes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/07/note/cpp/asan_shadow_bytes/" class="post-title-link" itemprop="url">解读 ASan 的 Shadow bytes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-03-07 20:16:33 / 修改时间：20:42:26" itemprop="dateCreated datePublished" datetime="2024-03-07T20:16:33+08:00">2024-03-07</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文参考：<a target="_blank" rel="noopener" href="https://stackoverflow.com/a/61719265/11850070">https://stackoverflow.com/a/61719265/11850070</a></p>
<p>首先需要准确理解如下单词的含义：</p>
<ul>
<li>shadow最常用的意思是 ”影子“，但在 Asan 的语境里应该用释义： <code>to follow and watch sb closely and often secretly 跟踪</code> ，因此 <code>shadow bytes</code> 不应翻译为影子字节，而是追踪字节，用于追踪内存是否可读&#x2F;写。</li>
<li>legend - the explanation of a map or a diagram in a book 图例</li>
<li>redzone - 禁区</li>
</ul>
<p><code>Asan</code> 的 <code>shadow bytes</code> 明确告知问题内存周围的读写状态。</p>
<p>如下面报错 <code>=&gt;0x0000826e1720:[01]</code> 明确指出这8个字节只有1个字节可读。</p>
<ul>
<li>原因是变量声明为<code>extern int v;</code>，但在另一个编译单元初始化为 <code>bool var = false;</code>，导致4字节的<code>int</code>只有首字节可读。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Shadow bytes around the buggy address: <span class="comment">// 读/写某个内存地址触发ASAN报错时，该地址前后的内存区域类型一览</span></span><br><span class="line">  <span class="number">0x0000826e16d0</span>: f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9</span><br><span class="line">  <span class="number">0x0000826e16e0</span>: f9 f9 f9 f9 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f9 f9 f9 f9 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000826e16f0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> f9 f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9</span><br><span class="line">  <span class="number">0x0000826e1700</span>: <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9</span><br><span class="line">  <span class="number">0x0000826e1710</span>: <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9</span><br><span class="line">=&gt;<span class="number">0x0000826e1720</span>:[<span class="number">01</span>]f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000826e1730</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0000826e1740</span>: <span class="number">00</span> <span class="number">00</span> f9 f9 f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9</span><br><span class="line">  <span class="number">0x0000826e1750</span>: <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9</span><br><span class="line">  <span class="number">0x0000826e1760</span>: <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9</span><br><span class="line">  <span class="number">0x0000826e1770</span>: <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9 <span class="number">00</span> f9 f9 f9 f9 f9 f9 f9</span><br><span class="line">Shadow byte legend (one shadow byte represents <span class="number">8</span> application bytes): <span class="comment">// 上述追踪字节的图例，每个追踪字节代表实际内存的8个字节，即追踪字节的每一位标识一个字节</span></span><br><span class="line">  Addressable:           <span class="number">00</span>                         <span class="comment">// 如果某个追踪字节是00，则代表对应的8个字节均可寻址(即可读写）</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span>       <span class="comment">// 部分可寻址，01-07分别代表1-7个字节可寻址，该报错 =&gt;0x0000826e1720:[01] 就表示这8个字节只有1个字节可寻址。</span></span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9                       <span class="comment">// 全局变量禁区</span></span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/06/note/linux/ld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/06/note/linux/ld/" class="post-title-link" itemprop="url">Linux ld</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-06 20:05:32" itemprop="dateCreated datePublished" datetime="2024-03-06T20:05:32+08:00">2024-03-06</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>19 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/ld/index.html">LD用户手册</a></p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240221073200.png" alt="image.png"></p>
<h1 id="Linker-Script"><a href="#Linker-Script" class="headerlink" title="Linker Script"></a>Linker Script</h1><p>主要作用是描述源目标文件的section怎么在最终生成的文件中排布。</p>
<p>linker script是必需的，如果没指明，则用默认的。</p>
<p>怎么查看默认的linker script？<br>文档中说用 <code>ld --verbose</code>，但ubuntu-20.04 wsl执行后报错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ld --verbose</span><br><span class="line">ld: fatal error: no input files</span><br></pre></td></tr></table></figure>

<p>用GDB跟下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  <span class="built_in">gldelf_x86_64_get_script</span> (isfile=<span class="number">0x7fffffffdfb4</span>) at eelf_x86_64.c:<span class="number">158</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x0000555555589ec9</span> <span class="function">in <span class="title">main</span> <span class="params">(argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;)</span> at ./ldmain.c:<span class="number">402</span></span></span><br></pre></td></tr></table></figure>

<p>发现linker script是由 <code>ld/genscripts.sh</code> 生成，截取<code>genscripts.sh</code>中的片段如下（针对某个cpu架构，有多个链接脚本可选，根据链接器所传参数使用对应的链接脚本。这里只关注链接可执行文件时用到的x后缀脚本，即 <code>elf_x86_64.x</code>）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DATA_ALIGNMENT=<span class="variable">$&#123;DATA_ALIGNMENT_&#125;</span></span><br><span class="line">RELOCATING=<span class="string">&quot; &quot;</span></span><br><span class="line">LD_FLAG=</span><br><span class="line">( <span class="built_in">echo</span> <span class="string">&quot;/* Default linker script, for normal executables */&quot;</span></span><br><span class="line">  source_sh <span class="variable">$&#123;CUSTOMIZER_SCRIPT&#125;</span></span><br><span class="line">  source_sh <span class="variable">$&#123;srcdir&#125;</span>/scripttempl/<span class="variable">$&#123;SCRIPT_NAME&#125;</span>.sc</span><br><span class="line">) | sed -e <span class="string">&#x27;/^ *$/d;s/[	 ]*$//&#x27;</span> &gt; ldscripts/<span class="variable">$&#123;EMULATION_NAME&#125;</span>.x</span><br><span class="line"></span><br><span class="line">LD_FLAG=textonly</span><br><span class="line">( <span class="built_in">echo</span> <span class="string">&quot;/* Script for -z separate-code */&quot;</span></span><br><span class="line">  source_sh <span class="variable">$&#123;CUSTOMIZER_SCRIPT&#125;</span></span><br><span class="line">  source_sh <span class="variable">$&#123;srcdir&#125;</span>/scripttempl/<span class="variable">$&#123;SCRIPT_NAME&#125;</span>.sc</span><br><span class="line">) | sed -e <span class="string">&#x27;/^ *$/d;s/[	 ]*$//&#x27;</span> &gt; ldscripts/<span class="variable">$&#123;EMULATION_NAME&#125;</span>.xe</span><br></pre></td></tr></table></figure>

<p>在 Ubuntu-20.04 中，这些linker scripts放在 <code>/lib/x86_64-linux-gnu/ldscripts/</code> 下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ll /lib/x86_64-linux-gnu/ldscripts/elf_x86_64.x</span><br><span class="line">elf_x86_64.x     elf_x86_64.xce   elf_x86_64.xdce  elf_x86_64.xdwe  elf_x86_64.xr    elf_x86_64.xsce  elf_x86_64.xswe  elf_x86_64.xwe   </span><br><span class="line">elf_x86_64.xbn   elf_x86_64.xd    elf_x86_64.xde   elf_x86_64.xe    elf_x86_64.xs    elf_x86_64.xse   elf_x86_64.xu    </span><br><span class="line">elf_x86_64.xc    elf_x86_64.xdc   elf_x86_64.xdw   elf_x86_64.xn    elf_x86_64.xsc   elf_x86_64.xsw   elf_x86_64.xw  </span><br></pre></td></tr></table></figure>

<p>当前ld版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ld --version</span><br><span class="line">GNU gold (GNU Binutils <span class="keyword">for</span> Ubuntu 2.34) 1.16</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">This program is free software; you may redistribute it under the terms of</span><br><span class="line">the GNU General Public License version 3 or (at your option) a later version.</span><br><span class="line">This program has absolutely no warranty.</span><br></pre></td></tr></table></figure>

<p>可执行文件默认的链接脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line">/* Default linker script, for normal executables */</span><br><span class="line">/* Copyright (C) 2014-2020 Free Software Foundation, Inc.</span><br><span class="line">   Copying and distribution of this script, with or without modification,</span><br><span class="line">   are permitted in any medium without royalty provided the copyright</span><br><span class="line">   notice and this notice are preserved.  */</span><br><span class="line">OUTPUT_FORMAT(&quot;elf64-x86-64&quot;, &quot;elf64-x86-64&quot;,</span><br><span class="line">	      &quot;elf64-x86-64&quot;)</span><br><span class="line">OUTPUT_ARCH(i386:x86-64)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">SEARCH_DIR(&quot;=/usr/local/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/usr/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/usr/lib/x86_64-linux-gnu64&quot;); SEARCH_DIR(&quot;=/usr/local/lib64&quot;); SEARCH_DIR(&quot;=/lib64&quot;); SEARCH_DIR(&quot;=/usr/lib64&quot;); SEARCH_DIR(&quot;=/usr/local/lib&quot;); SEARCH_DIR(&quot;=/lib&quot;); SEARCH_DIR(&quot;=/usr/lib&quot;); SEARCH_DIR(&quot;=/usr/x86_64-linux-gnu/lib64&quot;); SEARCH_DIR(&quot;=/usr/x86_64-linux-gnu/lib&quot;);</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">  /* Read-only sections, merged into text segment: */</span><br><span class="line">  PROVIDE (__executable_start = SEGMENT_START(&quot;text-segment&quot;, 0x400000)); . = SEGMENT_START(&quot;text-segment&quot;, 0x400000) + SIZEOF_HEADERS;</span><br><span class="line">  .interp         : &#123; *(.interp) &#125;</span><br><span class="line">  .note.gnu.build-id  : &#123; *(.note.gnu.build-id) &#125;</span><br><span class="line">  .hash           : &#123; *(.hash) &#125;</span><br><span class="line">  .gnu.hash       : &#123; *(.gnu.hash) &#125;</span><br><span class="line">  .dynsym         : &#123; *(.dynsym) &#125;</span><br><span class="line">  .dynstr         : &#123; *(.dynstr) &#125;</span><br><span class="line">  .gnu.version    : &#123; *(.gnu.version) &#125;</span><br><span class="line">  .gnu.version_d  : &#123; *(.gnu.version_d) &#125;</span><br><span class="line">  .gnu.version_r  : &#123; *(.gnu.version_r) &#125;</span><br><span class="line">  .rela.init      : &#123; *(.rela.init) &#125;</span><br><span class="line">  .rela.text      : &#123; *(.rela.text .rela.text.* .rela.gnu.linkonce.t.*) &#125;</span><br><span class="line">  .rela.fini      : &#123; *(.rela.fini) &#125;</span><br><span class="line">  .rela.rodata    : &#123; *(.rela.rodata .rela.rodata.* .rela.gnu.linkonce.r.*) &#125;</span><br><span class="line">  .rela.data.rel.ro   : &#123; *(.rela.data.rel.ro .rela.data.rel.ro.* .rela.gnu.linkonce.d.rel.ro.*) &#125;</span><br><span class="line">  .rela.data      : &#123; *(.rela.data .rela.data.* .rela.gnu.linkonce.d.*) &#125;</span><br><span class="line">  .rela.tdata	  : &#123; *(.rela.tdata .rela.tdata.* .rela.gnu.linkonce.td.*) &#125;</span><br><span class="line">  .rela.tbss	  : &#123; *(.rela.tbss .rela.tbss.* .rela.gnu.linkonce.tb.*) &#125;</span><br><span class="line">  .rela.ctors     : &#123; *(.rela.ctors) &#125;</span><br><span class="line">  .rela.dtors     : &#123; *(.rela.dtors) &#125;</span><br><span class="line">  .rela.got       : &#123; *(.rela.got) &#125;</span><br><span class="line">  .rela.bss       : &#123; *(.rela.bss .rela.bss.* .rela.gnu.linkonce.b.*) &#125;</span><br><span class="line">  .rela.ldata     : &#123; *(.rela.ldata .rela.ldata.* .rela.gnu.linkonce.l.*) &#125;</span><br><span class="line">  .rela.lbss      : &#123; *(.rela.lbss .rela.lbss.* .rela.gnu.linkonce.lb.*) &#125;</span><br><span class="line">  .rela.lrodata   : &#123; *(.rela.lrodata .rela.lrodata.* .rela.gnu.linkonce.lr.*) &#125;</span><br><span class="line">  .rela.ifunc     : &#123; *(.rela.ifunc) &#125;</span><br><span class="line">  .rela.plt       :</span><br><span class="line">    &#123;</span><br><span class="line">      *(.rela.plt)</span><br><span class="line">      PROVIDE_HIDDEN (__rela_iplt_start = .);</span><br><span class="line">      *(.rela.iplt)</span><br><span class="line">      PROVIDE_HIDDEN (__rela_iplt_end = .);</span><br><span class="line">    &#125;</span><br><span class="line">  .init           :</span><br><span class="line">  &#123;</span><br><span class="line">    KEEP (*(SORT_NONE(.init)))</span><br><span class="line">  &#125;</span><br><span class="line">  .plt            : &#123; *(.plt) *(.iplt) &#125;</span><br><span class="line">.plt.got        : &#123; *(.plt.got) &#125;</span><br><span class="line">.plt.sec        : &#123; *(.plt.sec) &#125;</span><br><span class="line">  .text           :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.text.unlikely .text.*_unlikely .text.unlikely.*)</span><br><span class="line">    *(.text.exit .text.exit.*)</span><br><span class="line">    *(.text.startup .text.startup.*)</span><br><span class="line">    *(.text.hot .text.hot.*)</span><br><span class="line">    *(SORT(.text.sorted.*))</span><br><span class="line">    *(.text .stub .text.* .gnu.linkonce.t.*)</span><br><span class="line">    /* .gnu.warning sections are handled specially by elf.em.  */</span><br><span class="line">    *(.gnu.warning)</span><br><span class="line">  &#125;</span><br><span class="line">  .fini           :</span><br><span class="line">  &#123;</span><br><span class="line">    KEEP (*(SORT_NONE(.fini)))</span><br><span class="line">  &#125;</span><br><span class="line">  PROVIDE (__etext = .);</span><br><span class="line">  PROVIDE (_etext = .);</span><br><span class="line">  PROVIDE (etext = .);</span><br><span class="line">  .rodata         : &#123; *(.rodata .rodata.* .gnu.linkonce.r.*) &#125;</span><br><span class="line">  .rodata1        : &#123; *(.rodata1) &#125;</span><br><span class="line">  .eh_frame_hdr   : &#123; *(.eh_frame_hdr) *(.eh_frame_entry .eh_frame_entry.*) &#125;</span><br><span class="line">  .eh_frame       : ONLY_IF_RO &#123; KEEP (*(.eh_frame)) *(.eh_frame.*) &#125;</span><br><span class="line">  .gcc_except_table   : ONLY_IF_RO &#123; *(.gcc_except_table .gcc_except_table.*) &#125;</span><br><span class="line">  .gnu_extab   : ONLY_IF_RO &#123; *(.gnu_extab*) &#125;</span><br><span class="line">  /* These sections are generated by the Sun/Oracle C++ compiler.  */</span><br><span class="line">  .exception_ranges   : ONLY_IF_RO &#123; *(.exception_ranges*) &#125;</span><br><span class="line">  /* Adjust the address for the data segment.  We want to adjust up to</span><br><span class="line">     the same address within the page on the next page up.  */</span><br><span class="line">  . = DATA_SEGMENT_ALIGN (CONSTANT (MAXPAGESIZE), CONSTANT (COMMONPAGESIZE));</span><br><span class="line">  /* Exception handling  */</span><br><span class="line">  .eh_frame       : ONLY_IF_RW &#123; KEEP (*(.eh_frame)) *(.eh_frame.*) &#125;</span><br><span class="line">  .gnu_extab      : ONLY_IF_RW &#123; *(.gnu_extab) &#125;</span><br><span class="line">  .gcc_except_table   : ONLY_IF_RW &#123; *(.gcc_except_table .gcc_except_table.*) &#125;</span><br><span class="line">  .exception_ranges   : ONLY_IF_RW &#123; *(.exception_ranges*) &#125;</span><br><span class="line">  /* Thread Local Storage sections  */</span><br><span class="line">  .tdata	  :</span><br><span class="line">   &#123;</span><br><span class="line">     PROVIDE_HIDDEN (__tdata_start = .);</span><br><span class="line">     *(.tdata .tdata.* .gnu.linkonce.td.*)</span><br><span class="line">   &#125;</span><br><span class="line">  .tbss		  : &#123; *(.tbss .tbss.* .gnu.linkonce.tb.*) *(.tcommon) &#125;</span><br><span class="line">  .preinit_array    :</span><br><span class="line">  &#123;</span><br><span class="line">    PROVIDE_HIDDEN (__preinit_array_start = .);</span><br><span class="line">    KEEP (*(.preinit_array))</span><br><span class="line">    PROVIDE_HIDDEN (__preinit_array_end = .);</span><br><span class="line">  &#125;</span><br><span class="line">  .init_array    :</span><br><span class="line">  &#123;</span><br><span class="line">    PROVIDE_HIDDEN (__init_array_start = .);</span><br><span class="line">    KEEP (*(SORT_BY_INIT_PRIORITY(.init_array.*) SORT_BY_INIT_PRIORITY(.ctors.*)))</span><br><span class="line">    KEEP (*(.init_array EXCLUDE_FILE (*crtbegin.o *crtbegin?.o *crtend.o *crtend?.o ) .ctors))</span><br><span class="line">    PROVIDE_HIDDEN (__init_array_end = .);</span><br><span class="line">  &#125;</span><br><span class="line">  .fini_array    :</span><br><span class="line">  &#123;</span><br><span class="line">    PROVIDE_HIDDEN (__fini_array_start = .);</span><br><span class="line">    KEEP (*(SORT_BY_INIT_PRIORITY(.fini_array.*) SORT_BY_INIT_PRIORITY(.dtors.*)))</span><br><span class="line">    KEEP (*(.fini_array EXCLUDE_FILE (*crtbegin.o *crtbegin?.o *crtend.o *crtend?.o ) .dtors))</span><br><span class="line">    PROVIDE_HIDDEN (__fini_array_end = .);</span><br><span class="line">  &#125;</span><br><span class="line">  .ctors          :</span><br><span class="line">  &#123;</span><br><span class="line">    /* gcc uses crtbegin.o to find the start of</span><br><span class="line">       the constructors, so we make sure it is</span><br><span class="line">       first.  Because this is a wildcard, it</span><br><span class="line">       doesn&#x27;t matter if the user does not</span><br><span class="line">       actually link against crtbegin.o; the</span><br><span class="line">       linker won&#x27;t look for a file to match a</span><br><span class="line">       wildcard.  The wildcard also means that it</span><br><span class="line">       doesn&#x27;t matter which directory crtbegin.o</span><br><span class="line">       is in.  */</span><br><span class="line">    KEEP (*crtbegin.o(.ctors))</span><br><span class="line">    KEEP (*crtbegin?.o(.ctors))</span><br><span class="line">    /* We don&#x27;t want to include the .ctor section from</span><br><span class="line">       the crtend.o file until after the sorted ctors.</span><br><span class="line">       The .ctor section from the crtend file contains the</span><br><span class="line">       end of ctors marker and it must be last */</span><br><span class="line">    KEEP (*(EXCLUDE_FILE (*crtend.o *crtend?.o ) .ctors))</span><br><span class="line">    KEEP (*(SORT(.ctors.*)))</span><br><span class="line">    KEEP (*(.ctors))</span><br><span class="line">  &#125;</span><br><span class="line">  .dtors          :</span><br><span class="line">  &#123;</span><br><span class="line">    KEEP (*crtbegin.o(.dtors))</span><br><span class="line">    KEEP (*crtbegin?.o(.dtors))</span><br><span class="line">    KEEP (*(EXCLUDE_FILE (*crtend.o *crtend?.o ) .dtors))</span><br><span class="line">    KEEP (*(SORT(.dtors.*)))</span><br><span class="line">    KEEP (*(.dtors))</span><br><span class="line">  &#125;</span><br><span class="line">  .jcr            : &#123; KEEP (*(.jcr)) &#125;</span><br><span class="line">  .data.rel.ro : &#123; *(.data.rel.ro.local* .gnu.linkonce.d.rel.ro.local.*) *(.data.rel.ro .data.rel.ro.* .gnu.linkonce.d.rel.ro.*) &#125;</span><br><span class="line">  .dynamic        : &#123; *(.dynamic) &#125;</span><br><span class="line">  .got            : &#123; *(.got) *(.igot) &#125;</span><br><span class="line">  . = DATA_SEGMENT_RELRO_END (SIZEOF (.got.plt) &gt;= 24 ? 24 : 0, .);</span><br><span class="line">  .got.plt        : &#123; *(.got.plt) *(.igot.plt) &#125;</span><br><span class="line">  .data           :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.data .data.* .gnu.linkonce.d.*)</span><br><span class="line">    SORT(CONSTRUCTORS)</span><br><span class="line">  &#125;</span><br><span class="line">  .data1          : &#123; *(.data1) &#125;</span><br><span class="line">  _edata = .; PROVIDE (edata = .);</span><br><span class="line">  . = .;</span><br><span class="line">  __bss_start = .;</span><br><span class="line">  .bss            :</span><br><span class="line">  &#123;</span><br><span class="line">   *(.dynbss)</span><br><span class="line">   *(.bss .bss.* .gnu.linkonce.b.*)</span><br><span class="line">   *(COMMON)</span><br><span class="line">   /* Align here to ensure that the .bss section occupies space up to</span><br><span class="line">      _end.  Align after .bss to ensure correct alignment even if the</span><br><span class="line">      .bss section disappears because there are no input sections.</span><br><span class="line">      FIXME: Why do we need it? When there is no .bss section, we do not</span><br><span class="line">      pad the .data section.  */</span><br><span class="line">   . = ALIGN(. != 0 ? 64 / 8 : 1);</span><br><span class="line">  &#125;</span><br><span class="line">  .lbss   :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.dynlbss)</span><br><span class="line">    *(.lbss .lbss.* .gnu.linkonce.lb.*)</span><br><span class="line">    *(LARGE_COMMON)</span><br><span class="line">  &#125;</span><br><span class="line">  . = ALIGN(64 / 8);</span><br><span class="line">  . = SEGMENT_START(&quot;ldata-segment&quot;, .);</span><br><span class="line">  .lrodata   ALIGN(CONSTANT (MAXPAGESIZE)) + (. &amp; (CONSTANT (MAXPAGESIZE) - 1)) :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.lrodata .lrodata.* .gnu.linkonce.lr.*)</span><br><span class="line">  &#125;</span><br><span class="line">  .ldata   ALIGN(CONSTANT (MAXPAGESIZE)) + (. &amp; (CONSTANT (MAXPAGESIZE) - 1)) :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.ldata .ldata.* .gnu.linkonce.l.*)</span><br><span class="line">    . = ALIGN(. != 0 ? 64 / 8 : 1);</span><br><span class="line">  &#125;</span><br><span class="line">  . = ALIGN(64 / 8);</span><br><span class="line">  _end = .; PROVIDE (end = .);</span><br><span class="line">  . = DATA_SEGMENT_END (.);</span><br><span class="line">  /* Stabs debugging sections.  */</span><br><span class="line">  .stab          0 : &#123; *(.stab) &#125;</span><br><span class="line">  .stabstr       0 : &#123; *(.stabstr) &#125;</span><br><span class="line">  .stab.excl     0 : &#123; *(.stab.excl) &#125;</span><br><span class="line">  .stab.exclstr  0 : &#123; *(.stab.exclstr) &#125;</span><br><span class="line">  .stab.index    0 : &#123; *(.stab.index) &#125;</span><br><span class="line">  .stab.indexstr 0 : &#123; *(.stab.indexstr) &#125;</span><br><span class="line">  .comment       0 : &#123; *(.comment) &#125;</span><br><span class="line">  .gnu.build.attributes : &#123; *(.gnu.build.attributes .gnu.build.attributes.*) &#125;</span><br><span class="line">  /* DWARF debug sections.</span><br><span class="line">     Symbols in the DWARF debugging sections are relative to the beginning</span><br><span class="line">     of the section so we begin them at 0.  */</span><br><span class="line">  /* DWARF 1 */</span><br><span class="line">  .debug          0 : &#123; *(.debug) &#125;</span><br><span class="line">  .line           0 : &#123; *(.line) &#125;</span><br><span class="line">  /* GNU DWARF 1 extensions */</span><br><span class="line">  .debug_srcinfo  0 : &#123; *(.debug_srcinfo) &#125;</span><br><span class="line">  .debug_sfnames  0 : &#123; *(.debug_sfnames) &#125;</span><br><span class="line">  /* DWARF 1.1 and DWARF 2 */</span><br><span class="line">  .debug_aranges  0 : &#123; *(.debug_aranges) &#125;</span><br><span class="line">  .debug_pubnames 0 : &#123; *(.debug_pubnames) &#125;</span><br><span class="line">  /* DWARF 2 */</span><br><span class="line">  .debug_info     0 : &#123; *(.debug_info .gnu.linkonce.wi.*) &#125;</span><br><span class="line">  .debug_abbrev   0 : &#123; *(.debug_abbrev) &#125;</span><br><span class="line">  .debug_line     0 : &#123; *(.debug_line .debug_line.* .debug_line_end) &#125;</span><br><span class="line">  .debug_frame    0 : &#123; *(.debug_frame) &#125;</span><br><span class="line">  .debug_str      0 : &#123; *(.debug_str) &#125;</span><br><span class="line">  .debug_loc      0 : &#123; *(.debug_loc) &#125;</span><br><span class="line">  .debug_macinfo  0 : &#123; *(.debug_macinfo) &#125;</span><br><span class="line">  /* SGI/MIPS DWARF 2 extensions */</span><br><span class="line">  .debug_weaknames 0 : &#123; *(.debug_weaknames) &#125;</span><br><span class="line">  .debug_funcnames 0 : &#123; *(.debug_funcnames) &#125;</span><br><span class="line">  .debug_typenames 0 : &#123; *(.debug_typenames) &#125;</span><br><span class="line">  .debug_varnames  0 : &#123; *(.debug_varnames) &#125;</span><br><span class="line">  /* DWARF 3 */</span><br><span class="line">  .debug_pubtypes 0 : &#123; *(.debug_pubtypes) &#125;</span><br><span class="line">  .debug_ranges   0 : &#123; *(.debug_ranges) &#125;</span><br><span class="line">  /* DWARF Extension.  */</span><br><span class="line">  .debug_macro    0 : &#123; *(.debug_macro) &#125;</span><br><span class="line">  .debug_addr     0 : &#123; *(.debug_addr) &#125;</span><br><span class="line">  .gnu.attributes 0 : &#123; KEEP (*(.gnu.attributes)) &#125;</span><br><span class="line">  /DISCARD/ : &#123; *(.note.GNU-stack) *(.gnu_debuglink) *(.gnu.lto_*) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Relocation-重定向"><a href="#Relocation-重定向" class="headerlink" title="Relocation 重定向"></a>Relocation 重定向</h1><blockquote>
<p>A relocation is an action which the linker must take when linking.</p>
</blockquote>
<h2 id="静态重定向"><a href="#静态重定向" class="headerlink" title="静态重定向"></a>静态重定向</h2><h2 id="动态重定向"><a href="#动态重定向" class="headerlink" title="动态重定向"></a>动态重定向</h2><p>运行时由动态链接器(ld.so)修改符号的值，用gdb可观察该行为。</p>
<p>gdb抓取动态重定向调用栈，详见：<a target="_blank" rel="noopener" href="https://stackoverflow.com/a/69490442/11850070">https://stackoverflow.com/a/69490442/11850070</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x00007ffff7fe01e0</span> in _dl_fixup (l=&lt;optimized out&gt;, reloc_arg=&lt;optimized out&gt;) at ../sysdeps/x86_64/dl-machine.h:<span class="number">242</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00007ffff7fe7c3e</span> in _dl_runtime_resolve_xsavec () at ../sysdeps/x86_64/dl-trampoline.h:<span class="number">126</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0x00000000004005a2</span> in <span class="title function_">main</span> <span class="params">()</span> at t.c:5</span><br></pre></td></tr></table></figure>

<p>符号 <code>_dl_fixup</code> 在 ld.so 中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/glibc/build/install/lib$ nm ld-2.32.so | grep _dl_fixup</span><br><span class="line">000000000000f970 t _dl_fixup</span><br></pre></td></tr></table></figure>

<p>一个 <code>link_map</code> 对应一个so？</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="http://chuquan.me/2018/06/03/linking-static-linking-dynamic-linking/#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5">http://chuquan.me/2018/06/03/linking-static-linking-dynamic-linking/#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/06/note/cpp/%E8%99%9A%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/06/note/cpp/%E8%99%9A%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">从汇编角度理解 C++ 虚函数实现原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-03-06 20:05:32 / 修改时间：20:23:57" itemprop="dateCreated datePublished" datetime="2024-03-06T20:05:32+08:00">2024-03-06</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>从汇编角度，分析编译器（本文基于 <code>gcc version 9.4.0</code>）如何实现c++的虚函数机制。</p>
<p>注意：c++标准没有规定必须用虚函数表这种形式实现，只是大多数编译器都会采用这种实现方式。</p>
<p>原理概述：一个类只要声明了一个虚函数，则编译器为该类生成一个虚函数表，虚函数表本质是一个函数指针数组，包含该类所有成员函数的最终入口地址。每个对象在构造时，额外存一个虚函数表指针，指向虚函数表起始地址。调用每个成员函数时，查虚函数表，确定真正的函数入口地址。</p>
<p>需要明确：虚函数表本身在只读数据段内，独一份，由该类所有对象实例共享，而虚函数指针在单个对象实例内，每个对象人手一份。</p>
<h1 id="虚函数表内容"><a href="#虚函数表内容" class="headerlink" title="虚函数表内容"></a>虚函数表内容</h1><p>首先，看下虚函数表中究竟有什么。</p>
<h2 id="动态查看"><a href="#动态查看" class="headerlink" title="动态查看"></a>动态查看</h2><p>最简单直观的一种方式，在GDB中，可打印运行时的虚函数表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Base* p = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br><span class="line">    p-&gt;<span class="built_in">foo</span>();</span><br><span class="line">    p-&gt;<span class="built_in">bar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl p</span><br><span class="line">vtable <span class="keyword">for</span> <span class="string">&#x27;Base&#x27;</span> @ <span class="number">0x555555556d18</span> (subobject @ <span class="number">0x555555569eb0</span>):</span><br><span class="line">[<span class="number">0</span>]: <span class="number">0x555555554a72</span> &lt;Derived::<span class="built_in">foo</span>()&gt;</span><br><span class="line">[<span class="number">1</span>]: <span class="number">0x555555554a62</span> &lt;Base::<span class="built_in">bar</span>()&gt;</span><br></pre></td></tr></table></figure>

<h2 id="静态查看"><a href="#静态查看" class="headerlink" title="静态查看"></a>静态查看</h2><h3 id="g-支持导出类的虚函数表"><a href="#g-支持导出类的虚函数表" class="headerlink" title="g++支持导出类的虚函数表"></a>g++支持导出类的虚函数表</h3><p>编译时加上参数：<code>-fdump-lang-class</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -fdump-lang-<span class="keyword">class</span> <span class="title class_">demo</span>.cpp</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NOTE: Before GCC 8, the option is -fdump-class-hierarchy instead of -fdump-lang-class.</p>
</blockquote>
<p>测试代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo.cpp</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Base* p = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br><span class="line">    p-&gt;<span class="built_in">foo</span>();</span><br><span class="line">    p-&gt;<span class="built_in">bar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，GDB的输出是省略了虚函数表的前两项，只输出成员函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Vtable <span class="keyword">for</span> Derived</span><br><span class="line">Derived::_ZTV7Derived: <span class="number">4</span> entries</span><br><span class="line"><span class="number">0</span>     (<span class="type">int</span> (*)(...))<span class="number">0</span></span><br><span class="line"><span class="number">8</span>     (<span class="type">int</span> (*)(...))(&amp; _ZTI7Derived)</span><br><span class="line"><span class="number">16</span>    (<span class="type">int</span> (*)(...))Derived::foo</span><br><span class="line"><span class="number">24</span>    (<span class="type">int</span> (*)(...))Base::bar</span><br><span class="line"></span><br><span class="line"><span class="meta"># c++filt _ZTI7Derived</span></span><br><span class="line">typeinfo <span class="keyword">for</span> Derived</span><br></pre></td></tr></table></figure>

<h3 id="直接查看编译器生成汇编代码"><a href="#直接查看编译器生成汇编代码" class="headerlink" title="直接查看编译器生成汇编代码"></a>直接查看编译器生成汇编代码</h3><p>通过分析编译器生成汇编代码，静态分析虚函数表中内容。</p>
<p>测试代码:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo.cpp</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Base* p = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br><span class="line">    p-&gt;<span class="built_in">foo</span>();</span><br><span class="line">    p-&gt;<span class="built_in">bar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用 -S 指示g++编译成功后停止，只输出汇编代码，不汇编。</p>
<p>注意：g++ -S 输出的汇编代码中所有符号均已 name-mangled，因此需要用 <code>c++filt</code> 还原符号。</p>
<p>将可读的汇编代码存到 <code>demo.s</code> 中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g++ -S -g demo.cpp -o demo.mangled.s</span><br><span class="line"><span class="built_in">cat</span> demo.mangled.s | c++filt &gt; demo.s</span><br></pre></td></tr></table></figure>

<p>从汇编代码中摘出Base和Derived类的虚函数表（与 <code>g++ -fdump-lang-class</code> 给出的结果一致）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vtable <span class="keyword">for</span> Derived:</span><br><span class="line">	.quad	<span class="number">0</span>                    <span class="comment">// 填充8字节的 0x0 </span></span><br><span class="line">	.quad	typeinfo <span class="keyword">for</span> Derived <span class="comment">// 符号 `typeinfo for Derived` 的地址（8字节）</span></span><br><span class="line">	.quad	<span class="title function_">Derived::foo</span><span class="params">()</span>       <span class="comment">// 符号 `Derived::foo()` 的地址</span></span><br><span class="line">	.quad	<span class="title function_">Base::bar</span><span class="params">()</span>          <span class="comment">// 继承父类的 `Base::bar()`</span></span><br><span class="line">	.weak	vtable <span class="keyword">for</span> Base</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 指明 `vtable for Derived` 存放于 `.data.rel.ro.local` 节</span></span><br><span class="line">	.section	.data.rel.ro.local._ZTV4Base,&quot;awG&quot;,@progbits,vtable <span class="keyword">for</span> Base,comdat</span><br><span class="line">	.align 8</span><br><span class="line">	.type	vtable <span class="keyword">for</span> Base, @object</span><br><span class="line">	.size	vtable <span class="keyword">for</span> Base, 32  <span class="comment">// 该虚函数表长度为32字节，4个8字节的地址。</span></span><br><span class="line"></span><br><span class="line">vtable <span class="keyword">for</span> Base:</span><br><span class="line">	.quad	0</span><br><span class="line">	.quad	typeinfo <span class="keyword">for</span> Base</span><br><span class="line">	.quad	<span class="title function_">Base::foo</span><span class="params">()</span></span><br><span class="line">	.quad	<span class="title function_">Base::bar</span><span class="params">()</span></span><br><span class="line">	.weak	typeinfo <span class="keyword">for</span> Derived</span><br><span class="line">	.section	.data.rel.ro._ZTI7Derived,&quot;awG&quot;,@progbits,typeinfo <span class="keyword">for</span> Derived,comdat</span><br><span class="line">	.align 8</span><br><span class="line">	.type	typeinfo <span class="keyword">for</span> Derived, @object</span><br><span class="line">	.size	typeinfo <span class="keyword">for</span> Derived, 24</span><br></pre></td></tr></table></figure>

<h3 id="反汇编ELF可执行文件"><a href="#反汇编ELF可执行文件" class="headerlink" title="反汇编ELF可执行文件"></a>反汇编ELF可执行文件</h3><p>对编译链接后的可执行文件反汇编，看下最终的静态虚函数表长什么样。</p>
<p>虚函数表 <code>vtable for Derived</code> 位于: <code>[0x1d28, 0x1d28 + 0x20 = 0x1d48]</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -t -C | grep <span class="string">&quot;vtable&quot;</span></span><br><span class="line"><span class="number">0000000000001</span>d48  w    O .data.rel.ro.local     <span class="number">0000000000000020</span>              vtable <span class="keyword">for</span> Base</span><br><span class="line"><span class="number">0000000000001</span>d28  w    O .data.rel.ro.local     <span class="number">0000000000000020</span>              vtable <span class="keyword">for</span> Derived</span><br></pre></td></tr></table></figure>

<p><code>.data.rel.ro.local</code> 是数据节，内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -C -j .data.rel.ro.local -s a.out</span><br><span class="line"></span><br><span class="line">a.out:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">Contents of section .data.rel.ro.local:</span><br><span class="line"> <span class="comment">// 这32字节是虚函数表 vtable for Derived 的内容</span></span><br><span class="line"> <span class="number">1</span>d28 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">781</span>d0000 <span class="number">00000000</span>  ........x.......</span><br><span class="line"> <span class="number">1</span>d38 dc080000 <span class="number">00000000</span> cc080000 <span class="number">00000000</span>  ................</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 这32字节是虚函数表 vtable for Base 的内容</span></span><br><span class="line"> <span class="number">1</span>d48 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">901</span>d0000 <span class="number">00000000</span>  ................</span><br><span class="line"> <span class="number">1</span>d58 bc080000 <span class="number">00000000</span> cc080000 <span class="number">00000000</span>  ................</span><br></pre></td></tr></table></figure>

<p>解析 <code>vtable for Derived</code> 内四个按小端存储的地址：</p>
<ul>
<li><code>0x0</code></li>
<li><code>0x1d78</code></li>
<li><code>0x8dc</code></li>
<li><code>0x8cc</code></li>
</ul>
<p>正是 <code>Derived</code> 的成员函数符号地址，与 <code>g++ -S</code> 给出的汇编代码一致。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -C -t a.out | egrep <span class="string">&quot;1d78|8dc|8cc&quot;</span></span><br><span class="line"><span class="number">00000000000008</span>cc  w    F .text  <span class="number">000000000000000f</span>              Base::bar()</span><br><span class="line"><span class="number">00000000000008</span>dc  w    F .text  <span class="number">000000000000000f</span>              Derived::foo()</span><br><span class="line"><span class="number">0000000000001</span>d78  w    O .data.rel.ro   <span class="number">0000000000000018</span>              typeinfo <span class="keyword">for</span> Derived</span><br></pre></td></tr></table></figure>

<h1 id="虚函数表指针在哪？"><a href="#虚函数表指针在哪？" class="headerlink" title="虚函数表指针在哪？"></a>虚函数表指针在哪？</h1><p>测试代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> a = <span class="number">0x11223344</span>;</span><br><span class="line">	<span class="type">short</span> b = <span class="number">0x5566</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Base* p = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br><span class="line">    p-&gt;<span class="built_in">foo</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>多态对象的构造:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>          Base* p = new Derived();</span><br><span class="line">   <span class="number">0x0000555555554866</span> &lt;+<span class="number">13</span>&gt;:    mov    $<span class="number">0x10</span>,%edi     <span class="comment">// sizeof(Derived) = 16 = 0x10</span></span><br><span class="line">   <span class="number">0x000055555555486b</span> &lt;+<span class="number">18</span>&gt;:    callq  <span class="number">0x555555554760</span> <span class="comment">// new()</span></span><br><span class="line">   <span class="number">0x0000555555554870</span> &lt;+<span class="number">23</span>&gt;:    mov    %rax,%rbx      <span class="comment">// $rax 存 new() 申请到的内存的起始地址，将该地址转存 $rbx，$rbx等价于函数指针p</span></span><br><span class="line">   <span class="number">0x0000555555554873</span> &lt;+<span class="number">26</span>&gt;:    movq   $<span class="number">0x0</span>,(%rbx)    <span class="comment">// 初始化堆中对象前8字节为0</span></span><br><span class="line">   <span class="number">0x000055555555487a</span> &lt;+<span class="number">33</span>&gt;:    movl   $<span class="number">0x0</span>,<span class="number">0x8</span>(%rbx) <span class="comment">// 初始化紧跟的4字节为0</span></span><br><span class="line">   <span class="number">0x0000555555554881</span> &lt;+<span class="number">40</span>&gt;:    movw   $<span class="number">0x0</span>,<span class="number">0xc</span>(%rbx) <span class="comment">// 初始化紧跟的2字节为0</span></span><br><span class="line">   <span class="number">0x0000555555554887</span> &lt;+<span class="number">46</span>&gt;:    mov    %rbx,%rdi      <span class="comment">// 将对象起始地址传入$rdi，作为 Derived::Derived() 的首个入参</span></span><br><span class="line">=&gt; <span class="number">0x000055555555488a</span> &lt;+<span class="number">49</span>&gt;:    callq  <span class="number">0x555555554900</span> &lt;Derived::Derived()&gt;</span><br><span class="line">   <span class="number">0x000055555555488f</span> &lt;+<span class="number">54</span>&gt;:    mov    %rbx,<span class="number">-0x18</span>(%rbp)</span><br></pre></td></tr></table></figure>

<p>p 指向对象起始地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p/x $rbx</span><br><span class="line">$<span class="number">9</span> = <span class="number">0x555555568eb0</span></span><br><span class="line">(gdb) p/x p</span><br><span class="line">$<span class="number">10</span> = <span class="number">0x555555568eb0</span></span><br></pre></td></tr></table></figure>

<p>此刻p所指对象的状态：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/<span class="number">12b</span> $rbx</span><br><span class="line"><span class="number">0x555555568eb0</span>: <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span></span><br><span class="line"><span class="number">0x555555568eb8</span>: <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span></span><br></pre></td></tr></table></figure>

<p>执行 <code>main+49</code> 即 <code>Derived::Derived()</code> 后，构造函数填充如下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/<span class="number">16b</span> $rbx</span><br><span class="line"><span class="number">0x555555568eb0</span>: <span class="number">0x38</span>    <span class="number">0x5d</span>    <span class="number">0x55</span>    <span class="number">0x55</span>    <span class="number">0x55</span>    <span class="number">0x55</span>    <span class="number">0x00</span>    <span class="number">0x00</span></span><br><span class="line"><span class="number">0x555555568eb8</span>: <span class="number">0x44</span>    <span class="number">0x33</span>    <span class="number">0x22</span>    <span class="number">0x11</span>    <span class="number">0x66</span>    <span class="number">0x55</span>    <span class="number">0x00</span>    <span class="number">0x00</span></span><br></pre></td></tr></table></figure>

<p>由于小端存储，这16字节，翻译过来是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000555555555d38</span> | <span class="number">0x11223344</span> | <span class="number">0x00005566</span></span><br></pre></td></tr></table></figure>

<p>前8字节就是虚函数表指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info symbol <span class="number">0x0000555555555d38</span></span><br><span class="line">vtable <span class="keyword">for</span> Derived + <span class="number">16</span> in section .data.rel.ro.local of /home/redis/demo/a.out</span><br></pre></td></tr></table></figure>

<h1 id="虚函数调用过程"><a href="#虚函数调用过程" class="headerlink" title="虚函数调用过程"></a>虚函数调用过程</h1><p>测试代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Derived</span> : <span class="keyword">public</span> Base</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">foo</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Base* p = <span class="keyword">new</span> <span class="built_in">Derived</span>();</span><br><span class="line">    p-&gt;<span class="built_in">foo</span>();</span><br><span class="line">    p-&gt;<span class="built_in">bar</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>p-&gt;foo();</code> 即调用子类重写的函数，对应的汇编代码片段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x000055555555487d</span> &lt;+<span class="number">36</span>&gt;:    callq  <span class="number">0x55555555490a</span> &lt;Derived::Derived()&gt;</span><br><span class="line">   <span class="number">0x0000555555554882</span> &lt;+<span class="number">41</span>&gt;:    mov    %rbx,<span class="number">-0x18</span>(%rbp)   <span class="comment">// 复制指针p的值到 $rbp-0x18</span></span><br><span class="line">   <span class="number">0x0000555555554886</span> &lt;+<span class="number">45</span>&gt;:    mov    <span class="number">-0x18</span>(%rbp),%rax   <span class="comment">// 转存指针p的值到 $rax</span></span><br><span class="line">=&gt; <span class="number">0x000055555555488a</span> &lt;+<span class="number">49</span>&gt;:    mov    (%rax),%rax        </span><br><span class="line">   <span class="number">0x000055555555488d</span> &lt;+<span class="number">52</span>&gt;:    mov    (%rax),%rdx</span><br><span class="line">   <span class="number">0x0000555555554890</span> &lt;+<span class="number">55</span>&gt;:    mov    <span class="number">-0x18</span>(%rbp),%rax</span><br><span class="line">   <span class="number">0x0000555555554894</span> &lt;+<span class="number">59</span>&gt;:    mov    %rax,%rdi</span><br><span class="line">   <span class="number">0x0000555555554897</span> &lt;+<span class="number">62</span>&gt;:    callq  *%rdx</span><br></pre></td></tr></table></figure>

<p>此刻寄存器与内存的状态如下，此刻 <code>$rbx</code> 存指针 <code>p</code> 的值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p/x p</span><br><span class="line">$<span class="number">18</span> = <span class="number">0x555555568eb0</span></span><br><span class="line">(gdb) x/g $rbx</span><br><span class="line"><span class="number">0x555555568eb0</span>: <span class="number">0x0000555555555d38</span>     <span class="comment">// $rbx存0x555555568eb0，而 0x555555568eb0 地址上存放8字节 0x0000555555555d38</span></span><br><span class="line">(gdb) x/g $rbp<span class="number">-0x18</span></span><br><span class="line"><span class="number">0x7fffffffe2b8</span>: <span class="number">0x0000555555568eb0</span>     <span class="comment">// 将 p 的值暂存当前栈帧上</span></span><br><span class="line">(gdb) x/g $rax</span><br><span class="line"><span class="number">0x555555568eb0</span>: <span class="number">0x0000555555555d38</span>     <span class="comment">// $rax = p</span></span><br></pre></td></tr></table></figure>

<p>关键就在这两行汇编代码，此刻 <code>$rax</code> 存指针 <code>p</code> 的值，这两行执行后，<code>$rdx</code> 要存放 <code>Derived::foo()</code> 的入口地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">=&gt; <span class="number">0x000055555555488a</span> &lt;+<span class="number">49</span>&gt;:    mov    (%rax),%rax</span><br><span class="line">   <span class="number">0x000055555555488d</span> &lt;+<span class="number">52</span>&gt;:    mov    (%rax),%rdx</span><br></pre></td></tr></table></figure>

<p>执行 <code>main+49</code> 的 <code>mov (%rax),%rax</code> ，读取 <code>p</code> 所指内存前8字节内容，读取到 <code>0x555555555d38</code> 即虚函数表指针，存入 <code>$rax</code>。<br>而 <code>0x555555555d38</code> 位于 <code>vtable for Derived+16</code>，即虚函数表内首个函数指针的地址。<br>而 <code>0x555555555d38</code> 所指的 <code>0x00005555555548dc</code> 正是位于 <code>.text</code> 节的 <code>Derived::foo()</code> 符号的入口地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x000055555555488a</span> &lt;+<span class="number">49</span>&gt;:    mov    (%rax),%rax        </span><br><span class="line">=&gt; <span class="number">0x000055555555488d</span> &lt;+<span class="number">52</span>&gt;:    mov    (%rax),%rdx</span><br><span class="line"></span><br><span class="line">(gdb) x/g $rax</span><br><span class="line"><span class="number">0x555555555d38</span> &lt;_ZTV7Derived+<span class="number">16</span>&gt;:       <span class="number">0x00005555555548dc</span></span><br><span class="line">(gdb) dem _ZTV7Derived</span><br><span class="line">vtable <span class="keyword">for</span> Derived</span><br><span class="line"></span><br><span class="line">(gdb) info symbol <span class="number">0x555555555d38</span></span><br><span class="line">vtable <span class="keyword">for</span> Derived + <span class="number">16</span> in section .data.rel.ro.local of /home/redis/demo/a.out</span><br><span class="line"></span><br><span class="line">(gdb) info vtbl p</span><br><span class="line">vtable <span class="keyword">for</span> <span class="string">&#x27;Base&#x27;</span> @ <span class="number">0x555555555d38</span> (subobject @ <span class="number">0x555555568eb0</span>):</span><br><span class="line">[<span class="number">0</span>]: <span class="number">0x5555555548dc</span> &lt;Derived::foo()&gt;</span><br><span class="line">[<span class="number">1</span>]: <span class="number">0x5555555548cc</span> &lt;Base::bar()&gt;</span><br><span class="line"></span><br><span class="line">(gdb) info symbol <span class="number">0x00005555555548dc</span></span><br><span class="line">Derived::foo() in section .text of /home/redis/demo/a.out</span><br></pre></td></tr></table></figure>

<p>继续执行 <code>mov (%rax),%rdx</code>，对 <code>0x555555555d38</code> 这个函数指针的地址解引用，取得所指的 <code>Derived::foo()</code> 的符号入口地址 <code>0x5555555548dc</code>，存入 <code>$rdx</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/x $rdx</span><br><span class="line"><span class="number">0x5555555548dc</span> &lt;Derived::foo()&gt;:        <span class="number">0xe5894855fa1e0ff3</span>  <span class="comment">// 0xe5894855fa1e0ff3这一串其实是 Derived::foo() 的汇编指令</span></span><br></pre></td></tr></table></figure>

<p>最后执行 <code>Derived::foo()</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000555555554897</span> &lt;+<span class="number">62</span>&gt;:    callq  *%rdx</span><br></pre></td></tr></table></figure>

<p>总结：通过对象中的虚函数表指针，找到虚函数表，进而找到对应成员函数的真正入口地址。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/06/note/linux/gas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/06/note/linux/gas/" class="post-title-link" itemprop="url">Linux GAS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-06 20:05:32" itemprop="dateCreated datePublished" datetime="2024-03-06T20:05:32+08:00">2024-03-06</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>备忘Linux下 AT&amp;T 汇编语法。</p>
<h1 id="GAS文档"><a href="#GAS文档" class="headerlink" title="GAS文档"></a>GAS文档</h1><p><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/">GAS文档</a></p>
<h1 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world!"></a>hello world!</h1><p>汇编打印 “hello world”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.section .data</span><br><span class="line">    hello_world:</span><br><span class="line">        .string &quot;Hello world!\n&quot;</span><br><span class="line">    hello_world_len = . - hello_world</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">    .globl _start</span><br><span class="line">    _start:</span><br><span class="line">        mov $1, %rax         # syscall number for sys_write</span><br><span class="line">        mov $1, %rdi         # file descriptor 1 (stdout)</span><br><span class="line">        movq $hello_world, %rsi    # pointer to the string</span><br><span class="line">        mov $hello_world_len, %rdx # length of the string</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        mov $60, %rax        # syscall number for sys_exit</span><br><span class="line">        xor %rdi, %rdi       # exit code 0</span><br><span class="line">        syscall</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>汇编并链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as -o demo.o demo.s &amp;&amp; ld -o demo.out demo.o</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./demo.out </span><br><span class="line">Hello world!</span><br></pre></td></tr></table></figure>

<h1 id="符号"><a href="#符号" class="headerlink" title="$ 符号"></a>$ 符号</h1><p>立即数的前缀。</p>
<p>注意如下区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov 1, %rax  # 将内存以0x01起始的8字节复制到%rax</span><br><span class="line">mov $1, %rax # 将立即数1复制到%rax</span><br><span class="line"></span><br><span class="line">mov var, %rax # 将var的值而不是地址复制到%rax</span><br><span class="line">mov $var, %rax # 将var的地址复制到%rax</span><br></pre></td></tr></table></figure>

<h2 id="错误示范"><a href="#错误示范" class="headerlink" title="错误示范"></a>错误示范</h2><p>将字符串起始地址复制到 %rax，没加 $ 符号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// demo.s</span><br><span class="line">.section .data</span><br><span class="line">    hello_world:</span><br><span class="line">        .string &quot;Hello world!\n&quot;</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">    .globl _start</span><br><span class="line">    _start:</span><br><span class="line">        mov hello_world, %rax</span><br><span class="line">        nop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>汇编并链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as -o demo.o demo.s &amp;&amp; ld -o demo.out demo.o</span><br></pre></td></tr></table></figure>

<p>GDB对可执行文件中的 <code>_start</code> 反汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; disassemble _start</span><br><span class="line">Dump of assembler code for function _start:</span><br><span class="line">   0x00000000004000b0 &lt;+0&gt;:     mov    0x4010b9,%rax</span><br><span class="line">=&gt; 0x00000000004000b8 &lt;+8&gt;:     nop</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p><code>0x4010b9</code> 是字符串起始地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; x/13z 0x4010b9</span><br><span class="line">0x4010b9:       0x48    0x65    0x6c    0x6c    0x6f    0x20    0x77    0x6f</span><br><span class="line">0x4010c1:       0x72    0x6c    0x64    0x21    0x0a</span><br><span class="line">&gt;&gt;&gt; x/13c 0x4010b9</span><br><span class="line">0x4010b9:       72 &#x27;H&#x27;  101 &#x27;e&#x27; 108 &#x27;l&#x27; 108 &#x27;l&#x27; 111 &#x27;o&#x27; 32 &#x27; &#x27;  119 &#x27;w&#x27; 111 &#x27;o&#x27;</span><br><span class="line">0x4010c1:       114 &#x27;r&#x27; 108 &#x27;l&#x27; 100 &#x27;d&#x27; 33 &#x27;!&#x27;  10 &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>

<p>但执行 <code>mov 0x4010b9,%rax</code> 后，<code>%rax</code> 中实际放的是 “Hello wo”，即将符号 <code>hello_world</code> 的值 “hello_world\n” 截断后保留前8个字节，存入 <code>%rax</code>，而不是期望的将 <code>hello_world</code> 符号的地址 <code>0x4010b9</code> 存入 <code>%rax</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p/x $rax</span><br><span class="line">$1 = 0x6f77206f6c6c6548</span><br></pre></td></tr></table></figure>

<p>应加上 <code>$</code>，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.section .data</span><br><span class="line">    hello_world:</span><br><span class="line">        .string &quot;Hello world!\n&quot;</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">    .globl _start</span><br><span class="line">    _start:</span><br><span class="line">        mov $hello_world, %rax # 加上$，取符号的地址</span><br><span class="line">        nop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这次，<code>%rax</code> 中正确存放符号的地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; p/x $rax</span><br><span class="line">$1 = 0x4010b8</span><br></pre></td></tr></table></figure>

<h1 id="操作数的顺序"><a href="#操作数的顺序" class="headerlink" title="操作数的顺序"></a>操作数的顺序</h1><p>从左向右</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movq %rsp, %rbp <span class="comment">// copy %rsp to %rbp</span></span><br></pre></td></tr></table></figure>

<h1 id="其他一些特点"><a href="#其他一些特点" class="headerlink" title="其他一些特点"></a>其他一些特点</h1><ul>
<li>mnemonic suffixes indicate the size of the operands (<code>q</code> for quad, etc.)</li>
<li>registers are prefixed with <code>%</code> and immediate values with <code>$</code></li>
<li>effective addresses are in the form <code>DISP(BASE, INDEX, SCALE)</code> (DISP + BASE + INDEX * SCALE)</li>
<li>Indirect jump&#x2F;call operands indicated with * (as opposed to direct).</li>
</ul>
<h1 id="圆括号"><a href="#圆括号" class="headerlink" title="圆括号"></a>圆括号</h1><p>如下代码中圆括号的含义？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov (%rax), %eax</span><br></pre></td></tr></table></figure>

<p>解释：<br>从 <code>rax</code> 寄存器中保存的内存地址读出4字节，复制到 <code>eax</code> 寄存器。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/41232333/what-is-the-difference-between-mov-rax-eax-and-mov-rax-eax">详见 stackoverflow</a></li>
</ul>
<p>如下代码含义？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov %rcx, %rax</span><br></pre></td></tr></table></figure>

<p>解释：复制 <code>rcx</code> 中8字节到 <code>rax</code> 中</p>
<p>因此，圆括号表示解引用。</p>
<p>如果反过来，则是将 <code>rax</code> 中的8字节，拷贝到 <code>rbx</code> 所指的8字节内存中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov %rax,(%rbx)</span><br></pre></td></tr></table></figure>

<p>等价于c中的（<code>rax</code> 中是 value，<code>rbx</code> 中是 ptr）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*ptr = value;</span><br></pre></td></tr></table></figure>

<h2 id="Symbol-符号"><a href="#Symbol-符号" class="headerlink" title="Symbol 符号"></a>Symbol 符号</h2><blockquote>
<p>Symbols are a central concept: the programmer uses symbols to name things, the linker uses symbols to link, and the debugger uses symbols to debug.</p>
</blockquote>
<h3 id="符号名"><a href="#符号名" class="headerlink" title="符号名"></a>符号名</h3><ul>
<li>区分大小写，foo !&#x3D; Foo</li>
<li>符号名首个字符可以是 字母、英文句号、短下划线或者$</li>
<li>后面跟若干数字、字母、$</li>
</ul>
<h3 id="label"><a href="#label" class="headerlink" title="label"></a>label</h3><p>符号名+’:’</p>
<h2 id="String-字符串"><a href="#String-字符串" class="headerlink" title="String 字符串"></a>String 字符串</h2><h3 id="string"><a href="#string" class="headerlink" title=".string"></a>.string</h3><p>末尾加一个字节，值为0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">s3:</span><br><span class="line">    .string &quot;ccc&quot;</span><br><span class="line">    .ascii &quot;ccc&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ as demo.s &amp;&amp; objdump -sD</span><br><span class="line"></span><br><span class="line">a.out:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Contents of section .data:</span><br><span class="line"> 0000 63636300 636363                      ccc.ccc         </span><br><span class="line"></span><br><span class="line">Disassembly of section .data:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;s3&gt;:</span><br><span class="line">   0:   63 63 63                movslq 0x63(%rbx),%esp</span><br><span class="line">   3:   00 63 63                add    %ah,0x63(%rbx)</span><br><span class="line">   6:   63                      .byte 0x63</span><br></pre></td></tr></table></figure>

<h3 id="ascii"><a href="#ascii" class="headerlink" title=".ascii"></a>.ascii</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">.s1:</span><br><span class="line">    .ascii &quot;aaa&quot;</span><br><span class="line">s2:</span><br><span class="line">    .ascii &quot;bbb&quot;</span><br><span class="line"></span><br><span class="line">.text</span><br><span class="line">s3:</span><br><span class="line">    .ascii &quot;ccc&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ as demo.s &amp;&amp; objdump -s a.out </span><br><span class="line"></span><br><span class="line">a.out:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Contents of section .text:</span><br><span class="line"> 0000 636363                               ccc             </span><br><span class="line">Contents of section .data:</span><br><span class="line"> 0000 61616162 6262                        aaabbb          </span><br></pre></td></tr></table></figure>

<h2 id="L"><a href="#L" class="headerlink" title=".L"></a>.L</h2><p>GCC uses the .L for local labels.</p>
<h2 id="LFB-LFE-LBB-LBE"><a href="#LFB-LFE-LBB-LBE" class="headerlink" title=".LFB, .LFE, .LBB, .LBE"></a>.LFB, .LFE, .LBB, .LBE</h2><p>They are all defined under <a target="_blank" rel="noopener" href="https://github.com/gcc-mirror/gcc/blob/releases/gcc-4.8.2/gcc/dwarf2out.c">gcc&#x2F;dwarf2out.c</a> on GCC 4.8.2.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FUNC_BEGIN_LABEL  <span class="string">&quot;LFB&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUNC_END_LABEL    <span class="string">&quot;LFE&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_BEGIN_LABEL <span class="string">&quot;LBB&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_END_LABEL   <span class="string">&quot;LBE&quot;</span></span></span><br><span class="line">ASM_GENERATE_INTERNAL_LABEL (loclabel, <span class="string">&quot;LVL&quot;</span>, loclabel_num);</span><br></pre></td></tr></table></figure>

<h1 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">                      +-----+----+--+</span><br><span class="line">partial program # 1:  |ttttt|dddd|00|</span><br><span class="line">                      +-----+----+--+</span><br><span class="line"></span><br><span class="line">                      text   data bss</span><br><span class="line">                      seg.   seg. seg.</span><br><span class="line"></span><br><span class="line">                      +---+---+---+</span><br><span class="line">partial program # 2:  |TTT|DDD|000|</span><br><span class="line">                      +---+---+---+</span><br><span class="line"></span><br><span class="line">                      +--+---+-----+--+----+---+-----+~~</span><br><span class="line">linked program:       |  |TTT|ttttt|  |dddd|DDD|00000|</span><br><span class="line">                      +--+---+-----+--+----+---+-----+~~</span><br><span class="line"></span><br><span class="line">    addresses:        0 …</span><br></pre></td></tr></table></figure>

<p>TODO: section group 是什么？</p>
<h1 id="Directive-指示符"><a href="#Directive-指示符" class="headerlink" title="Directive 指示符"></a>Directive 指示符</h1><p>All assembler directives have names that begin with a period <code>.</code> The rest of the name is letters, usually in lower case.</p>
<blockquote>
<p>用途</p>
</blockquote>
<p>In AT&amp;T assembly syntax, a directive is a command that is used to instruct the assembler on how to process the information in the assembly source code. Unlike instructions, which tell the CPU what to do, directives tell the assembler how to process the information. </p>
<h2 id="byte"><a href="#byte" class="headerlink" title=".byte"></a>.byte</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.byte expr</span><br></pre></td></tr></table></figure>

<h2 id="quad"><a href="#quad" class="headerlink" title=".quad"></a><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/Quad.html">.quad</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.quad expression(s)</span><br></pre></td></tr></table></figure>

<p>A “word” is two bytes; hence <em>quad</em>-word for 8 bytes.</p>
<p>填充8字节</p>
<h2 id="loc"><a href="#loc" class="headerlink" title=".loc"></a><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/Loc.html">.loc</a></h2><p>a debugging directive, and it only appears in GCC if you tell the compiler to generate debugging information with -ggdb or -g.</p>
<h2 id="global"><a href="#global" class="headerlink" title=".global"></a><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/Global.html">.global</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.global symbol</span><br><span class="line">.globl symbol</span><br></pre></td></tr></table></figure>

<p><code>.global</code> makes the symbol visible to <code>ld</code>. If you define symbol in your partial program, its value is made available to other partial programs that are linked with it.</p>
<p>Both spellings (‘.globl’ and ‘.global’) are accepted, for compatibility with other assemblers.</p>
<h1 id="movq-movl-movw"><a href="#movq-movl-movw" class="headerlink" title="movq, movl, movw"></a>movq, movl, movw</h1><ol>
<li><strong><code>movw</code></strong>: move a word (16 bits)</li>
<li><strong><code>movl</code></strong>: move a long word (32 bits)</li>
<li><strong><code>movq</code></strong>: move a quadword (64 bits)</li>
</ol>
<h1 id="call"><a href="#call" class="headerlink" title="call"></a>call</h1><p>执行后，将 <code>rip</code> 放入栈顶，然后调新函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.global main</span><br><span class="line"></span><br><span class="line">foo:</span><br><span class="line">    pushq %rax</span><br><span class="line">    movq %rax, %rbp</span><br><span class="line"></span><br><span class="line">main:    </span><br><span class="line">    call foo // 调用foo之前，将rip入栈</span><br><span class="line"></span><br><span class="line">    movq $60, %rax  # syscall: exit</span><br><span class="line">    xorq %rdi, %rdi # status: 0</span><br><span class="line">    syscall</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc call.s -g -o call</span><br></pre></td></tr></table></figure>

<p>用GDB调试<br><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240223064438.png" alt="image.png"></p>
<p>进入foo之后，打印栈顶8字节，正是rip的值。同时发现，rip指向栈顶元素（8个字节中最低位一个字节 0x02，因小端存储）</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240223064352.png" alt="image.png"></p>
<h1 id="Effective-Address"><a href="#Effective-Address" class="headerlink" title="Effective Address"></a>Effective Address</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[base + index*scale + disp]      # Intel, including GAS .<span class="function">intel_syntax noprefix</span></span><br><span class="line"><span class="function"><span class="title">disp</span><span class="params">(base, index, scale)</span>         # AT&amp;T</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240223064329.png" alt="image.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/06/note/cpp/%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/06/note/cpp/%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96/" class="post-title-link" itemprop="url">C++内联汇编</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-06 20:05:32" itemprop="dateCreated datePublished" datetime="2024-03-06T20:05:32+08:00">2024-03-06</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html">Extended Asm (Using the GNU Compiler Collection (GCC))</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> b = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inline assembly to add &#x27;a&#x27; and &#x27;b&#x27; and store the result in &#x27;result&#x27;</span></span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;add %1, %2\\n&quot;</span>     <span class="comment">// b = a + b</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;mov %2, %0\\n&quot;</span>     <span class="comment">// result = b</span></span><br><span class="line"></span><br><span class="line">        : <span class="string">&quot;=r&quot;</span>(result)       <span class="comment">// Output operand</span></span><br><span class="line"></span><br><span class="line">        : <span class="string">&quot;r&quot;</span>(a), <span class="string">&quot;r&quot;</span>(b)     <span class="comment">// Input operands</span></span><br><span class="line"></span><br><span class="line">        : <span class="string">&quot;cc&quot;</span>               <span class="comment">// The clobber &quot;cc&quot; informs the compiler that the assembly code may modify the condition codes (flags).</span></span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Great example to help to understand RAX:RDX pair used in instructions like <code>MUL</code>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> a = <span class="number">0xFFFFFFFFFFFFFFFF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> b = <span class="number">0x0000000000000002</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint64_t</span> result_low, result_high;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Multiply &#x27;a&#x27; and &#x27;b&#x27; using inline assembly and store the 128-bit result</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// in the RDX:RAX register pair</span></span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;mulq %3&quot;</span>            <span class="comment">// Multiply RAX (implicitly) with &#x27;b&#x27;, result stored in RDX:RAX</span></span><br><span class="line"></span><br><span class="line">        : <span class="string">&quot;=a&quot;</span>(result_low),  <span class="comment">// Output operand for the lower 64 bits (RAX)</span></span><br><span class="line"></span><br><span class="line">          <span class="string">&quot;=d&quot;</span>(result_high)  <span class="comment">// Output operand for the upper 64 bits (RDX)</span></span><br><span class="line"></span><br><span class="line">        : <span class="string">&quot;0&quot;</span>(a),            <span class="comment">// Input operand for &#x27;a&#x27; (placed in RAX)</span></span><br><span class="line"></span><br><span class="line">          <span class="string">&quot;rm&quot;</span>(b)            <span class="comment">// Input operand for &#x27;b&#x27;</span></span><br><span class="line"></span><br><span class="line">        : <span class="string">&quot;cc&quot;</span>               <span class="comment">// Clobbers</span></span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Result (high): 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; result_high &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Result (low):  0x&quot;</span> &lt;&lt; std::hex &lt;&lt; result_low &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>cmpxchg8b m64<br>当 DA &#x3D;&#x3D; m64 时，把 BC 存入 m64</p>
<ul>
<li>m64 - 待比较和更新值的内存地址</li>
<li>EDX:EAX - 如果EDX:EAX !&#x3D; m64, 则把m64存到EDX:EAX</li>
<li>ECX:EBX - 如果EDX:EAX &#x3D;&#x3D; m64，则把该新值存入 m64</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/06/note/cpp/stl/smart_ptr/smart_pointer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/06/note/cpp/stl/smart_ptr/smart_pointer/" class="post-title-link" itemprop="url">C++ std::shared_ptr</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-06 20:05:32" itemprop="dateCreated datePublished" datetime="2024-03-06T20:05:32+08:00">2024-03-06</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://csguide.cn/cpp/memory/shared_ptr.html#%E6%89%8B%E5%86%99-shared-ptr">https://csguide.cn/cpp/memory/shared_ptr.html#%E6%89%8B%E5%86%99-shared-ptr</a></p>
<h1 id="shared-ptr"><a href="#shared-ptr" class="headerlink" title="shared_ptr"></a>shared_ptr</h1><p>总结：内部是一个指向对象的指针，两个引用计数int（用atomic接口修改计数值，保证引用计数修改的线程安全），但是所指对象的线程安全没有保证。</p>
<p>打印shared_ptr <code>p1</code>的引用计数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p p1._M_refcount._M_pi._M_use_count</span><br><span class="line">$<span class="number">17</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/memory.html#shared_ptr.thread">gcc shared_ptr imp doc</a></p>
<p>x86_64下一个shared_ptr是16字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) pt /o p1</span><br><span class="line"><span class="comment">/* offset    |  size */</span>  type = class <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;<span class="type">int</span>&gt; [with _Tp = <span class="type">int</span>] : public <span class="built_in">std</span>::__shared_ptr&lt;_Tp, (__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体构成:</p>
<ul>
<li>真正的指针8字节</li>
<li>use_count4字节</li>
<li>weak_count4字节<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(gdb) pt /o p1._M_refcount</span><br><span class="line"><span class="comment">/* offset    |  size */</span>  type = class <span class="built_in">std</span>::__shared_count&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; &#123;</span><br><span class="line">                         private:</span><br><span class="line"><span class="comment">/*    0      |     8 */</span>    <span class="built_in">std</span>::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; *_M_pi;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* total size (bytes):    8 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(gdb) pt /o p1._M_ptr</span><br><span class="line">type = <span class="type">int</span> *</span><br><span class="line"></span><br><span class="line">(gdb) pt /o p1._M_refcount._M_pi</span><br><span class="line">type = class <span class="built_in">std</span>::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; : public <span class="built_in">std</span>::_Mutex_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; &#123;</span><br><span class="line">                         private:</span><br><span class="line"><span class="comment">/*    8      |     4 */</span>    _Atomic_word _M_use_count;</span><br><span class="line"><span class="comment">/*   12      |     4 */</span>    _Atomic_word _M_weak_count;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">&#125; *</span><br></pre></td></tr></table></figure></li>
</ul>
<p>完整的内存布局为:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*    0      |     8 */</span>    <span class="type">int</span> * _M_ptr</span><br><span class="line"><span class="comment">/*    8      |     4 */</span>    _Atomic_word _M_use_count;</span><br><span class="line"><span class="comment">/*   12      |     4 */</span>    _Atomic_word _M_weak_count;</span><br></pre></td></tr></table></figure>

<p><code>0x0000000000604020</code> 是 _M_ptr 所指地址，这么看，两个counter是放在了对象的前面（地址小于对象指针）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p &amp;p1</span><br><span class="line">$<span class="number">23</span> = (<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;<span class="type">int</span>&gt; *) <span class="number">0x7ffffffed730</span></span><br><span class="line"></span><br><span class="line">(gdb) p <span class="keyword">sizeof</span>(p1)</span><br><span class="line">$<span class="number">24</span> = <span class="number">16</span></span><br><span class="line"></span><br><span class="line">(gdb) p p1._M_ptr</span><br><span class="line">$<span class="number">14</span> = (<span class="built_in">std</span>::__shared_ptr&lt;<span class="type">int</span>, (__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt;::element_type *) <span class="number">0x604020</span></span><br><span class="line"></span><br><span class="line">(gdb) x/<span class="number">2</span>gx &amp;p1._M_ptr</span><br><span class="line"><span class="number">0x7ffffffed730</span>: <span class="number">0x0000000000604020</span>      <span class="number">0x0000000000604010</span></span><br><span class="line"></span><br><span class="line">(gdb) x/<span class="number">2</span>gx <span class="number">0x0000000000604020</span></span><br><span class="line"><span class="number">0x604020</span>:       <span class="number">0x000000000000000a</span>      <span class="number">0x0000000000020fe1</span></span><br><span class="line"></span><br><span class="line">(gdb) p *p1</span><br><span class="line">$<span class="number">25</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">(gdb) p/x &#123;&amp;p1, &amp;p1._M_ptr&#125;</span><br><span class="line">$<span class="number">26</span> = &#123;<span class="number">0x7ffffffed730</span>, <span class="number">0x7ffffffed730</span>&#125;</span><br><span class="line"></span><br><span class="line">(gdb) p &amp;p1._M_refcount._M_pi._M_weak_count</span><br><span class="line">$<span class="number">16</span> = (_Atomic_word *) <span class="number">0x60401c</span></span><br><span class="line">(gdb) p &amp;p1._M_refcount._M_pi._M_use_count</span><br><span class="line">$<span class="number">17</span> = (_Atomic_word *) <span class="number">0x604018</span></span><br></pre></td></tr></table></figure>

<h2 id="std-shared-ptr-成员构成"><a href="#std-shared-ptr-成员构成" class="headerlink" title="std::shared_ptr 成员构成"></a>std::shared_ptr 成员构成</h2><p><code>std::shared_ptr</code> 本身是空的，成员都继承自 <code>std::__shared_ptr</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) pt /mt p1</span><br><span class="line">type = class <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;<span class="type">int</span>&gt; [with _Tp = <span class="type">int</span>] : public <span class="built_in">std</span>::__shared_ptr&lt;_Tp, (__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>std::__shared_ptr</code> 里面是：</p>
<ul>
<li>指向实际对象的 <code>_M_ptr</code></li>
<li>引用计数 <code>_M_refcount</code>, 这个包了一个指向两个引用计数int的指针。</li>
</ul>
<p>注意:</p>
<ul>
<li>pt能直接打印实例化的类型，注意替换 <code>_Tp</code> 为 <code>int</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) pt /mt <span class="built_in">std</span>::__shared_ptr&lt;<span class="type">int</span>, (__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt;</span><br><span class="line">type = class <span class="built_in">std</span>::__shared_ptr&lt;<span class="type">int</span>, (__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; [with _Tp = <span class="type">int</span>] : public <span class="built_in">std</span>::__shared_ptr_access&lt;_Tp, (__gnu_cxx::_Lock_policy)<span class="number">2</span>, <span class="literal">false</span>, <span class="literal">false</span>&gt; &#123;</span><br><span class="line">  private:</span><br><span class="line">    _Tp *_M_ptr;</span><br><span class="line">    <span class="built_in">std</span>::__shared_count&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; _M_refcount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_M_ptr</code> 就是指向实际对象的指针。这里实例化为 int*</p>
<p><code>_M_refcount</code> 里是 <code>_M_pi</code>指针</p>
<ul>
<li>pi could stand for “pointer to implementation”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) pt /mt <span class="built_in">std</span>::__shared_count&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt;</span><br><span class="line">type = class <span class="built_in">std</span>::__shared_count&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; &#123;</span><br><span class="line">  private:</span><br><span class="line">    <span class="built_in">std</span>::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; *_M_pi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>_M_pi</code>指向两个<code>int</code>的结构体, 这是引用计数变量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) pt /mt <span class="built_in">std</span>::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt;</span><br><span class="line">type = class <span class="built_in">std</span>::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; : public <span class="built_in">std</span>::_Mutex_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; &#123;</span><br><span class="line">  private:</span><br><span class="line">    _Atomic_word _M_use_count;</span><br><span class="line">    _Atomic_word _M_weak_count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(gdb) pt _Atomic_word</span><br><span class="line">type = <span class="type">int</span></span><br></pre></td></tr></table></figure>

<h2 id="引用计数机制"><a href="#引用计数机制" class="headerlink" title="引用计数机制"></a>引用计数机制</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::shared_ptr&lt;<span class="type">int</span>&gt; p1 = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>);</span><br><span class="line">    std::shared_ptr&lt;<span class="type">int</span>&gt; p2 = p1;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>std::shared_ptr&lt;int&gt; p2 = p1;</code>，底层调用 <code>std::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)2&gt;::_M_add_ref_copy</code> 增加引用计数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  __gnu_cxx::__atomic_add_dispatch (__mem=<span class="number">0x55555556aeb8</span>, __val=<span class="number">1</span>) at /usr/include/c++/<span class="number">9</span>/ext/atomicity.h:<span class="number">98</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x000055555555520d</span> in std::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt;::_M_add_ref_copy (<span class="keyword">this</span>=<span class="number">0x55555556aeb0</span>) at /usr/include/c++/<span class="number">9</span>/bits/shared_ptr_base.h:<span class="number">139</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0x00005555555550d3</span> in std::__shared_count&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt;::__shared_count (<span class="keyword">this</span>=<span class="number">0x7fffffffe278</span>, __r=...) at /usr/include/c++/<span class="number">9</span>/bits/shared_ptr_base.h:<span class="number">737</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0x0000555555554f9b</span> in std::__shared_ptr&lt;<span class="type">int</span>, (__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt;::__shared_ptr (<span class="keyword">this</span>=<span class="number">0x7fffffffe270</span>) at /usr/include/c++/<span class="number">9</span>/bits/shared_ptr_base.h:<span class="number">1167</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0x0000555555554fc5</span> in std::shared_ptr&lt;<span class="type">int</span>&gt;::<span class="built_in">shared_ptr</span> (<span class="keyword">this</span>=<span class="number">0x7fffffffe270</span>) at /usr/include/c++/<span class="number">9</span>/bits/shared_ptr.h:<span class="number">129</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0x0000555555554d50</span> <span class="function">in <span class="title">main</span> <span class="params">()</span> at shared_ptr.cpp:<span class="number">6</span></span></span><br></pre></td></tr></table></figure>

<p>多个 <code>shared_ptr</code> 共享 <code>_M_pi</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p p1._M_refcount._M_pi</span><br><span class="line">$<span class="number">11</span> = (<span class="built_in">std</span>::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; *) <span class="number">0x55555556aeb0</span></span><br><span class="line">(gdb) p p2._M_refcount._M_pi</span><br><span class="line">$<span class="number">12</span> = (<span class="built_in">std</span>::_Sp_counted_base&lt;(__gnu_cxx::_Lock_policy)<span class="number">2</span>&gt; *) <span class="number">0x55555556aeb0</span></span><br></pre></td></tr></table></figure>

<h2 id="实现简易版-shared-ptr"><a href="#实现简易版-shared-ptr" class="headerlink" title="实现简易版 shared_ptr"></a>实现简易版 shared_ptr</h2><h1 id="unique-ptr"><a href="#unique-ptr" class="headerlink" title="unique_ptr"></a>unique_ptr</h1><p>unique_ptr的拷贝构造函数和拷贝赋值运算符函数都是delete。</p>
<p>用std::tuple保存指针和deleter，tuple可以通过空基类优化做到在使用默认的deleter时，只占用一个指针的大小。</p>
<h2 id="实现unique-ptr"><a href="#实现unique-ptr" class="headerlink" title="实现unique_ptr"></a>实现unique_ptr</h2>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/06/note/cpp/GDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/06/note/cpp/GDB/" class="post-title-link" itemprop="url">GDB指令备忘</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-06 20:05:32" itemprop="dateCreated datePublished" datetime="2024-03-06T20:05:32+08:00">2024-03-06</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb.pdf">GDB使用手册</a></p>
<h1 id="GDB配置"><a href="#GDB配置" class="headerlink" title="GDB配置"></a>GDB配置</h1><p>关闭输出过长提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set pagination off</span><br></pre></td></tr></table></figure>

<h2 id="watchpoint"><a href="#watchpoint" class="headerlink" title="watchpoint"></a>watchpoint</h2><p>watchpoint又叫数据断点（data breakpoint），用于监控内存的读写。</p>
<h3 id="监控内存地址"><a href="#监控内存地址" class="headerlink" title="监控内存地址"></a>监控内存地址</h3><p>如果要监控 <code>0x402000</code> 上的读写。</p>
<p>如下不行，因为 <code>0x402000</code> 被当作常量，永不变化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) watch 0x402000</span><br><span class="line">Cannot watch constant value `0x402000&#x27;.</span><br></pre></td></tr></table></figure>

<p>而要用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) watch *0x402000</span><br><span class="line">Hardware watchpoint 5: *0x402000</span><br></pre></td></tr></table></figure>

<p>如果要按hex打印变更前后数值，用如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">watch *(char**)0x402000</span><br><span class="line">watch *(void**)0x402000</span><br></pre></td></tr></table></figure>

<h2 id="Demangle-symbol"><a href="#Demangle-symbol" class="headerlink" title="Demangle symbol"></a>Demangle symbol</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) dem _ZTV1C</span><br><span class="line">vtable for C</span><br></pre></td></tr></table></figure>

<p>ref: <a target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/Debugging-C-Plus-Plus.html">https://sourceware.org/gdb/current/onlinedocs/gdb.html/Debugging-C-Plus-Plus.html</a></p>
<h2 id="打印对象的虚函数表"><a href="#打印对象的虚函数表" class="headerlink" title="打印对象的虚函数表"></a>打印对象的虚函数表</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl c</span><br></pre></td></tr></table></figure>

<h2 id="打印对象内部成员布局"><a href="#打印对象内部成员布局" class="headerlink" title="打印对象内部成员布局"></a>打印对象内部成员布局</h2><p>测试代码:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> a;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    <span class="type">double</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   Foo foo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构体成员内存布局如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) pt /o foo</span><br><span class="line"><span class="comment">/* offset    |  size */</span>  type = <span class="keyword">struct</span> Foo &#123;</span><br><span class="line"><span class="comment">/*    0      |     1 */</span>    <span class="type">char</span> a;</span><br><span class="line"><span class="comment">/* XXX  3-byte hole */</span></span><br><span class="line"><span class="comment">/*    4      |     4 */</span>    <span class="type">int</span> b;</span><br><span class="line"><span class="comment">/*    8      |     8 */</span>    <span class="type">double</span> c;</span><br><span class="line"><span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="搜索符号定义的位置"><a href="#搜索符号定义的位置" class="headerlink" title="搜索符号定义的位置"></a>搜索符号定义的位置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info types regex</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info types _Atomic_word</span><br><span class="line">All types matching regular expression &quot;_Atomic_word&quot;:</span><br><span class="line"></span><br><span class="line">File /opt/rh/devtoolset-8/root/usr/include/c++/8/x86_64-redhat-linux/bits/atomic_word.h:</span><br><span class="line">32:     typedef int _Atomic_word;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>^匹配符号开始，$匹配符号结束</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info types ^__gnu_cxx::_Lock_policy$</span><br><span class="line">All types matching regular expression &quot;^__gnu_cxx::_Lock_policy$&quot;:</span><br><span class="line"></span><br><span class="line">File /opt/rh/devtoolset-8/root/usr/include/c++/8/ext/concurrence.h:</span><br><span class="line">49:     __gnu_cxx::_Lock_policy;</span><br></pre></td></tr></table></figure>

<h2 id="由地址确定符号"><a href="#由地址确定符号" class="headerlink" title="由地址确定符号"></a>由地址确定符号</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x p</span><br><span class="line"><span class="number">0x555555568eb0</span>: <span class="number">0x55555d38</span></span><br><span class="line"></span><br><span class="line">(gdb) info symbol <span class="number">0x555555555d38</span> <span class="comment">// 每次的程序入口地址不一，视情况注意高位补全，本例需要高位补齐4个5才能正确解析地址</span></span><br><span class="line">vtable <span class="keyword">for</span> Derived + <span class="number">16</span> in section .data.rel.ro.local of /home/redis/demo/a.out</span><br></pre></td></tr></table></figure>

<h2 id="由符号确定地址"><a href="#由符号确定地址" class="headerlink" title="由符号确定地址"></a>由符号确定地址</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info address <span class="title function_">Derived::foo</span><span class="params">()</span></span><br><span class="line">Symbol &quot;<span class="title function_">Derived::foo</span><span class="params">()</span>&quot; is a function at address 0x5555555548dc.</span><br></pre></td></tr></table></figure>

<h2 id="符号偏移量断点"><a href="#符号偏移量断点" class="headerlink" title="符号偏移量断点"></a>符号偏移量断点</h2><p>注意加 <code>*</code> 符号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b main+<span class="number">41</span></span><br><span class="line">Function <span class="string">&quot;main+41&quot;</span> not defined.</span><br><span class="line">Make breakpoint pending on <span class="built_in">future</span> shared library load? (y or [n]) n</span><br><span class="line"></span><br><span class="line">(gdb) b *main+<span class="number">41</span></span><br><span class="line">Breakpoint <span class="number">2</span> at <span class="number">0x555555554882</span>: file demo.cpp, line <span class="number">15.</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/04/note/redis/redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/04/note/redis/redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">Redis数据结构的底层实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-04 20:22:17" itemprop="dateCreated datePublished" datetime="2024-03-04T20:22:17+08:00">2024-03-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-05 12:01:24" itemprop="dateModified" datetime="2024-03-05T12:01:24+08:00">2024-03-05</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文基于 Redis 7.0.0 源码。 </p>
</blockquote>
<h1 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h1><p>Redis根据zset中元素的大小和数量，采用不同的存储方式，有如下两种：</p>
<ul>
<li><code>listpack</code> - 适用于小数据量情况，更省内存，增删改查 <code>O(n)</code>，以时间换空间</li>
<li><code>skiplist + dict</code> - 适用于zset中某个元素较大或元素较多的情况，同时采用跳表和哈希表，充分利用了跳表 <code>O(log)</code> 范围查询(如ZRANGEBYSCORE操作)，和哈希表 <code>O(1)</code> 单点查询(如ZSCORE操作)的特征。</li>
</ul>
<p>zset新增元素时，判断是否需要由 <code>listpack</code> 转为 <code>skiplist</code> 存储：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">zsetAdd</span><span class="params">(robj *zobj, <span class="type">double</span> score, sds ele, <span class="type">int</span> in_flags, <span class="type">int</span> *out_flags, <span class="type">double</span> *newscore)</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">/* check if the element is too large or the list</span></span><br><span class="line"><span class="comment">	 * becomes too long *before* executing zzlInsert. */</span></span><br><span class="line">	<span class="keyword">if</span> (zzlLength(zobj-&gt;ptr)+<span class="number">1</span> &gt; server.zset_max_listpack_entries ||</span><br><span class="line">		sdslen(ele) &gt; server.zset_max_listpack_value ||</span><br><span class="line">		!lpSafeToAdd(zobj-&gt;ptr, sdslen(ele)))</span><br><span class="line">	&#123;</span><br><span class="line">		zsetConvert(zobj,OBJ_ENCODING_SKIPLIST); <span class="comment">// 转换为skiplist</span></span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>元素数量和大小转换阈值可通过 <code>redis.conf</code> 配置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># redis.conf</span></span><br><span class="line"># Similarly to hashes and lists, sorted sets are also specially encoded in</span><br><span class="line"><span class="meta"># order to save a lot of space. This encoding is only used when the length and</span></span><br><span class="line"><span class="meta"># elements of a sorted set are below the following limits:</span></span><br><span class="line">zset-max-listpack-entries <span class="number">128</span></span><br><span class="line">zset-max-listpack-value <span class="number">64</span></span><br></pre></td></tr></table></figure>

<p>也可运行时动态调整</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CONFIG GET zset-max-*</span><br><span class="line">1) <span class="string">&quot;zset-max-listpack-entries&quot;</span></span><br><span class="line">2) <span class="string">&quot;128&quot;</span></span><br><span class="line">3) <span class="string">&quot;zset-max-listpack-value&quot;</span></span><br><span class="line">4) <span class="string">&quot;64&quot;</span></span><br><span class="line">5) <span class="string">&quot;zset-max-ziplist-value&quot;</span></span><br><span class="line">6) <span class="string">&quot;64&quot;</span></span><br><span class="line">7) <span class="string">&quot;zset-max-ziplist-entries&quot;</span></span><br><span class="line">8) <span class="string">&quot;128&quot;</span></span><br><span class="line"></span><br><span class="line">// 运行时修改</span><br><span class="line">&gt; CONFIG SET zset-max-ziplist-entries 100</span><br></pre></td></tr></table></figure>

<p>新建 <code>zset</code> 时根据 <code>zset-max-listpack-entries</code> 与 <code>zset-max-listpack-value</code> 选择使用 <code>skiplist</code> 或者 <code>listpack</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (server.zset_max_listpack_entries == <span class="number">0</span> ||</span><br><span class="line">	server.zset_max_listpack_value &lt; sdslen(c-&gt;argv[scoreidx+<span class="number">1</span>]-&gt;ptr))</span><br><span class="line">&#123;</span><br><span class="line">	zobj = createZsetObject();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	zobj = createZsetListpackObject();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  createZsetObject () at object.c:<span class="number">259</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00005555556245d8</span> in <span class="title function_">zaddGenericCommand</span> <span class="params">(c=<span class="number">0x7ffff791e600</span>, flags=<span class="number">0</span>)</span> at t_zset.c:1749</span><br><span class="line">#2  0x0000555555624843 in <span class="title function_">zaddCommand</span> <span class="params">(c=<span class="number">0x7ffff791e600</span>)</span> at t_zset.c:1794</span><br><span class="line">#3  0x00005555555d157c in <span class="title function_">call</span> <span class="params">(c=<span class="number">0x7ffff791e600</span>, flags=<span class="number">15</span>)</span> at server.c:3265</span><br><span class="line">#4  0x00005555555d3070 in <span class="title function_">processCommand</span> <span class="params">(c=<span class="number">0x7ffff791e600</span>)</span> at server.c:3906</span><br><span class="line">#5  0x00005555555ee885 in <span class="title function_">processCommandAndResetClient</span> <span class="params">(c=<span class="number">0x7ffff791e600</span>)</span> at networking.c:2438</span><br><span class="line">#6  0x00005555555eeb08 in <span class="title function_">processInputBuffer</span> <span class="params">(c=<span class="number">0x7ffff791e600</span>)</span> at networking.c:2542</span><br><span class="line">#7  0x00005555555ef054 in <span class="title function_">readQueryFromClient</span> <span class="params">(conn=<span class="number">0x7ffff7829580</span>)</span> at networking.c:2673</span><br><span class="line">#8  0x00005555556c634c in <span class="title function_">callHandler</span> <span class="params">(conn=<span class="number">0x7ffff7829580</span>, handler=<span class="number">0x5555555eec1f</span> &lt;readQueryFromClient&gt;)</span> at connhelpers.h:79</span><br><span class="line">#9  0x00005555556c6aa6 in <span class="title function_">connSocketEventHandler</span> <span class="params">(el=<span class="number">0x7ffff782a140</span>, fd=<span class="number">8</span>, clientData=<span class="number">0x7ffff7829580</span>, mask=<span class="number">1</span>)</span> at connection.c:310</span><br><span class="line">#10 0x00005555555c5063 in <span class="title function_">aeProcessEvents</span> <span class="params">(eventLoop=<span class="number">0x7ffff782a140</span>, flags=<span class="number">27</span>)</span> at ae.c:436</span><br><span class="line">#11 0x00005555555c52a1 in <span class="title function_">aeMain</span> <span class="params">(eventLoop=<span class="number">0x7ffff782a140</span>)</span> at ae.c:496</span><br><span class="line">#12 0x00005555555dba20 in <span class="title function_">main</span> <span class="params">(argc=<span class="number">1</span>, argv=<span class="number">0x7fffffffe3c8</span>)</span> at server.c:7085</span><br></pre></td></tr></table></figure>

<p>做个实验：将 <code>zset-max-listpack-value</code> 设置为0，在 <code>redis-server</code> 的 <code>zsetAdd</code> 下断点</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; CONFIG SET zset-max-listpack-value <span class="number">0</span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>新建一个zset</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; zadd s <span class="number">1</span> name</span><br></pre></td></tr></table></figure>

<p>该zset的 <code>encoding = 7</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info args</span><br><span class="line">zobj = <span class="number">0x7ffff1dfdbd0</span></span><br><span class="line">score = <span class="number">1</span></span><br><span class="line">ele = <span class="number">0x7ffff1ddba43</span> <span class="string">&quot;name&quot;</span></span><br><span class="line">in_flags = <span class="number">0</span></span><br><span class="line">out_flags = <span class="number">0x7ffffffed17c</span></span><br><span class="line">newscore = <span class="number">0x7ffffffed180</span></span><br><span class="line">(gdb) p zobj-&gt;encoding</span><br><span class="line">$<span class="number">3</span> = <span class="number">7</span></span><br></pre></td></tr></table></figure>

<p>对应于 <code>skiplist</code> 的编码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objects encoding. Some kind of objects like Strings and Hashes can be</span></span><br><span class="line"><span class="comment"> * internally represented in multiple ways. The &#x27;encoding&#x27; field of the object</span></span><br><span class="line"><span class="comment"> * is set to one of this fields for this object. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_ENCODING_SKIPLIST 7  <span class="comment">/* Encoded as skiplist */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_ENCODING_LISTPACK 11 <span class="comment">/* Encoded as a listpack */</span></span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/02/note/redis/Redis%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/03/02/note/redis/Redis%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">Redis源码结构概览</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-03-02 16:04:02" itemprop="dateCreated datePublished" datetime="2024-03-02T16:04:02+08:00">2024-03-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-05 11:46:20" itemprop="dateModified" datetime="2024-03-05T11:46:20+08:00">2024-03-05</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>基于 Redis 7.0.0</p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><p>从目录结构可以了解一个系统的主要组成部分。</p>
<h2 id="deps"><a href="#deps" class="headerlink" title="deps"></a>deps</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">deps/</span><br><span class="line">├── fpconv</span><br><span class="line">├── hdr_histogram</span><br><span class="line">├── hiredis   // Redis C 客户端</span><br><span class="line">├── jemalloc  // Redis使用了jemalloc库替换了glibc库的内存分配器</span><br><span class="line">├── linenoise // 类似readline</span><br><span class="line">└── lua       // lua源码</span><br></pre></td></tr></table></figure>

<h2 id="src"><a href="#src" class="headerlink" title="src"></a>src</h2><p>Redis的源码文件都是在src目录下，没有再分下一级子目录。<br>Redis的功能模块实现是典型的C语言风格，不同功能模块之间不再设置目录分隔，而是通过头文件包含来相互调用。<br>好处是：这样模块相互间的相互引用很方便。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">      ---&gt; modules 实例代码</span><br><span class="line">src --|</span><br><span class="line">      ---&gt; 各功能模块源码</span><br></pre></td></tr></table></figure>

<h2 id="tests"><a href="#tests" class="headerlink" title="tests"></a>tests</h2><p>测试用例用 <code>TCL</code> 编写。<code>assets</code>、<code>helpers</code>、<code>modules</code> 和 <code>support</code> 用来支持测试功能。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tests/</span><br><span class="line">├── assets</span><br><span class="line">├── cluster      // 集群测试</span><br><span class="line">├── helpers</span><br><span class="line">├── integration  // 主从复制测试</span><br><span class="line">├── modules</span><br><span class="line">├── sentinel     // 哨兵功能测试</span><br><span class="line">├── support</span><br><span class="line">├── tmp</span><br><span class="line">└── unit         // 单元测试</span><br><span class="line"></span><br><span class="line">9 directories</span><br></pre></td></tr></table></figure>

<h2 id="utils"><a href="#utils" class="headerlink" title="utils"></a>utils</h2><p>辅助工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">utils/</span><br><span class="line">├── create-cluster</span><br><span class="line">├── graphs</span><br><span class="line">├── hyperloglog</span><br><span class="line">├── lru</span><br><span class="line">├── releasetools</span><br><span class="line">└── srandmember</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="redis-conf"><a href="#redis-conf" class="headerlink" title="redis.conf"></a>redis.conf</h2><p>单个Redis实例的配置</p>
<h2 id="sentinel-conf"><a href="#sentinel-conf" class="headerlink" title="sentinel.conf"></a>sentinel.conf</h2><p>哨兵的配置</p>
<h1 id="功能模块与源码对应关系"><a href="#功能模块与源码对应关系" class="headerlink" title="功能模块与源码对应关系"></a>功能模块与源码对应关系</h1><h2 id="服务器实例"><a href="#服务器实例" class="headerlink" title="服务器实例"></a>服务器实例</h2><p>Redis-server的 <code>main()</code> 在 <code>server.h/c</code></p>
<p>网络通信</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ae.h/c,</span><br><span class="line">ae_epoll.c,</span><br><span class="line">ae_evport.c,</span><br><span class="line">ae_kqueue.c,</span><br><span class="line">ae_select.c</span><br><span class="line">anet.h/c     // tcp socket</span><br><span class="line">networking.c // redis client</span><br></pre></td></tr></table></figure>

<h2 id="数据类型与操作"><a href="#数据类型与操作" class="headerlink" title="数据类型与操作"></a>数据类型与操作</h2><p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240302162406.png"></p>
<p>数据库操作 <code>db.c</code><br>内存分配器 <code>zmalloc.h/c</code><br>key过期处理 <code>expire.c</code><br>为避免大量key同时过期，异步删除 <code>lazyfree.c</code><br>内存满了，key的lru淘汰 <code>evict.c</code></p>
<h2 id="高可靠与高可扩展"><a href="#高可靠与高可扩展" class="headerlink" title="高可靠与高可扩展"></a>高可靠与高可扩展</h2><p>高可靠：</p>
<ul>
<li>持久化 <code>rdb.h/c</code>, <code>aof.c</code></li>
<li>校验RDB和AOF文件 <code>redis-check-rdb.c</code> 和 <code>redis-check-aof.c</code></li>
<li>主从复制 <code>replication.c</code></li>
<li>主从集群在进行恢复时，主要是依赖于哨兵机制 <code>sentinel.c</code></li>
</ul>
<p>高可扩展通过集群实现 <code>cluster.h/c</code></p>
<h2 id="辅助工具"><a href="#辅助工具" class="headerlink" title="辅助工具"></a>辅助工具</h2><p>操作延迟监控 <code>latency.h/c</code><br>慢命令监控 <code>slowlog.h/c</code><br>性能测试 <code>redis-benchmark.c</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">折纸飞向麦田</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
