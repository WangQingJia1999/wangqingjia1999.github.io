<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="折纸飞向麦田的博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="折纸飞向麦田的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="折纸飞向麦田">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>折纸飞向麦田的博客</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?81afe862f494d24a95a49966a87c3b00"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">折纸飞向麦田的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">折纸飞向麦田</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">61</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/26/note/linux/Linux%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/26/note/linux/Linux%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">Linux内核模块</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-26 10:36:17" itemprop="dateCreated datePublished" datetime="2024-02-26T10:36:17+08:00">2024-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-02-28 20:17:05" itemprop="dateModified" datetime="2024-02-28T20:17:05+08:00">2024-02-28</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>954</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h1><p>CentOS7 Install Kernel Headers and Development Packages:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install kernel-devel kernel-headers</span><br></pre></td></tr></table></figure>

<p>一个简单的内核模块，挂载与卸载时分别打印一条日志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// demo.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span>       <span class="comment">// Needed by all modules</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span>       <span class="comment">// Needed for KERN_INFO</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">init_module</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Minimal module loaded.\n&quot;</span>);</span><br><span class="line">    <span class="comment">// A non 0 return means init_module failed; module can&#x27;t be loaded.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cleanup_module</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Minimal module unloaded.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;A minimal Linux driver&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;0.1&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>Makefile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">obj-m += demo.o</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	make -C /lib/modules/$(shell uname -r)/build M=$(PWD) clean</span><br></pre></td></tr></table></figure>

<p>编译与挂载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> attach.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">insmod demo.ko</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Module Status:&quot;</span></span><br></pre></td></tr></table></figure>

<p>卸载</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> detach.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">rmmod demo</span><br><span class="line">dmesg | <span class="built_in">tail</span></span><br></pre></td></tr></table></figure>

<h1 id="内核模块应用"><a href="#内核模块应用" class="headerlink" title="内核模块应用"></a>内核模块应用</h1><a href="/2024/02/23/note/linux/Kprobe/" title="Linux Kprobe">内核模块搭配Kprobe案例</a>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/26/note/linux/interrupt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/26/note/linux/interrupt/" class="post-title-link" itemprop="url">Linux 中断</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-26 10:36:17" itemprop="dateCreated datePublished" datetime="2024-02-26T10:36:17+08:00">2024-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-02-27 11:12:55" itemprop="dateModified" datetime="2024-02-27T11:12:55+08:00">2024-02-27</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>132</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>每个中断都通过一个唯一的<code>数字标志</code>区分，称为<code>中断请求(IRQ)线</code>(IRQ line，或叫中断号)</p>
<p>在响应一个特定中断的时候，内核会执行一个函数，称为<code>中断处理程序</code>(interrupt handler)或<code>中断服务例程</code>(interrupt service routine，ISR)。</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240223180221.png" alt="image.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/26/note/cpp/GDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/26/note/cpp/GDB/" class="post-title-link" itemprop="url">GDB指令备忘</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-26 10:36:17" itemprop="dateCreated datePublished" datetime="2024-02-26T10:36:17+08:00">2024-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-02-28 20:47:22" itemprop="dateModified" datetime="2024-02-28T20:47:22+08:00">2024-02-28</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb.pdf">GDB使用手册</a></p>
<h1 id="GDB配置"><a href="#GDB配置" class="headerlink" title="GDB配置"></a>GDB配置</h1><p>关闭输出过长提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set pagination off</span><br></pre></td></tr></table></figure>

<h2 id="watchpoint"><a href="#watchpoint" class="headerlink" title="watchpoint"></a>watchpoint</h2><p>watchpoint又叫数据断点（data breakpoint），用于监控内存的读写。</p>
<h3 id="监控内存地址"><a href="#监控内存地址" class="headerlink" title="监控内存地址"></a>监控内存地址</h3><p>如果要监控 <code>0x402000</code> 上的读写。</p>
<p>如下不行，因为 <code>0x402000</code> 被当作常量，永不变化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) watch 0x402000</span><br><span class="line">Cannot watch constant value `0x402000&#x27;.</span><br></pre></td></tr></table></figure>

<p>而要用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) watch *0x402000</span><br><span class="line">Hardware watchpoint 5: *0x402000</span><br></pre></td></tr></table></figure>

<p>如果要按hex打印变更前后数值，用如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">watch *(char**)0x402000</span><br><span class="line">watch *(void**)0x402000</span><br></pre></td></tr></table></figure>

<h2 id="Demangle-symbol"><a href="#Demangle-symbol" class="headerlink" title="Demangle symbol"></a>Demangle symbol</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) dem _ZTV1C</span><br><span class="line">vtable for C</span><br></pre></td></tr></table></figure>

<p>ref: <a target="_blank" rel="noopener" href="https://sourceware.org/gdb/current/onlinedocs/gdb.html/Debugging-C-Plus-Plus.html">https://sourceware.org/gdb/current/onlinedocs/gdb.html/Debugging-C-Plus-Plus.html</a></p>
<h2 id="打印对象的虚函数表"><a href="#打印对象的虚函数表" class="headerlink" title="打印对象的虚函数表"></a>打印对象的虚函数表</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info vtbl c</span><br></pre></td></tr></table></figure>

<h2 id="打印对象内部成员布局"><a href="#打印对象内部成员布局" class="headerlink" title="打印对象内部成员布局"></a>打印对象内部成员布局</h2><p>测试代码:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> a;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    <span class="type">double</span> c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   Foo foo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构体成员内存布局如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) pt /o foo</span><br><span class="line"><span class="comment">/* offset    |  size */</span>  type = <span class="keyword">struct</span> Foo &#123;</span><br><span class="line"><span class="comment">/*    0      |     1 */</span>    <span class="type">char</span> a;</span><br><span class="line"><span class="comment">/* XXX  3-byte hole */</span></span><br><span class="line"><span class="comment">/*    4      |     4 */</span>    <span class="type">int</span> b;</span><br><span class="line"><span class="comment">/*    8      |     8 */</span>    <span class="type">double</span> c;</span><br><span class="line"><span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="搜索符号定义的位置"><a href="#搜索符号定义的位置" class="headerlink" title="搜索符号定义的位置"></a>搜索符号定义的位置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info types regex</span><br></pre></td></tr></table></figure>

<p>例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info types _Atomic_word</span><br><span class="line">All types matching regular expression &quot;_Atomic_word&quot;:</span><br><span class="line"></span><br><span class="line">File /opt/rh/devtoolset-8/root/usr/include/c++/8/x86_64-redhat-linux/bits/atomic_word.h:</span><br><span class="line">32:     typedef int _Atomic_word;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>^匹配符号开始，$匹配符号结束</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info types ^__gnu_cxx::_Lock_policy$</span><br><span class="line">All types matching regular expression &quot;^__gnu_cxx::_Lock_policy$&quot;:</span><br><span class="line"></span><br><span class="line">File /opt/rh/devtoolset-8/root/usr/include/c++/8/ext/concurrence.h:</span><br><span class="line">49:     __gnu_cxx::_Lock_policy;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/23/note/linux/Kprobe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/23/note/linux/Kprobe/" class="post-title-link" itemprop="url">Linux Kprobe</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-23 15:23:21" itemprop="dateCreated datePublished" datetime="2024-02-23T15:23:21+08:00">2024-02-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-02-28 20:30:27" itemprop="dateModified" datetime="2024-02-28T20:30:27+08:00">2024-02-28</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>7 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/kprobes.txt">kprobe official doc</a></p>
<h1 id="Kprobe功能简介"><a href="#Kprobe功能简介" class="headerlink" title="Kprobe功能简介"></a>Kprobe功能简介</h1><p>Kprobe allows you to hook into almost any kernel function (that is not inlined or marked as notrace) and execute your custom handler before or after it runs, without needing to modify the kernel source code or recompile the kernel.</p>
<p>粗看Kprobe的原理类似C++游戏服务器的热更，即在程序运行时，修改代码段中部分指令，替换为跳转指令，程序控制权转交Kprobe。（有空深入学习下具体原理）</p>
<p>官方文档中特别声明：</p>
<blockquote>
<p>handler内可直接修改内核数据结构，且通过修改 <code>pt_regs</code> 可直接操纵断点处的寄存器组，包括PC，如果要修改，pre_handler一定要返回 !0，确保不继续执行被拦截的函数，这同时也这意味着 post_hanlder 不再执行，注意：修改寄存器的值是高危操作，因为要特别小心的维护栈中内容。</p>
</blockquote>
<h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><h2 id="给-do-sys-open-加个-pre-handler"><a href="#给-do-sys-open-加个-pre-handler" class="headerlink" title="给 do_sys_open 加个 pre_handler"></a>给 do_sys_open 加个 pre_handler</h2><p>用 kprobe 来拦截<code>do_sys_open</code>函数，让内核在调用<code>do_sys_open</code>之前，先调用自定义的<code>my_custom_function</code> ，打印个日志</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kprobes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Hook do_sys_open&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;0.1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_custom_function</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;my_custom_function: do_sys_open is about to be called\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pre-handler: called just before the probed instruction is executed */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">handler_pre</span><span class="params">(<span class="keyword">struct</span> kprobe *p, <span class="keyword">struct</span> pt_regs *regs)</span> &#123;</span><br><span class="line">    my_custom_function(); <span class="comment">// Call your custom function here</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// Return 0 to indicate that the original probed instruction should execute</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kprobe</span> <span class="title">kp</span> =</span> &#123;</span><br><span class="line">    .symbol_name    = <span class="string">&quot;do_sys_open&quot;</span>,</span><br><span class="line">    .pre_handler    = handler_pre,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">kprobe_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    ret = register_kprobe(&amp;kp);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;register_kprobe failed, returned %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Planted kprobe at %p\n&quot;</span>, kp.addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">kprobe_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    unregister_kprobe(&amp;kp);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;kprobe at %p unregistered\n&quot;</span>, kp.addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(kprobe_init);</span><br><span class="line">module_exit(kprobe_exit);</span><br></pre></td></tr></table></figure>

<p>查看打印信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost km]<span class="comment"># dmesg | tail</span></span><br><span class="line">[ 2231.238259] my_custom_function: do_sys_open is about to be called</span><br><span class="line">[ 2231.238270] my_custom_function: do_sys_open is about to be called</span><br><span class="line">[ 2231.238271] my_custom_function: do_sys_open is about to be called</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -k -f</span><br></pre></td></tr></table></figure>

<h2 id="打印-load-elf-binary-的入参"><a href="#打印-load-elf-binary-的入参" class="headerlink" title="打印 load_elf_binary 的入参"></a>打印 load_elf_binary 的入参</h2><p>该内核函数的接口为，根据 Linux x86-64 ABI，入参 <code>bprm</code> 由 <code>%rdx</code> 寄存器传入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">load_elf_binary</span><span class="params">(<span class="keyword">struct</span> linux_binprm *bprm)</span></span><br></pre></td></tr></table></figure>


<p>用Kprobe给内核函数 <code>load_elf_binary</code> 绑定个pre_handler，获取此刻 <code>%rdx</code> 寄存器中存的 <code>bprm</code> 指针的值，并转换为对应类型，进而打印其成员</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kprobes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/binfmts.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Your Name&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Hook do_sys_open&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;0.1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pre-handler: called just before the probed instruction is executed */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">handler_pre</span><span class="params">(<span class="keyword">struct</span> kprobe *p, <span class="keyword">struct</span> pt_regs *regs)</span> &#123;</span><br><span class="line">	<span class="comment">// For x86_64, first argument is passed in %rdi register.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">linux_binprm</span>* <span class="title">bprm</span> =</span> (<span class="keyword">struct</span> linux_binprm*)regs-&gt;di;</span><br><span class="line"></span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Filename: %s\n&quot;</span>, bprm-&gt;filename);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Full path: %s\n&quot;</span>, bprm-&gt;interp);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Argument count: %d\n&quot;</span>, bprm-&gt;argc);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Environment variable count: %d\n&quot;</span>, bprm-&gt;envc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// Return 0 to indicate that the original probed instruction should execute</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kprobe</span> <span class="title">kp</span> =</span> &#123;</span><br><span class="line">    .symbol_name    = <span class="string">&quot;load_elf_binary&quot;</span>,</span><br><span class="line">    .pre_handler    = handler_pre,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">kprobe_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    ret = register_kprobe(&amp;kp);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        printk(KERN_INFO <span class="string">&quot;register_kprobe failed, returned %d\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;Planted kprobe at %p\n&quot;</span>, kp.addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">kprobe_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    unregister_kprobe(&amp;kp);</span><br><span class="line">    printk(KERN_INFO <span class="string">&quot;kprobe at %p unregistered\n&quot;</span>, kp.addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(kprobe_init);</span><br><span class="line">module_exit(kprobe_exit);</span><br></pre></td></tr></table></figure>

<p>输出，可以看到文件路径正是最后执行的 <code>dmesg</code> 的绝对路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ dmesg</span><br><span class="line">...</span><br><span class="line">[ 5289.707424] Filename: /usr/bin/dmesg</span><br><span class="line">[ 5289.707426] Full path: /usr/bin/dmesg</span><br><span class="line">[ 5289.707427] Argument count: 1</span><br><span class="line">[ 5289.707428] Environment variable count: 36</span><br></pre></td></tr></table></figure>

<h2 id="拦截中断处理函数"><a href="#拦截中断处理函数" class="headerlink" title="拦截中断处理函数"></a>拦截中断处理函数</h2><p>看Kprobe文档说可以给中断处理函数打断点，这正好帮助理解中断，待试验。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/23/note/linux/gas/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/23/note/linux/gas/" class="post-title-link" itemprop="url">Linux GAS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-23 11:26:49" itemprop="dateCreated datePublished" datetime="2024-02-23T11:26:49+08:00">2024-02-23</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>备忘Linux下 AT&amp;T 汇编语法。</p>
<h1 id="GAS文档"><a href="#GAS文档" class="headerlink" title="GAS文档"></a>GAS文档</h1><p><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/">GAS文档</a></p>
<h1 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world!"></a>hello world!</h1><p>汇编打印 “hello world”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.section .data</span><br><span class="line">    hello_world:</span><br><span class="line">        .string &quot;Hello world!\n&quot;</span><br><span class="line">    hello_world_len = . - hello_world</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">    .globl _start</span><br><span class="line">    _start:</span><br><span class="line">        mov $1, %rax         # syscall number for sys_write</span><br><span class="line">        mov $1, %rdi         # file descriptor 1 (stdout)</span><br><span class="line">        movq $hello_world, %rsi    # pointer to the string</span><br><span class="line">        mov $hello_world_len, %rdx # length of the string</span><br><span class="line">        syscall</span><br><span class="line"></span><br><span class="line">        mov $60, %rax        # syscall number for sys_exit</span><br><span class="line">        xor %rdi, %rdi       # exit code 0</span><br><span class="line">        syscall</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>汇编并链接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as -o demo.o demo.s &amp;&amp; ld -o demo.out demo.o</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./demo.out </span><br><span class="line">Hello world!</span><br></pre></td></tr></table></figure>

<h1 id="符号"><a href="#符号" class="headerlink" title="$ 符号"></a>$ 符号</h1><p>立即数的前缀。</p>
<p>注意如下区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov 1, %rax  # 将内存以0x01起始的8字节复制到%rax</span><br><span class="line">mov $1, %rax # 将立即数1复制到%rax</span><br><span class="line"></span><br><span class="line">mov var, %rax # 将var的值而不是地址复制到%rax</span><br><span class="line">mov $var, %rax # 将var的地址复制到%rax</span><br></pre></td></tr></table></figure>

<h2 id="错误示范"><a href="#错误示范" class="headerlink" title="错误示范"></a>错误示范</h2><p>将字符串起始地址复制到 %rax，没加 $ 符号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// demo.s</span><br><span class="line">.section .data</span><br><span class="line">    hello_world:</span><br><span class="line">        .string &quot;Hello world!\n&quot;</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">    .globl _start</span><br><span class="line">    _start:</span><br><span class="line">        mov hello_world, %rax</span><br><span class="line">        nop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>汇编并链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">as -o demo.o demo.s &amp;&amp; ld -o demo.out demo.o</span><br></pre></td></tr></table></figure>

<p>GDB对可执行文件中的 <code>_start</code> 反汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; disassemble _start</span><br><span class="line">Dump of assembler code for function _start:</span><br><span class="line">   0x00000000004000b0 &lt;+0&gt;:     mov    0x4010b9,%rax</span><br><span class="line">=&gt; 0x00000000004000b8 &lt;+8&gt;:     nop</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>

<p><code>0x4010b9</code> 是字符串起始地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; x/13z 0x4010b9</span><br><span class="line">0x4010b9:       0x48    0x65    0x6c    0x6c    0x6f    0x20    0x77    0x6f</span><br><span class="line">0x4010c1:       0x72    0x6c    0x64    0x21    0x0a</span><br><span class="line">&gt;&gt;&gt; x/13c 0x4010b9</span><br><span class="line">0x4010b9:       72 &#x27;H&#x27;  101 &#x27;e&#x27; 108 &#x27;l&#x27; 108 &#x27;l&#x27; 111 &#x27;o&#x27; 32 &#x27; &#x27;  119 &#x27;w&#x27; 111 &#x27;o&#x27;</span><br><span class="line">0x4010c1:       114 &#x27;r&#x27; 108 &#x27;l&#x27; 100 &#x27;d&#x27; 33 &#x27;!&#x27;  10 &#x27;\n&#x27;</span><br></pre></td></tr></table></figure>

<p>但执行 <code>mov 0x4010b9,%rax</code> 后，<code>%rax</code> 中实际放的是 “Hello wo”，即将符号 <code>hello_world</code> 的值 “hello_world\n” 截断后保留前8个字节，存入 <code>%rax</code>，而不是期望的将 <code>hello_world</code> 符号的地址 <code>0x4010b9</code> 存入 <code>%rax</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p/x $rax</span><br><span class="line">$1 = 0x6f77206f6c6c6548</span><br></pre></td></tr></table></figure>

<p>应加上 <code>$</code>，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.section .data</span><br><span class="line">    hello_world:</span><br><span class="line">        .string &quot;Hello world!\n&quot;</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">    .globl _start</span><br><span class="line">    _start:</span><br><span class="line">        mov $hello_world, %rax # 加上$，取符号的地址</span><br><span class="line">        nop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这次，<code>%rax</code> 中正确存放符号的地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; p/x $rax</span><br><span class="line">$1 = 0x4010b8</span><br></pre></td></tr></table></figure>

<h1 id="操作数的顺序"><a href="#操作数的顺序" class="headerlink" title="操作数的顺序"></a>操作数的顺序</h1><p>从左向右</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movq %rsp, %rbp <span class="comment">// copy %rsp to %rbp</span></span><br></pre></td></tr></table></figure>

<h1 id="其他一些特点"><a href="#其他一些特点" class="headerlink" title="其他一些特点"></a>其他一些特点</h1><ul>
<li>mnemonic suffixes indicate the size of the operands (<code>q</code> for quad, etc.)</li>
<li>registers are prefixed with <code>%</code> and immediate values with <code>$</code></li>
<li>effective addresses are in the form <code>DISP(BASE, INDEX, SCALE)</code> (DISP + BASE + INDEX * SCALE)</li>
<li>Indirect jump&#x2F;call operands indicated with * (as opposed to direct).</li>
</ul>
<h1 id="圆括号"><a href="#圆括号" class="headerlink" title="圆括号"></a>圆括号</h1><p>如下代码中圆括号的含义？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov (%rax), %eax</span><br></pre></td></tr></table></figure>

<p>解释：<br>从 <code>rax</code> 寄存器中保存的内存地址读出4字节，复制到 <code>eax</code> 寄存器。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/41232333/what-is-the-difference-between-mov-rax-eax-and-mov-rax-eax">详见 stackoverflow</a></li>
</ul>
<p>如下代码含义？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov %rcx, %rax</span><br></pre></td></tr></table></figure>

<p>解释：复制 <code>rcx</code> 中8字节到 <code>rax</code> 中</p>
<p>因此，圆括号表示解引用。</p>
<p>如果反过来，则是将 <code>rax</code> 中的8字节，拷贝到 <code>rbx</code> 所指的8字节内存中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov %rax,(%rbx)</span><br></pre></td></tr></table></figure>

<p>等价于c中的（<code>rax</code> 中是 value，<code>rbx</code> 中是 ptr）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*ptr = value;</span><br></pre></td></tr></table></figure>

<h2 id="Symbol-符号"><a href="#Symbol-符号" class="headerlink" title="Symbol 符号"></a>Symbol 符号</h2><blockquote>
<p>Symbols are a central concept: the programmer uses symbols to name things, the linker uses symbols to link, and the debugger uses symbols to debug.</p>
</blockquote>
<h3 id="符号名"><a href="#符号名" class="headerlink" title="符号名"></a>符号名</h3><ul>
<li>区分大小写，foo !&#x3D; Foo</li>
<li>符号名首个字符可以是 字母、英文句号、短下划线或者$</li>
<li>后面跟若干数字、字母、$</li>
</ul>
<h3 id="label"><a href="#label" class="headerlink" title="label"></a>label</h3><p>符号名+’:’</p>
<h2 id="String-字符串"><a href="#String-字符串" class="headerlink" title="String 字符串"></a>String 字符串</h2><h3 id="string"><a href="#string" class="headerlink" title=".string"></a>.string</h3><p>末尾加一个字节，值为0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">s3:</span><br><span class="line">    .string &quot;ccc&quot;</span><br><span class="line">    .ascii &quot;ccc&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ as demo.s &amp;&amp; objdump -sD</span><br><span class="line"></span><br><span class="line">a.out:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Contents of section .data:</span><br><span class="line"> 0000 63636300 636363                      ccc.ccc         </span><br><span class="line"></span><br><span class="line">Disassembly of section .data:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;s3&gt;:</span><br><span class="line">   0:   63 63 63                movslq 0x63(%rbx),%esp</span><br><span class="line">   3:   00 63 63                add    %ah,0x63(%rbx)</span><br><span class="line">   6:   63                      .byte 0x63</span><br></pre></td></tr></table></figure>

<h3 id="ascii"><a href="#ascii" class="headerlink" title=".ascii"></a>.ascii</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">.s1:</span><br><span class="line">    .ascii &quot;aaa&quot;</span><br><span class="line">s2:</span><br><span class="line">    .ascii &quot;bbb&quot;</span><br><span class="line"></span><br><span class="line">.text</span><br><span class="line">s3:</span><br><span class="line">    .ascii &quot;ccc&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ as demo.s &amp;&amp; objdump -s a.out </span><br><span class="line"></span><br><span class="line">a.out:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line">Contents of section .text:</span><br><span class="line"> 0000 636363                               ccc             </span><br><span class="line">Contents of section .data:</span><br><span class="line"> 0000 61616162 6262                        aaabbb          </span><br></pre></td></tr></table></figure>

<h2 id="L"><a href="#L" class="headerlink" title=".L"></a>.L</h2><p>GCC uses the .L for local labels.</p>
<h2 id="LFB-LFE-LBB-LBE"><a href="#LFB-LFE-LBB-LBE" class="headerlink" title=".LFB, .LFE, .LBB, .LBE"></a>.LFB, .LFE, .LBB, .LBE</h2><p>They are all defined under <a target="_blank" rel="noopener" href="https://github.com/gcc-mirror/gcc/blob/releases/gcc-4.8.2/gcc/dwarf2out.c">gcc&#x2F;dwarf2out.c</a> on GCC 4.8.2.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> FUNC_BEGIN_LABEL  <span class="string">&quot;LFB&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FUNC_END_LABEL    <span class="string">&quot;LFE&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_BEGIN_LABEL <span class="string">&quot;LBB&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLOCK_END_LABEL   <span class="string">&quot;LBE&quot;</span></span></span><br><span class="line">ASM_GENERATE_INTERNAL_LABEL (loclabel, <span class="string">&quot;LVL&quot;</span>, loclabel_num);</span><br></pre></td></tr></table></figure>

<h1 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">                      +-----+----+--+</span><br><span class="line">partial program # 1:  |ttttt|dddd|00|</span><br><span class="line">                      +-----+----+--+</span><br><span class="line"></span><br><span class="line">                      text   data bss</span><br><span class="line">                      seg.   seg. seg.</span><br><span class="line"></span><br><span class="line">                      +---+---+---+</span><br><span class="line">partial program # 2:  |TTT|DDD|000|</span><br><span class="line">                      +---+---+---+</span><br><span class="line"></span><br><span class="line">                      +--+---+-----+--+----+---+-----+~~</span><br><span class="line">linked program:       |  |TTT|ttttt|  |dddd|DDD|00000|</span><br><span class="line">                      +--+---+-----+--+----+---+-----+~~</span><br><span class="line"></span><br><span class="line">    addresses:        0 …</span><br></pre></td></tr></table></figure>

<p>TODO: section group 是什么？</p>
<h1 id="Directive-指示符"><a href="#Directive-指示符" class="headerlink" title="Directive 指示符"></a>Directive 指示符</h1><p>All assembler directives have names that begin with a period <code>.</code> The rest of the name is letters, usually in lower case.</p>
<blockquote>
<p>用途</p>
</blockquote>
<p>In AT&amp;T assembly syntax, a directive is a command that is used to instruct the assembler on how to process the information in the assembly source code. Unlike instructions, which tell the CPU what to do, directives tell the assembler how to process the information. </p>
<h2 id="byte"><a href="#byte" class="headerlink" title=".byte"></a>.byte</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.byte expr</span><br></pre></td></tr></table></figure>

<h2 id="quad"><a href="#quad" class="headerlink" title=".quad"></a><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/Quad.html">.quad</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.quad expression(s)</span><br></pre></td></tr></table></figure>

<p>A “word” is two bytes; hence <em>quad</em>-word for 8 bytes.</p>
<p>填充8字节</p>
<h2 id="loc"><a href="#loc" class="headerlink" title=".loc"></a><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/Loc.html">.loc</a></h2><p>a debugging directive, and it only appears in GCC if you tell the compiler to generate debugging information with -ggdb or -g.</p>
<h2 id="global"><a href="#global" class="headerlink" title=".global"></a><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/as/Global.html">.global</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.global symbol</span><br><span class="line">.globl symbol</span><br></pre></td></tr></table></figure>

<p><code>.global</code> makes the symbol visible to <code>ld</code>. If you define symbol in your partial program, its value is made available to other partial programs that are linked with it.</p>
<p>Both spellings (‘.globl’ and ‘.global’) are accepted, for compatibility with other assemblers.</p>
<h1 id="movq-movl-movw"><a href="#movq-movl-movw" class="headerlink" title="movq, movl, movw"></a>movq, movl, movw</h1><ol>
<li><strong><code>movw</code></strong>: move a word (16 bits)</li>
<li><strong><code>movl</code></strong>: move a long word (32 bits)</li>
<li><strong><code>movq</code></strong>: move a quadword (64 bits)</li>
</ol>
<h1 id="call"><a href="#call" class="headerlink" title="call"></a>call</h1><p>执行后，将 <code>rip</code> 放入栈顶，然后调新函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.global main</span><br><span class="line"></span><br><span class="line">foo:</span><br><span class="line">    pushq %rax</span><br><span class="line">    movq %rax, %rbp</span><br><span class="line"></span><br><span class="line">main:    </span><br><span class="line">    call foo // 调用foo之前，将rip入栈</span><br><span class="line"></span><br><span class="line">    movq $60, %rax  # syscall: exit</span><br><span class="line">    xorq %rdi, %rdi # status: 0</span><br><span class="line">    syscall</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc call.s -g -o call</span><br></pre></td></tr></table></figure>

<p>用GDB调试<br><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240223064438.png" alt="image.png"></p>
<p>进入foo之后，打印栈顶8字节，正是rip的值。同时发现，rip指向栈顶元素（8个字节中最低位一个字节 0x02，因小端存储）</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240223064352.png" alt="image.png"></p>
<h1 id="Effective-Address"><a href="#Effective-Address" class="headerlink" title="Effective Address"></a>Effective Address</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[base + index*scale + disp]      # Intel, including GAS .<span class="function">intel_syntax noprefix</span></span><br><span class="line"><span class="function"><span class="title">disp</span><span class="params">(base, index, scale)</span>         # AT&amp;T</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240223064329.png" alt="image.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/23/note/linux/xxd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/23/note/linux/xxd/" class="post-title-link" itemprop="url">Linux xxd</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-23 11:26:49" itemprop="dateCreated datePublished" datetime="2024-02-23T11:26:49+08:00">2024-02-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-02-28 20:46:00" itemprop="dateModified" datetime="2024-02-28T20:46:00+08:00">2024-02-28</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>170</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><em>xxd</em> - make a hexdump or do the reverse.</p>
<p><code>-s addr</code> 从 <code>addr</code> 开始，加 <code>0x</code> 前缀是16进制，不加则10进制<br><code>-l len</code> 长度，加 <code>0x</code> 前缀是16进制，不加则10进制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xxd -s 0x01205f -l 16 a.out</span></span><br><span class="line">001205f: 002e 7379 6d74 6162 002e 7374 7274 6162  ..symtab..strtab</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/23/note/linux/ftrace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/23/note/linux/ftrace/" class="post-title-link" itemprop="url">Linux Ftrace</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-23 11:26:49" itemprop="dateCreated datePublished" datetime="2024-02-23T11:26:49+08:00">2024-02-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-02-28 20:38:02" itemprop="dateModified" datetime="2024-02-28T20:38:02+08:00">2024-02-28</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ftrace"><a href="#ftrace" class="headerlink" title="ftrace"></a>ftrace</h1><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=68osT1soAPM">https://www.youtube.com/watch?v=68osT1soAPM</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t debugfs none /sys/kernel/debug/</span><br></pre></td></tr></table></figure>

<h3 id="跟踪open"><a href="#跟踪open" class="headerlink" title="跟踪open()"></a>跟踪open()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span>    <span class="comment">// For O_RDONLY</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>   <span class="comment">// For open, getpid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span>     <span class="comment">// For errno</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span>    <span class="comment">// For strerror</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>   <span class="comment">// For std::cerr</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">open</span>(<span class="string">&quot;example.txt&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Error opening file (PID: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot;): &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用ftrace+kprobe获取调用栈及入参和返回值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">CUR_DIR=$(<span class="built_in">pwd</span>)</span><br><span class="line"></span><br><span class="line">TRACING_DIR=/sys/kernel/debug/tracing</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用debugfs</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$TRACING_DIR</span> ]; <span class="keyword">then</span></span><br><span class="line">    mount -t debugfs none /sys/kernel/debug/</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$TRACING_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置tracer参数</span></span><br><span class="line"><span class="built_in">echo</span> function_graph &gt; current_tracer <span class="comment"># 抓取函数调用栈</span></span><br><span class="line"><span class="built_in">echo</span> do_sys_open &gt; set_graph_function <span class="comment"># 只抓取这个函数及其内部</span></span><br><span class="line"><span class="built_in">echo</span> funcgraph-proc &gt; trace_options <span class="comment"># 显示进程名列</span></span><br><span class="line"><span class="built_in">echo</span> funcgraph-tail &gt; trace_options <span class="comment"># 函数结束大括号处注释函数名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭所有event</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; <span class="variable">$TRACING_DIR</span>/events/enable</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:pre_do_sys_open do_sys_open dfd=%di filename=+0(%si):string flags=%dx mode=%cx&#x27;</span> &gt; kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:post_do_sys_open do_sys_open fd=$retval&#x27;</span> &gt;&gt; kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;filename ~ &quot;example.txt&quot;&#x27;</span> &gt; events/kprobes/pre_do_sys_open/filter</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:pre_link_path_walk link_path_walk name=+0(%di):string name_hex=%di:x64&#x27;</span> &gt;&gt; kprobe_events</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:post_link_path_walk link_path_walk ret=$retval:x64&#x27;</span> &gt;&gt; kprobe_events</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:post_step_into step_into ret=+0($retval):string ret_hex=$retval:x64&#x27;</span> &gt;&gt; kprobe_events</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; events/kprobes/pre_do_sys_open/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; events/kprobes/post_do_sys_open/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; events/kprobes/pre_link_path_walk/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; events/kprobes/post_link_path_walk/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; events/kprobes/post_step_into/enable</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启所有event</span></span><br><span class="line"><span class="comment"># echo 1 &gt; $TRACING_DIR/events/enable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空trace历史记录</span></span><br><span class="line"><span class="built_in">echo</span> &gt; trace</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始trace</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start tracer&quot;</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; <span class="variable">$TRACING_DIR</span>/tracing_on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行程序</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$CUR_DIR</span></span><br><span class="line">./a.out</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止trace</span></span><br><span class="line"><span class="built_in">echo</span> 0 &gt; <span class="variable">$TRACING_DIR</span>/tracing_on</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$TRACING_DIR</span>/trace &gt; trace.out</span><br><span class="line">gawk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> trace.out &gt; trace.func</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;stop tracer&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="Tracing-Events"><a href="#Tracing-Events" class="headerlink" title="Tracing Events"></a>Tracing Events</h1><p>official doc: <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v4.19/trace/events.html#event-tracing">https://www.kernel.org/doc/html/v4.19/trace/events.html#event-tracing</a></p>
<img src="./assets/image-20231121090802788.png" alt="image-20231121090802788" style="zoom:50%;" />

<img src="./assets/image-20231121090739325.png" alt="image-20231121090739325" style="zoom:50%;" />

<img src="./assets/image-20231121091847105.png" alt="image-20231121091847105" style="zoom:50%;" />

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:/sys/kernel$ sudo <span class="built_in">ls</span> /sys/kernel/debug/tracing/events</span><br><span class="line">9p            btrfs       dev           exceptions  fs_dax        hyperv       iommu        kvm        msr      netvsc  page_isolation  ras           <span class="built_in">sched</span>   sock      thermal   workqueue</span><br><span class="line">alarmtimer    cgroup      dma_fence     ext4        fscache       i2c          irq          kvmmmu     napi     nfs     pagemap         raw_syscalls  scsi    sunrpc    timer     writeback</span><br><span class="line">block         cifs        drm           fib         ftrace        initcall     irq_matrix   migrate    neigh    nfs4    percpu          rcu           sctp    swiotlb   tlb       x86_fpu</span><br><span class="line">bpf_test_run  clk         <span class="built_in">enable</span>        fib6        header_event  intel_iommu  irq_vectors  mmap       net      nfsd    power           rpcgss        signal  syscalls  udp       xdp</span><br><span class="line">bpf_trace     compaction  erofs         filelock    header_page   io_uring     jbd2         mmap_lock  netfs    nmi     printk          rseq          skb     task      vmscan    xfs</span><br><span class="line">bridge        cpuhp       error_report  filemap     huge_memory   iomap        kmem         module     netlink  oom     qdisc           rtc           smbus   tcp       vsyscall  xfs_scrub</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:/sys/kernel$ sudo <span class="built_in">ls</span> /sys/kernel/debug/tracing/events/irq</span><br><span class="line"><span class="built_in">enable</span>  filter  irq_handler_entry  irq_handler_exit  softirq_entry  softirq_exit  softirq_raise</span><br></pre></td></tr></table></figure>













<h1 id="trace-cmd"><a href="#trace-cmd" class="headerlink" title="trace-cmd"></a>trace-cmd</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install trace-cmd</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-p tracer</span><br><span class="line">           Specify a tracer. Tracers usually <span class="keyword">do</span> more than just trace an</span><br><span class="line">           event. Common tracers are: <span class="keyword">function</span>, function_graph,</span><br><span class="line">           preemptirqsoff, irqsoff, preemptoff and wakeup. A tracer must</span><br><span class="line">           be supported by the running kernel. To see a list of</span><br><span class="line">           available tracers, see trace-cmd-list(1).</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trace-cmd record -p function_graph -n do_sys_open ./a.out</span><br></pre></td></tr></table></figure>

<h1 id="Kprobe"><a href="#Kprobe" class="headerlink" title="Kprobe"></a>Kprobe</h1><p>ftrace能打印出内核函数调用栈，但是入参和返回值获取不到，这时候用kprobe。</p>
<p>ref: <a target="_blank" rel="noopener" href="https://docs.kernel.org/trace/kprobetrace.html">Kprobe-based Event Tracing &#8212; The Linux Kernel documentation</a></p>
<p>add probe points</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br></pre></td></tr></table></figure>

<p>enable probe points</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/&lt;EVENT&gt;/enabled.</span><br></pre></td></tr></table></figure>

<p>To add a probe as a new event, write a new definition to kprobe_events as below.</p>
<blockquote>
<p>Note:</p>
<p>The register&#x2F;stack entry assigned to each function argument depends on arch-specific ABI.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;p:myprobe do_sys_open dfd=%ax filename=%dx flags=%cx mode=+4($stack)&#x27;</span> &gt; /sys/kernel/debug/tracing/kprobe_events</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确认是否加上</span></span><br><span class="line">$ <span class="built_in">ls</span> /sys/kernel/debug/tracing/events/kprobes/myprobe/</span><br><span class="line"><span class="built_in">enable</span>  filter  format  <span class="built_in">id</span>  trigger</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;r:myretprobe do_sys_open $retval&#x27;</span> &gt;&gt; /sys/kernel/debug/tracing/kprobe_events</span><br></pre></td></tr></table></figure>

<p>Right after definition, each event is disabled by default. For tracing these events, you need to enable it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myprobe/enable</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/kprobes/myretprobe/enable</span><br></pre></td></tr></table></figure>

<h2 id="开关event"><a href="#开关event" class="headerlink" title="开关event"></a>开关event</h2><p><a target="_blank" rel="noopener" href="https://www.chiark.greenend.org.uk/doc/linux-doc-5.10/html/trace/events.html#via-the-enable-toggle">Event Tracing &mdash; The Linux Kernel documentation</a></p>
<p>To enable event ‘sched_wakeup’:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/sched/sched_wakeup/enable</span><br></pre></td></tr></table></figure>

<p>To disable it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/kernel/debug/tracing/events/sched/sched_wakeup/enable</span><br></pre></td></tr></table></figure>

<p>To enable all events in sched subsystem:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/sched/enable</span><br></pre></td></tr></table></figure>

<p>To enable all events:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/kernel/debug/tracing/events/enable</span><br></pre></td></tr></table></figure>

<p>When reading one of these enable files, there are four results:</p>
<blockquote>
<ul>
<li><p>0 - all events this file affects are disabled</p>
</li>
<li><p>1 - all events this file affects are enabled</p>
</li>
<li><p>X - there is a mixture of events enabled and disabled</p>
</li>
<li><p>? - this file does not affect any event</p>
</li>
</ul>
</blockquote>
<h2 id="寄存器位长格式"><a href="#寄存器位长格式" class="headerlink" title="寄存器位长格式"></a>寄存器位长格式</h2><p>x86_64 寄存器如 rdx, rdi 带有 ‘r’ 前缀，但是加kprobe时，不识别’r’前缀，原因为kprobe自动识别位长，不用加前缀。</p>
<p>转而可用类型转换指明想要的长度。</p>
<blockquote>
<p>After discussing with <code>kprobe</code> maintainer, I get the answer:</p>
<p><code>ftrace-kprobe</code> interface does not accept bitwidth prefix like ‘<code>rax</code>‘ instead it accepts ‘<code>ax</code>‘. </p>
<p>The bitwidth is automatically chosen by architecture. So please remove ‘<code>r</code>‘ from all arguments. </p>
<p>If you’d like to access <code>eax</code> or <code>ax</code>, you can use typecast, like as <code>%ax:u32</code>.</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/33096225/how-to-use-registers-in-kprobe">linux - How to use registers in kprobe? - Stack Overflow</a></p>
</blockquote>
<h2 id="入参为结构体指针"><a href="#入参为结构体指针" class="headerlink" title="入参为结构体指针"></a>入参为结构体指针</h2><p>怎么知道内存布局从而取特定字段？用C版本kprobe应该行。</p>
<h2 id="参数过滤"><a href="#参数过滤" class="headerlink" title="参数过滤"></a>参数过滤</h2><p><a target="_blank" rel="noopener" href="https://www.chiark.greenend.org.uk/doc/linux-doc-5.10/html/trace/events.html#event-filtering">Event Tracing &mdash; The Linux Kernel documentation</a></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="在内核函数内任意位置绑定回调"><a href="#在内核函数内任意位置绑定回调" class="headerlink" title="在内核函数内任意位置绑定回调"></a>在内核函数内任意位置绑定回调</h3><p><a target="_blank" rel="noopener" href="https://medium.com/@hu3vjeen/modifying-kernel-behavior-using-kprobe-based-modules-2795b0716964">https://medium.com/@hu3vjeen/modifying-kernel-behavior-using-kprobe-based-modules-2795b0716964</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/21/note/linux/elf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/21/note/linux/elf/" class="post-title-link" itemprop="url">Linux ELF文件分析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-21 17:34:51" itemprop="dateCreated datePublished" datetime="2024-02-21T17:34:51+08:00">2024-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-02-28 20:36:06" itemprop="dateModified" datetime="2024-02-28T20:36:06+08:00">2024-02-28</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>56 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computing">computing</a>, the <strong>Executable and Linkable Format</strong> (<strong>ELF</strong>, formerly named <strong>Extensible Linking Format</strong>), is a common standard <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/File_format">file format</a> for <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Executable">executable</a> files, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Object_code">object code</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shared_library">shared libraries</a>, and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Core_dump">core dumps</a>. – wikipedia</p>
</blockquote>
<p>ELF主宰了Linux下的二进制文件格式，值得深入学习下。</p>
<h1 id="开源工具"><a href="#开源工具" class="headerlink" title="开源工具"></a>开源工具</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/eliben/pyelftools">pyelftools</a> - A pure-Python library for parsing and analyzing ELF files and DWARF debugging information.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/BR903/ELFkickers">ELFkickers</a>- A collection of programs that access and manipulate ELF files.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/elftoolchain/elftoolchain">elftoolchain</a>- Essential development tools and libraries for building and analyzing ELF based program images.</li>
</ul>
<h1 id="ELF文件类型"><a href="#ELF文件类型" class="headerlink" title="ELF文件类型"></a>ELF文件类型</h1><ul>
<li>Object files (<code>.o</code>).</li>
<li>Executable files (no standard Linux extension).</li>
<li>Archive files (<code>.a</code>).</li>
<li>Shared object files (<code>.so</code>).</li>
<li>Core dumps.</li>
</ul>
<h1 id="ELF文件内容概览"><a href="#ELF文件内容概览" class="headerlink" title="ELF文件内容概览"></a>ELF文件内容概览</h1><p>An ELF file contains the following parts:</p>
<ul>
<li>ELF header. Points to the position of the section header table and the program header table.</li>
<li>Section header table (optional on executable). Each has <code>e_shnum</code> section headers, each pointing to the position of a section.</li>
<li>N sections, with <code>N &lt;= e_shnum</code> (optional on executable)</li>
<li>Program header table (only on executable). Each has <code>e_phnum</code> program headers, each pointing to the position of a segment.</li>
<li>N segments, with <code>N &lt;= e_phnum</code> (only on executable)</li>
</ul>
<p>object file with three sections:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">            +-------------------+</span><br><span class="line">            | ELF header        |---+</span><br><span class="line">+---------&gt; +-------------------+   | e_shoff</span><br><span class="line">|           |                   |&lt;--+</span><br><span class="line">| Section   | Section header 0  |</span><br><span class="line">|           |                   |---+ sh_offset</span><br><span class="line">| Header    +-------------------+   |</span><br><span class="line">|           | Section header 1  |---|--+ sh_offset</span><br><span class="line">| Table     +-------------------+   |  |</span><br><span class="line">|           | Section header 2  |---|--|--+</span><br><span class="line">+---------&gt; +-------------------+   |  |  |</span><br><span class="line">            | Section 0         |&lt;--+  |  |</span><br><span class="line">            +-------------------+      |  | sh_offset</span><br><span class="line">            | Section 1         |&lt;-----+  |</span><br><span class="line">            +-------------------+         |</span><br><span class="line">            | Section 2         |&lt;--------+</span><br><span class="line">            +-------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ELF可执行文件运行时：<br><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102739.png" alt="image.png"></p>
<h1 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint32_t</span>	st_name;		<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_info;	<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;	<span class="comment">/* Symbol visibility */</span></span><br><span class="line">  <span class="type">uint16_t</span>	st_shndx;		<span class="comment">/* Section index */</span></span><br><span class="line">  <span class="type">uint64_t</span>	st_value;		<span class="comment">/* Symbol value */</span></span><br><span class="line">  <span class="type">uint64_t</span>	st_size;		<span class="comment">/* Symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定长24字节</span></span><br></pre></td></tr></table></figure>

<h1 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h1><p>查看ELF Header</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/demo$ readelf -h hello_world.o</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              REL (Relocatable file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x0</span></span><br><span class="line"><span class="string">  Start of program headers:          0 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          64 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           0 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         0</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         7</span></span><br><span class="line"><span class="string">  Section header string table index: 3</span></span><br></pre></td></tr></table></figure>

<p>对应的二进制流</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/demo$ hd hello_world.o</span><br><span class="line">00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|</span><br><span class="line">00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..&gt;.............|</span><br><span class="line">00000020  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  |........@.......|</span><br><span class="line">00000030  00 00 00 00 40 00 00 00  00 00 40 00 07 00 03 00  |....@.....@.....|</span><br></pre></td></tr></table></figure>

<p>c结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT (16)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	e_ident[EI_NIDENT];	<span class="comment">/* Magic number and other info */</span></span><br><span class="line">  Elf64_Half	e_type;			<span class="comment">/* Object file type */</span></span><br><span class="line">  Elf64_Half	e_machine;		<span class="comment">/* Architecture */</span></span><br><span class="line">  Elf64_Word	e_version;		<span class="comment">/* Object file version */</span></span><br><span class="line">  Elf64_Addr	e_entry;		<span class="comment">/* Entry point virtual address */</span></span><br><span class="line">  Elf64_Off	e_phoff;		<span class="comment">/* Program header table file offset */</span></span><br><span class="line">  Elf64_Off	e_shoff;		<span class="comment">/* Section header table file offset */</span></span><br><span class="line">  Elf64_Word	e_flags;		<span class="comment">/* Processor-specific flags */</span></span><br><span class="line">  Elf64_Half	e_ehsize;		<span class="comment">/* ELF header size in bytes */</span></span><br><span class="line">  Elf64_Half	e_phentsize;		<span class="comment">/* Program header table entry size */</span></span><br><span class="line">  Elf64_Half	e_phnum;		<span class="comment">/* Program header table entry count */</span></span><br><span class="line">  Elf64_Half	e_shentsize;		<span class="comment">/* Section header table entry size */</span></span><br><span class="line">  Elf64_Half	e_shnum;		<span class="comment">/* Section header table entry count */</span></span><br><span class="line">  Elf64_Half	e_shstrndx;		<span class="comment">/* Section header string table index */</span></span><br><span class="line">&#125; Elf64_Ehdr;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; whatis Elf64_Half</span><br><span class="line">type = <span class="type">uint16_t</span></span><br><span class="line">&gt;&gt;&gt; whatis Elf64_Word</span><br><span class="line">type = <span class="type">uint32_t</span></span><br><span class="line">&gt;&gt;&gt; whatis Elf64_Addr</span><br><span class="line">type = <span class="type">uint64_t</span></span><br><span class="line">&gt;&gt;&gt; whatis Elf64_Off</span><br><span class="line">type = <span class="type">uint64_t</span></span><br></pre></td></tr></table></figure>

<h2 id="由-ELF-Header-定位-Section-Header-Table"><a href="#由-ELF-Header-定位-Section-Header-Table" class="headerlink" title="由 ELF Header 定位 Section Header Table"></a>由 ELF Header 定位 Section Header Table</h2><p>ELF Header 通过如下4个字段指明 section header table 的位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf -h a.out | egrep &quot;[s|S]ection&quot;</span></span><br><span class="line">  Start of section headers:          74152 (bytes into file)</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         34</span><br><span class="line">  Section header string table index: 33</span><br></pre></td></tr></table></figure>

<p>由上述信息可知：Section header string table section (<code>.shstrtab</code>) 位于 section header table 下标为 33 位置，由于所有的 section header 长度为定长 64 字节，由此可计算出该section header的起始地址为 <code>74152 + 33 * 64 = 76264</code>, 即如下字节流：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># xxd -s 76264 -l 64 a.out </span><br><span class="line">00129e8: 1100 0000 0300 0000 0000 0000 0000 0000  ................</span><br><span class="line">00129f8: 0000 0000 0000 0000 5f20 0100 0000 0000  ........_ ......</span><br><span class="line">0012a08: 4301 0000 0000 0000 0000 0000 0000 0000  C...............</span><br><span class="line">0012a18: 0100 0000 0000 0000 0000 0000 0000 0000  ................</span><br></pre></td></tr></table></figure>

<p>期望这64字节能与<code>readelf</code>给出的结果匹配上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf -S -W a.out</span></span><br><span class="line"></span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf </span><br><span class="line">  [33] .shstrtab         STRTAB          0000000000000000 01205f 000143 00      0   0  1</span><br></pre></td></tr></table></figure>

<p>把 section header 结构再搬过来，试着逐字段对比</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_name;      <span class="comment">/* Section name (string tbl index) */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_type;      <span class="comment">/* Section type */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_flags;     <span class="comment">/* Section flags */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_addr;      <span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_offset;    <span class="comment">/* Section file offset*/</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_size;      <span class="comment">/* Section size in bytes */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_link;      <span class="comment">/* Link to another section */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_info;      <span class="comment">/* Additional section information */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_addralign; <span class="comment">/* Section alignment */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_entsize;   <span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf64_Shdr;</span><br></pre></td></tr></table></figure>

<p>第 1-4 字节，<code>sh_name</code>，转换为大端10进制为 <code>0x11 = 3</code>，表示 <code>.shstrtab</code> 中第三个字符串就是当前section的名称。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00129e8: [1100 0000] 0300 0000 0000 0000 0000 0000  ................</span><br></pre></td></tr></table></figure>

<p>匹配上 <code>readelf</code> 结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ZLPC-WangQingJia demo]# readelf -x .shstrtab a.out </span><br><span class="line"></span><br><span class="line">Hex dump of section &#x27;.shstrtab&#x27;:</span><br><span class="line">  0x00000000 002e7379 6d746162 002e7374 72746162 ..symtab..strtab</span><br><span class="line">  0x00000010 002e7368 73747274 6162002e 696e7465 ..shstrtab..inte</span><br><span class="line">  0x00000020 7270002e 6e6f7465 2e414249 2d746167 rp..note.ABI-tag</span><br></pre></td></tr></table></figure>

<p>第 5-8 字节，<code>sh_type = 0x03</code> ，类型是字符串表，匹配上 <code>readelf</code> 结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00129e8: 1100 0000 [0300 0000] 0000 0000 0000 0000  ................</span><br><span class="line"></span><br><span class="line">#define SHT_STRTAB    3   /* String table */</span><br></pre></td></tr></table></figure>

<p>第 25-32 字节，<code>sh_offset = 0x01205f</code> 正好匹配上 <code>readelf</code> 的 Off 列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00129e8: 1100 0000 0300 0000 0000 0000 0000 0000  ................</span><br><span class="line">00129f8: 0000 0000 0000 0000 [5f20 0100 0000 0000]  ........_ ......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf </span><br><span class="line">[33] .shstrtab         STRTAB          0000000000000000 01205f 000143 00      0   0  1</span><br></pre></td></tr></table></figure>


<h2 id="进而由-Section-Header-定位-Section"><a href="#进而由-Section-Header-定位-Section" class="headerlink" title="进而由 Section Header 定位 Section"></a>进而由 Section Header 定位 Section</h2><p>由 <code>.shstrtab</code> 的 section header 可知该section位于ELF文件的 <code>[0x01205f, 0x01205f+0x143=0x121A2]</code> 范围</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf -S -W a.out</span></span><br><span class="line"></span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf </span><br><span class="line">  [33] .shstrtab         STRTAB          0000000000000000 01205f 000143 00      0   0  1</span><br></pre></td></tr></table></figure>

<p>验证：结果完全吻合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@ZLPC-WangQingJia demo]# xxd -s 0x01205f -l 0x143 a.out</span><br><span class="line">001205f: 002e 7379 6d74 6162 002e 7374 7274 6162  ..symtab..strtab</span><br><span class="line">001206f: 002e 7368 7374 7274 6162 002e 696e 7465  ..shstrtab..inte</span><br><span class="line">001207f: 7270 002e 6e6f 7465 2e41 4249 2d74 6167  rp..note.ABI-tag</span><br><span class="line">001208f: 002e 6e6f 7465 2e67 6e75 2e62 7569 6c64  ..note.gnu.build</span><br><span class="line">001209f: 2d69 6400 2e67 6e75 2e68 6173 6800 2e64  -id..gnu.hash..d</span><br><span class="line">00120af: 796e 7379 6d00 2e64 796e 7374 7200 2e67  ynsym..dynstr..g</span><br><span class="line">00120bf: 6e75 2e76 6572 7369 6f6e 002e 676e 752e  nu.version..gnu.</span><br><span class="line">00120cf: 7665 7273 696f 6e5f 7200 2e72 656c 612e  version_r..rela.</span><br><span class="line">00120df: 6479 6e00 2e72 656c 612e 706c 7400 2e69  dyn..rela.plt..i</span><br><span class="line">00120ef: 6e69 7400 2e74 6578 7400 2e66 696e 6900  nit..text..fini.</span><br><span class="line">00120ff: 2e72 6f64 6174 6100 2e65 685f 6672 616d  .rodata..eh_fram</span><br><span class="line">001210f: 655f 6864 7200 2e65 685f 6672 616d 6500  e_hdr..eh_frame.</span><br><span class="line">001211f: 2e69 6e69 745f 6172 7261 7900 2e66 696e  .init_array..fin</span><br><span class="line">001212f: 695f 6172 7261 7900 2e64 796e 616d 6963  i_array..dynamic</span><br><span class="line">001213f: 002e 676f 7400 2e67 6f74 2e70 6c74 002e  ..got..got.plt..</span><br><span class="line">001214f: 6461 7461 002e 6273 7300 2e63 6f6d 6d65  data..bss..comme</span><br><span class="line">001215f: 6e74 002e 6465 6275 675f 6172 616e 6765  nt..debug_arange</span><br><span class="line">001216f: 7300 2e64 6562 7567 5f69 6e66 6f00 2e64  s..debug_info..d</span><br><span class="line">001217f: 6562 7567 5f61 6262 7265 7600 2e64 6562  ebug_abbrev..deb</span><br><span class="line">001218f: 7567 5f6c 696e 6500 2e64 6562 7567 5f73  ug_line..debug_s</span><br><span class="line">001219f: 7472 00                                  tr.</span><br><span class="line"></span><br><span class="line">[root@ZLPC-WangQingJia demo]# readelf -x .shstrtab a.out </span><br><span class="line">Hex dump of section &#x27;.shstrtab&#x27;:</span><br><span class="line">  0x00000000 002e7379 6d746162 002e7374 72746162 ..symtab..strtab</span><br><span class="line">  0x00000010 002e7368 73747274 6162002e 696e7465 ..shstrtab..inte</span><br><span class="line">  0x00000020 7270002e 6e6f7465 2e414249 2d746167 rp..note.ABI-tag</span><br><span class="line">  0x00000030 002e6e6f 74652e67 6e752e62 75696c64 ..note.gnu.build</span><br><span class="line">  0x00000040 2d696400 2e676e75 2e686173 68002e64 -id..gnu.hash..d</span><br><span class="line">  0x00000050 796e7379 6d002e64 796e7374 72002e67 ynsym..dynstr..g</span><br><span class="line">  0x00000060 6e752e76 65727369 6f6e002e 676e752e nu.version..gnu.</span><br><span class="line">  0x00000070 76657273 696f6e5f 72002e72 656c612e version_r..rela.</span><br><span class="line">  0x00000080 64796e00 2e72656c 612e706c 74002e69 dyn..rela.plt..i</span><br><span class="line">  0x00000090 6e697400 2e746578 74002e66 696e6900 nit..text..fini.</span><br><span class="line">  0x000000a0 2e726f64 61746100 2e65685f 6672616d .rodata..eh_fram</span><br><span class="line">  0x000000b0 655f6864 72002e65 685f6672 616d6500 e_hdr..eh_frame.</span><br><span class="line">  0x000000c0 2e696e69 745f6172 72617900 2e66696e .init_array..fin</span><br><span class="line">  0x000000d0 695f6172 72617900 2e64796e 616d6963 i_array..dynamic</span><br><span class="line">  0x000000e0 002e676f 74002e67 6f742e70 6c74002e ..got..got.plt..</span><br><span class="line">  0x000000f0 64617461 002e6273 73002e63 6f6d6d65 data..bss..comme</span><br><span class="line">  0x00000100 6e74002e 64656275 675f6172 616e6765 nt..debug_arange</span><br><span class="line">  0x00000110 73002e64 65627567 5f696e66 6f002e64 s..debug_info..d</span><br><span class="line">  0x00000120 65627567 5f616262 72657600 2e646562 ebug_abbrev..deb</span><br><span class="line">  0x00000130 75675f6c 696e6500 2e646562 75675f73 ug_line..debug_s</span><br><span class="line">  0x00000140 747200                              tr.</span><br></pre></td></tr></table></figure>


<h1 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h1><blockquote>
<p>Strictly speaking, the division into sections is intended to provide a convenient organization for use by the linker. Sections are intended to provide a view for the linker only.</p>
</blockquote>
<p>由 <code>section header table</code> 定义 sections.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/demo$ readelf -S hello_world.o</span><br><span class="line">There are 7 section headers, starting at offset 0x40:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .data             PROGBITS         0000000000000000  00000200</span><br><span class="line">       000000000000000d  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 2] .text             PROGBITS         0000000000000000  00000210</span><br><span class="line">       0000000000000027  0000000000000000  AX       0     0     16</span><br><span class="line">  [ 3] .shstrtab         STRTAB           0000000000000000  00000240</span><br><span class="line">       0000000000000032  0000000000000000           0     0     1</span><br><span class="line">  [ 4] .symtab           SYMTAB           0000000000000000  00000280</span><br><span class="line">       00000000000000a8  0000000000000018           5     6     8</span><br><span class="line">  [ 5] .strtab           STRTAB           0000000000000000  00000330</span><br><span class="line">       000000000000002b  0000000000000000           0     0     1</span><br><span class="line">  [ 6] .rela.text        RELA             0000000000000000  00000360</span><br><span class="line">       0000000000000018  0000000000000018           4     2     8</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure>

<h2 id="Section-Header-Table"><a href="#Section-Header-Table" class="headerlink" title="Section Header Table"></a>Section Header Table</h2><p>Section header entry(fixed size) is defined as <code>Elf64_Shdr</code> in <code>/usr/include/elf.h</code><br>Section header table is an array of <code>Elf64_Shdr</code> structs.<br>Each entry describes a section.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_name;      <span class="comment">/* Section name (string tbl index) */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_type;      <span class="comment">/* Section type */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_flags;     <span class="comment">/* Section flags */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_addr;      <span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_offset;    <span class="comment">/* Section file offset*/</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_size;      <span class="comment">/* Section size in bytes */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_link;      <span class="comment">/* Link to another section */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_info;      <span class="comment">/* Additional section information */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_addralign; <span class="comment">/* Section alignment */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_entsize;   <span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf64_Shdr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单个section header为64字节</span></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -h hello_world.o</span><br><span class="line"></span><br><span class="line">Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">Class:                             ELF64</span><br><span class="line">Data:                              2&#x27;s complement, little endian</span><br><span class="line">Version:                           1 (current)</span><br><span class="line">OS/ABI:                            UNIX - System V</span><br><span class="line">ABI Version:                       0</span><br><span class="line">Type:                              REL (Relocatable file)</span><br><span class="line">Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">Version:                           0x1</span><br><span class="line">Entry point address:               0x0</span><br><span class="line">Start of program headers:          0 (bytes into file)</span><br><span class="line">Start of section headers:          64 (bytes into file)</span><br><span class="line">Flags:                             0x0</span><br><span class="line">Size of this header:               64 (bytes)</span><br><span class="line">Size of program headers:           0 (bytes)</span><br><span class="line">Number of program headers:         0</span><br><span class="line">Size of section headers:           64 (bytes)</span><br><span class="line">Number of section headers:         7</span><br><span class="line">Section header string table index: 3</span><br></pre></td></tr></table></figure>

<p>Files used during linking must have a section header table; Because sections are intended to provide a view for the linker only, the section header table is an optional part of the ELF format. ELF files that don’t need linking aren’t required to have a section header table. If no sec-<br>tion header table is present, the e_shoff field in the executable header is set to zero.</p>
<h3 id="sh-name"><a href="#sh-name" class="headerlink" title="sh_name"></a>sh_name</h3><p>If set, it contains an index into the <code>.shstrtab</code> (section header string table). If the index is zero, it means the section doesn’t have a name.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># readelf -x .shstrtab a.out </span><br><span class="line"></span><br><span class="line">Hex dump of section &#x27;.shstrtab&#x27;:</span><br><span class="line">  0x00000000 002e7379 6d746162 002e7374 72746162 ..symtab..strtab</span><br><span class="line">  0x00000010 002e7368 73747274 6162002e 696e7465 ..shstrtab..inte</span><br><span class="line">  0x00000020 7270002e 6e6f7465 2e414249 2d746167 rp..note.ABI-tag</span><br><span class="line">  0x00000030 002e6e6f 74652e67 6e752e62 75696c64 ..note.gnu.build</span><br><span class="line">  0x00000040 2d696400 2e676e75 2e686173 68002e64 -id..gnu.hash..d</span><br><span class="line">  0x00000050 796e7379 6d002e64 796e7374 72002e67 ynsym..dynstr..g</span><br><span class="line">  0x00000060 6e752e76 65727369 6f6e002e 676e752e nu.version..gnu.</span><br><span class="line">  0x00000070 76657273 696f6e5f 72002e72 656c612e version_r..rela.</span><br><span class="line">  0x00000080 64796e00 2e72656c 612e706c 74002e69 dyn..rela.plt..i</span><br><span class="line">  0x00000090 6e697400 2e746578 74002e66 696e6900 nit..text..fini.</span><br><span class="line">  0x000000a0 2e726f64 61746100 2e65685f 6672616d .rodata..eh_fram</span><br><span class="line">  0x000000b0 655f6864 72002e65 685f6672 616d6500 e_hdr..eh_frame.</span><br><span class="line">  0x000000c0 2e696e69 745f6172 72617900 2e66696e .init_array..fin</span><br><span class="line">  0x000000d0 695f6172 72617900 2e64796e 616d6963 i_array..dynamic</span><br><span class="line">  0x000000e0 002e676f 74002e67 6f742e70 6c74002e ..got..got.plt..</span><br><span class="line">  0x000000f0 64617461 002e6273 73002e63 6f6d6d65 data..bss..comme</span><br><span class="line">  0x00000100 6e74002e 64656275 675f6172 616e6765 nt..debug_arange</span><br><span class="line">  0x00000110 73002e64 65627567 5f696e66 6f002e64 s..debug_info..d</span><br><span class="line">  0x00000120 65627567 5f616262 72657600 2e646562 ebug_abbrev..deb</span><br><span class="line">  0x00000130 75675f6c 696e6500 2e646562 75675f73 ug_line..debug_s</span><br><span class="line">  0x00000140 747200                              tr.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="sh-type"><a href="#sh-type" class="headerlink" title="sh_type"></a>sh_type</h3><p>Every section has a type, indicated by an integer field called <code>sh_type</code>, that tells the linker something about the structure of a section’s contents.</p>
<h4 id="SHT-PROGBITS"><a href="#SHT-PROGBITS" class="headerlink" title="SHT_PROGBITS"></a>SHT_PROGBITS</h4><p>Contain program data, such as machine instructions or constants. These sections have no particular structure for the linker to parse.</p>
<h4 id="SHT-SYMTAB"><a href="#SHT-SYMTAB" class="headerlink" title="SHT_SYMTAB"></a>SHT_SYMTAB</h4><p>Static symbol tables. Symbol tables contain symbols in a well-defined format (struct Elf64_Sym in elf.h)</p>
<h4 id="SHT-DYNSYM"><a href="#SHT-DYNSYM" class="headerlink" title="SHT_DYNSYM"></a>SHT_DYNSYM</h4><p>Symbol tables used by the dynamic linker.</p>
<h4 id="SHT-STRTAB"><a href="#SHT-STRTAB" class="headerlink" title="SHT_STRTAB"></a>SHT_STRTAB</h4><p>String tables, which simply contain an array of NULL-terminated strings, with the first byte in the string table set to NULL by convention.</p>
<h4 id="SHT-REL-SHT-RELA"><a href="#SHT-REL-SHT-RELA" class="headerlink" title="SHT_REL &#x2F; SHT_RELA"></a>SHT_REL &#x2F; SHT_RELA</h4><p>Sections with type SHT_REL or SHT_RELA are particularly important for the linker because they contain relocation entries in a well-defined format (struct Elf64_Rel and struct Elf64_Rela in elf.h), which the linker can parse to perform the necessary relocations in other sections. Each relocation entry tells the linker about a particular location in the binary where a relocation is needed and which symbol the relocation should be resolved to.</p>
<h4 id="SHT-DYNAMIC"><a href="#SHT-DYNAMIC" class="headerlink" title="SHT_DYNAMIC"></a>SHT_DYNAMIC</h4><p>Sections of type SHT_DYNAMIC contain information needed for dynamic linking. This information is formatted using struct Elf64_Dyn as specified in elf.h.</p>
<h3 id="sh-flags"><a href="#sh-flags" class="headerlink" title="sh_flags"></a>sh_flags</h3><h4 id="SHF-WRITE"><a href="#SHF-WRITE" class="headerlink" title="SHF_WRITE"></a>SHF_WRITE</h4><p>SHF_WRITE indicates that the section is writable at runtime. </p>
<h4 id="SHF-ALLOC"><a href="#SHF-ALLOC" class="headerlink" title="SHF_ALLOC"></a>SHF_ALLOC</h4><blockquote>
<p>The SHF_ALLOC flag indicates that the contents of the section are to be loaded into virtual memory when executing the binary (though the actual loading happens using the segment view of the binary, not the section view).</p>
</blockquote>
<h4 id="SHF-EXECINSTR"><a href="#SHF-EXECINSTR" class="headerlink" title="SHF_EXECINSTR"></a>SHF_EXECINSTR</h4><blockquote>
<p>SHF_EXECINSTR tells you that the section contains executable instructions, which is useful to know when disassembling a binary.</p>
</blockquote>
<h3 id="sh-addr"><a href="#sh-addr" class="headerlink" title="sh_addr"></a>sh_addr</h3><p>virtual address of section.</p>
<p>the linker sometimes needs to know at which addresses partic-<br>ular pieces of code and data will end up at runtime to do relocations. The<br>sh_addr field provides this information. Sections that aren’t intended to be<br>loaded into virtual memory when setting up the process have an sh_addr<br>value of zero.</p>
<h3 id="sh-offset"><a href="#sh-offset" class="headerlink" title="sh_offset"></a>sh_offset</h3><p>The byte offset from the beginning of the file to the first byte in the section.</p>
<h3 id="sh-size"><a href="#sh-size" class="headerlink" title="sh_size"></a>sh_size</h3><p>size (in bytes) of the section</p>
<h3 id="sh-info"><a href="#sh-info" class="headerlink" title="sh_info"></a>sh_info</h3><blockquote>
<p>The sh_info field contains additional information about the section. The<br>meaning of the additional information varies depending on the section type.<br>For instance, for relocation sections, sh_info denotes the index of the section<br>to which the relocations are to be applied.</p>
</blockquote>
<h3 id="sh-addralign"><a href="#sh-addralign" class="headerlink" title="sh_addralign"></a>sh_addralign</h3><blockquote>
<p>Some sections may need to be aligned in memory in a particular way for effi-<br>ciency of memory accesses. For example, a section may need to be loaded<br>at some address that is a multiple of 8 bytes or 16 bytes. These alignment<br>requirements are specified in the sh_addralign field. For instance, if this field<br>is set to 16, it means the base address of the section (as chosen by the linker)<br>must be some multiple of 16. The values 0 and 1 are reserved to indicate no<br>special alignment needs.</p>
</blockquote>
<h3 id="sh-entsize"><a href="#sh-entsize" class="headerlink" title="sh_entsize"></a>sh_entsize</h3><p>Some sections, such as symbol tables or relocation tables, contain a table of well-defined data structures (such as Elf64_Sym or Elf64_Rela). For such sections, the sh_entsize field indicates the size in bytes of each entry in the table. When the field is unused, it is set to zero</p>
<h2 id="Sections"><a href="#Sections" class="headerlink" title="Sections"></a>Sections</h2><h3 id="Index-0-Section"><a href="#Index-0-Section" class="headerlink" title="Index 0 Section"></a>Index 0 Section</h3><p>magic section</p>
<h3 id="data"><a href="#data" class="headerlink" title=".data"></a>.data</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [24] .data             PROGBITS        0000000000002000 001000 000010 00  WA  0   0  8</span><br></pre></td></tr></table></figure>

<h3 id="plt"><a href="#plt" class="headerlink" title=".plt"></a>.plt</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [13] .plt              PROGBITS        0000000000000550 000550 000050 10  AX  0   0 16</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line">0000000000000550 &lt;.plt&gt;:</span><br><span class="line"> 550:    ff 35 8a 1a 00 00        pushq  0x1a8a(%rip)        # 1fe0 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span><br><span class="line"> 556:    f2 ff 25 8b 1a 00 00     bnd jmpq *0x1a8b(%rip)        # 1fe8 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span><br><span class="line"> 55d:    0f 1f 00                 nopl   (%rax)</span><br><span class="line"> 560:    f3 0f 1e fa              endbr64 </span><br><span class="line"> 564:    68 00 00 00 00           pushq  $0x0</span><br><span class="line"> 569:    f2 e9 e1 ff ff ff        bnd jmpq 550 &lt;_init+0x28&gt;</span><br><span class="line"> 56f:    90                       nop</span><br><span class="line"> 570:    f3 0f 1e fa              endbr64 </span><br><span class="line"> 574:    68 01 00 00 00           pushq  $0x1</span><br><span class="line"> 579:    f2 e9 d1 ff ff ff        bnd jmpq 550 &lt;_init+0x28&gt;</span><br><span class="line"> 57f:    90                       nop</span><br><span class="line"> 580:    f3 0f 1e fa              endbr64 </span><br><span class="line"> 584:    f2 ff 25 65 1a 00 00     bnd jmpq *0x1a65(%rip)        # 1ff0 &lt;__cxa_finalize@GLIBC_2.2.5&gt;</span><br><span class="line"> 58b:    0f 1f 04 00              nopl   (%rax,%rax,1)</span><br><span class="line"> 58f:    90                       nop</span><br><span class="line"> 590:    f3 0f 1e fa              endbr64 </span><br><span class="line"> 594:    f2 ff 25 5d 1a 00 00     bnd jmpq *0x1a5d(%rip)        # 1ff8 &lt;putchar@GLIBC_2.2.5&gt;</span><br><span class="line"> 59b:    0f 1f 04 00              nopl   (%rax,%rax,1)</span><br><span class="line"> 59f:    90                       nop</span><br></pre></td></tr></table></figure>

<h3 id="got"><a href="#got" class="headerlink" title=".got"></a>.got</h3><p>A GOT is simply a table of addresses, residing in the data section. The GOT entry, in turn, will contain the absolute address of the variable:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [22] .got              PROGBITS        0000000000001fb0 000fb0 000028 00  WA  0   0  8</span><br></pre></td></tr></table></figure>

<h3 id="got-plt"><a href="#got-plt" class="headerlink" title=".got.plt"></a>.got.plt</h3><p><code>.got.plt</code> 的前三项是有特殊意义的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GOT[0]：保存的是“.dynamic”节的地址，这个节描述了本模块动态链接相关的信息</span><br><span class="line">GOT[1]：保存的是本模块的link_map结构的地址，动态链接器利用该地址来对符号进行解析。</span><br><span class="line">GOT[2]：保存的是_dl_runtime_resolve()的地址。</span><br></pre></td></tr></table></figure>

<p>其中第二项和第三项由动态链接器在装载共享模块的时候负责将它们初始化。</p>
<p><code>.got.plt</code>的其余项分别对应每个外部函数的引用</p>
<p><code>.got.plt</code> contains the addresses of the external <em>functions</em> used by the program.</p>
<p>PLT(Procedure Linkage Table) which is, put simply, used to call external procedures&#x2F;functions whose address isn’t known in the time of linking, and is left to be resolved by the dynamic linker at run time.</p>
<p>for code, things are a bit more complicated.</p>
<p>Whenever a function from a shared library is called, the linker makes us jump to an address in the PLT.</p>
<p>The first time the function is called, the PLT code uses offsets stored in the GOT to decide the actual final location of the function, and then:</p>
<ul>
<li>stores this pre-calculated value</li>
<li>jumps there</li>
</ul>
<p>The next times the function is called, the value has already been calculated, so it just jumps there directly.</p>
<p>Due to this lazy resolution mechanism:</p>
<ul>
<li>programs can start running quickly even if the shared libraries have a lot of symbols</li>
<li>we can replace functions on the fly by playing with the <code>LD_PRELOAD</code> variable</li>
</ul>
<h3 id="rela-text-rel-text"><a href="#rela-text-rel-text" class="headerlink" title=".rela.text &#x2F; .rel.text"></a>.rela.text &#x2F; .rel.text</h3><p><a target="_blank" rel="noopener" href="https://ourbigbook.com/cirosantilli/elf-hello-world#cirosantilli/elf-hello-world/rela-text">https://ourbigbook.com/cirosantilli/elf-hello-world#cirosantilli/elf-hello-world/rela-text</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr    r_offset;        <span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword    r_info;            <span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">  Elf64_Sxword    r_addend;        <span class="comment">/* Addend */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102811.png" alt="image.png"></p>
<p>Besides <code>sh_type == SHT_RELA</code>, there also exists <code>SHT_REL</code>, which would have section name <code>.text.rel</code>.</p>
<p>Those represent the same <code>struct</code>, but without the addend, e.g.:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Addr  r_offset;</span><br><span class="line">    Elf64_Xword r_info;</span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<p>The ELF standard says that in many cases the both can be used, and it is just a matter of convenience.</p>
<h3 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h3><p>专门用于动态链接</p>
<p>动态链接ELF中<code>最重要的结构</code>应该是 **<code>.dynamic</code>**，这个节里面保存了<code>动态链接器</code>所需要的<code>基本信息</code>，比如依赖于哪些<code>共享对象</code>、<code>动态链接符号表</code>的位置、<code>动态链接重定位表</code>的位置、<code>共享对象初始化代码</code>的地址等。</p>
<p>The <code>.dynamic</code> section is comprised of <code>Elf64_Dyn</code> or <code>Elf32_Dyn</code> entries, not direct references to libraries. Some of these entries, identified by their <code>.d_tag</code> field (e.g., <code>DT_NEEDED</code> for required libraries or <code>DT_RPATH</code> for library search paths), point to strings within the <code>.dynstr</code> section via offsets. The dynamic loader uses these entries to determine actions such as loading additional libraries or specifying library search paths, interpreting the referenced strings according to the entries’ types and values.</p>
<p>使用<code>readelf</code>工具可以查看<code>“.dynamic”节</code>的内容：</p>
<ul>
<li><blockquote>
<p>-d –dynamic           Display the dynamic section (if present)</p>
</blockquote>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -d a.out</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0x750 contains 25 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000c (INIT)                       0x8048328</span><br><span class="line"> 0x0000000d (FINI)                       0x8048650</span><br><span class="line"> 0x00000019 (INIT_ARRAY)                 0x8049744</span><br><span class="line"> 0x0000001b (INIT_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x0000001a (FINI_ARRAY)                 0x8049748</span><br><span class="line"> 0x0000001c (FINI_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x00000004 (HASH)                       0x804818c</span><br><span class="line"> 0x6ffffef5 (GNU_HASH)                   0x80481c0</span><br><span class="line"> 0x00000005 (STRTAB)                     0x8048260</span><br><span class="line"> 0x00000006 (SYMTAB)                     0x80481e0</span><br><span class="line"> 0x0000000a (STRSZ)                      95 (bytes)</span><br><span class="line"> 0x0000000b (SYMENT)                     16 (bytes)</span><br><span class="line"> 0x00000015 (DEBUG)                      0x0</span><br><span class="line"> 0x00000003 (PLTGOT)                     0x8049844</span><br><span class="line"> 0x00000002 (PLTRELSZ)                   48 (bytes)</span><br><span class="line"> 0x00000014 (PLTREL)                     REL</span><br><span class="line"> 0x00000017 (JMPREL)                     0x80482f8</span><br><span class="line"> 0x00000011 (REL)                        0x80482f0</span><br><span class="line"> 0x00000012 (RELSZ)                      8 (bytes)</span><br><span class="line"> 0x00000013 (RELENT)                     8 (bytes)</span><br><span class="line"> 0x6ffffffe (VERNEED)                    0x80482d0</span><br><span class="line"> 0x6fffffff (VERNEEDNUM)                 1</span><br><span class="line"> 0x6ffffff0 (VERSYM)                     0x80482c0</span><br><span class="line"> 0x00000000 (NULL)                       0x0</span><br></pre></td></tr></table></figure>

<h3 id="interp"><a href="#interp" class="headerlink" title=".interp"></a>.interp</h3><p>有动态库的可执行文件才有这个section</p>
<p>This section holds the path name of a program interpreter.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ZLPC-WangQingJia home]# readelf -x .interp pyelftools/test/testfiles_for_unittests/simple_mipsel.elf</span><br><span class="line"></span><br><span class="line">Hex dump of section &#x27;.interp&#x27;:</span><br><span class="line">  0x00400194 2f6c6962 2f6c642e 736f2e31 00       /lib/ld.so.1.</span><br></pre></td></tr></table></figure>

<h3 id="hash"><a href="#hash" class="headerlink" title=".hash"></a>.hash</h3><p>给<code>ld.so</code> 查询动态符号用的哈希表</p>
<p><a target="_blank" rel="noopener" href="https://flapenguin.me/elf-dt-hash">https://flapenguin.me/elf-dt-hash</a></p>
<h3 id="dynsym"><a href="#dynsym" class="headerlink" title=".dynsym"></a>.dynsym</h3><p>This section holds the dynamic linking symbol table</p>
<p>The <code>.dynsym</code> section of an ELF file consists of fixed-length records, either of type <code>Elf32_Sym</code> or <code>Elf64_Sym</code>, depending on the architecture. These records are unable to directly contain the symbol names due to their variable length nature. Instead, they include an offset within the <code>.dynstr</code> section (in the <code>.st_name</code> field), where the actual symbol name is located. Therefore, it is incorrect to say that <code>.dynsym</code> directly contains symbol names like “<a href="mailto:&#x73;&#101;&#116;&#115;&#x6f;&#99;&#x6b;&#111;&#112;&#116;&#x40;&#71;&#76;&#73;&#x42;&#x43;&#95;&#x32;&#x2e;&#x30;">&#x73;&#101;&#116;&#115;&#x6f;&#99;&#x6b;&#111;&#112;&#116;&#x40;&#71;&#76;&#73;&#x42;&#x43;&#95;&#x32;&#x2e;&#x30;</a>.” It accurately contains an <code>Elf32_Sym</code> or <code>Elf64_Sym</code> entry for an imported symbol such as <code>setsockopt</code>, which refers to the symbol name’s offset in the <code>.dynstr</code> section.</p>
<h3 id="dynstr"><a href="#dynstr" class="headerlink" title=".dynstr"></a>.dynstr</h3><p>This section holds strings needed for dynamic linking</p>
<h3 id="init"><a href="#init" class="headerlink" title=".init"></a>.init</h3><p>This section holds executable instructions that contribute to the process initialization code. When a program starts to run, the system executes the code in this section before calling the main program entry point (called main for C programs).</p>
<h3 id="fini"><a href="#fini" class="headerlink" title=".fini"></a>.fini</h3><p>This section holds executable instructions that contribute to the process termination code. When a program exits normally, the system executes the code in this section.</p>
<h1 id="Segment"><a href="#Segment" class="headerlink" title="Segment"></a>Segment</h1><p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240222200546.png" alt="image.png"></p>
<p>One ore more sections will be put inside a single segment by the linker.</p>
<p>segments, which are used at execution time (as opposed to sections, which are used at link time). Contains information about how each segment should be loaded into memory by the OS, notably location and permissions.</p>
<p>segment: exists after linking, in the executable file.</p>
<blockquote>
<p>The program header table provides a segment view of the binary, as opposed to<br>the section view provided by the section header table. The section view of an<br>ELF binary, which I discussed earlier, is meant for static linking purposes<br>only. In contrast, the segment view, which I’ll discuss next, is used by the<br>operating system and dynamic linker when loading an ELF into a process for<br>execution to locate the relevant code and data and decide what to load into<br>virtual memory.</p>
</blockquote>
<p>由 <code>program header table</code> 定义 segments。由于 segment 提供运行时视角，因此只有可执行目标文件才有这个，不可执行的目标文件没有。</p>
<h2 id="Program-Header-Table"><a href="#Program-Header-Table" class="headerlink" title="Program Header Table"></a>Program Header Table</h2><p>Only appears in the executable. Contains information of how the executable should be put into the process virtual memory.</p>
<p>The executable is generated from object files by the linker. The main jobs that the linker does are:</p>
<ul>
<li>determine which sections of the object files will go into which segments of the executable.<br>  In Binutils, this comes down to parsing a linker script, and dealing with a bunch of defaults. You can get the linker script used with <code>ld --verbose</code>, and set a custom one with <code>ld -T</code>.</li>
<li>do relocation according to the <code>.rela.text</code> section. This depends on how the multiple sections are put into memory.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word	p_type;			<span class="comment">/* Segment type */</span></span><br><span class="line">  Elf64_Word	p_flags;		<span class="comment">/* Segment flags */</span></span><br><span class="line">  Elf64_Off	p_offset;		<span class="comment">/* Segment file offset */</span></span><br><span class="line">  Elf64_Addr	p_vaddr;		<span class="comment">/* Segment virtual address */</span></span><br><span class="line">  Elf64_Addr	p_paddr;		<span class="comment">/* Segment physical address */</span></span><br><span class="line">  Elf64_Xword	p_filesz;		<span class="comment">/* Segment size in file */</span></span><br><span class="line">  Elf64_Xword	p_memsz;		<span class="comment">/* Segment size in memory */</span></span><br><span class="line">  Elf64_Xword	p_align;		<span class="comment">/* Segment alignment */</span></span><br><span class="line">&#125; Elf64_Phdr;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/demo$ readelf -l hello_world.out </span><br><span class="line"></span><br><span class="line">Elf file type is EXEC (Executable file)</span><br><span class="line">Entry point 0x4000b0</span><br><span class="line">There are 2 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000</span><br><span class="line">                 0x00000000000000d7 0x00000000000000d7  R E    0x1000</span><br><span class="line">  LOAD           0x00000000000000d7 0x00000000004010d7 0x00000000004010d7</span><br><span class="line">                 0x000000000000000e 0x000000000000000e  RW     0x1000</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .text </span><br><span class="line">   01     .data </span><br></pre></td></tr></table></figure>

<h3 id="p-type"><a href="#p-type" class="headerlink" title="p_type"></a>p_type</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># /usr/include/elf.h</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Legal values for p_type (segment type).  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    PT_NULL        0        <span class="comment">/* Program header table entry unused */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOAD        1        <span class="comment">/* Loadable program segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_DYNAMIC    2        <span class="comment">/* Dynamic linking information */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_INTERP    3        <span class="comment">/* Program interpreter */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_NOTE        4        <span class="comment">/* Auxiliary information */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_SHLIB    5        <span class="comment">/* Reserved */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_PHDR        6        <span class="comment">/* Entry for header table itself */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_TLS        7        <span class="comment">/* Thread-local storage segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    PT_NUM        8        <span class="comment">/* Number of defined types */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOOS        0x60000000    <span class="comment">/* Start of OS-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_GNU_EH_FRAME    0x6474e550    <span class="comment">/* GCC .eh_frame_hdr segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_GNU_STACK    0x6474e551    <span class="comment">/* Indicates stack executability */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_GNU_RELRO    0x6474e552    <span class="comment">/* Read-only after relocation */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOSUNW    0x6ffffffa</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_SUNWBSS    0x6ffffffa    <span class="comment">/* Sun Specific segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_SUNWSTACK    0x6ffffffb    <span class="comment">/* Stack segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_HISUNW    0x6fffffff</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_HIOS        0x6fffffff    <span class="comment">/* End of OS-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOPROC    0x70000000    <span class="comment">/* Start of processor-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_HIPROC    0x7fffffff    <span class="comment">/* End of processor-specific */</span></span></span><br></pre></td></tr></table></figure>

<h4 id="PT-PHDR"><a href="#PT-PHDR" class="headerlink" title="PT_PHDR"></a>PT_PHDR</h4><blockquote>
<p>PT_PHDR segment, which encompasses the program header table.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000400040 0x0000000000400040 0x000268 0x000268 R   0x8</span><br><span class="line"></span><br><span class="line">Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br></pre></td></tr></table></figure>

<h4 id="PT-LOAD"><a href="#PT-LOAD" class="headerlink" title="PT_LOAD"></a>PT_LOAD</h4><blockquote>
<p>Segments of type PT_LOAD, as the name implies, are intended to be loaded<br>into memory when setting up the process. The size of the loadable chunk<br>and the address to load it at are described in the rest of the program header.<br>As you can see in the readelf output, there are usually at least two PT_LOAD<br>segments—one encompassing the nonwritable sections and one containing<br>the writable data sections.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000400040 0x0000000000400040 0x000268 0x000268 R   0x8</span><br><span class="line">  INTERP         0x0002a8 0x00000000004002a8 0x00000000004002a8 0x00001c 0x00001c R   0x1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line">  LOAD           0x000000 0x0000000000400000 0x0000000000400000 0x000400 0x000400 R   0x1000</span><br><span class="line">  LOAD           0x001000 0x0000000000401000 0x0000000000401000 0x0001d5 0x0001d5 R E 0x1000</span><br><span class="line">  LOAD           0x002000 0x0000000000402000 0x0000000000402000 0x0000d0 0x0000d0 R   0x1000</span><br><span class="line">  LOAD           0x002e50 0x0000000000403e50 0x0000000000403e50 0x0001d8 0x0001e0 RW  0x1000</span><br><span class="line">  DYNAMIC        0x002e60 0x0000000000403e60 0x0000000000403e60 0x000190 0x000190 RW  0x8</span><br><span class="line">  NOTE           0x0002c4 0x00000000004002c4 0x00000000004002c4 0x000044 0x000044 R   0x4</span><br><span class="line">  GNU_EH_FRAME   0x002004 0x0000000000402004 0x0000000000402004 0x00002c 0x00002c R   0x4</span><br><span class="line">  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RWE 0x10</span><br><span class="line">  GNU_RELRO      0x002e50 0x0000000000403e50 0x0000000000403e50 0x0001b0 0x0001b0 R   0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br><span class="line">   01     .interp </span><br><span class="line">   02     .interp .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn </span><br><span class="line">   03     .init .text .fini </span><br><span class="line">   04     .rodata .eh_frame_hdr .eh_frame </span><br><span class="line">   05     .init_array .fini_array .dynamic .got .got.plt .data .bss </span><br><span class="line">   06     .dynamic </span><br><span class="line">   07     .note.gnu.build-id .note.ABI-tag </span><br><span class="line">   08     .eh_frame_hdr </span><br><span class="line">   09     </span><br><span class="line">   10     .init_array .fini_array .dynamic .got </span><br></pre></td></tr></table></figure>

<h4 id="PT-DYNAMIC"><a href="#PT-DYNAMIC" class="headerlink" title="PT_DYNAMIC"></a>PT_DYNAMIC</h4><p><code>PT_DYNAMIC</code> segment contains the <code>.dynamic</code> section, which tells the interpreter how to parse and prepare the binary for execution. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:/home/cpp/build/self_mutate$ readelf --wide --segments demo</span><br><span class="line"></span><br><span class="line">Elf file type is EXEC (Executable file)</span><br><span class="line">Entry point 0x401020</span><br><span class="line">There are 11 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000400040 0x0000000000400040 0x000268 0x000268 R   0x8       0</span><br><span class="line">  INTERP         0x0002a8 0x00000000004002a8 0x00000000004002a8 0x00001c 0x00001c R   0x1       1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line">  LOAD           0x000000 0x0000000000400000 0x0000000000400000 0x000400 0x000400 R   0x1000    2</span><br><span class="line">  LOAD           0x001000 0x0000000000401000 0x0000000000401000 0x0001d5 0x0001d5 R E 0x1000    3</span><br><span class="line">  LOAD           0x002000 0x0000000000402000 0x0000000000402000 0x0000d0 0x0000d0 R   0x1000    4</span><br><span class="line">  LOAD           0x002e50 0x0000000000403e50 0x0000000000403e50 0x0001d8 0x0001e0 RW  0x1000    5</span><br><span class="line"></span><br><span class="line">  DYNAMIC        0x002e60 0x0000000000403e60 0x0000000000403e60 0x000190 0x000190 RW  0x8       6</span><br><span class="line"></span><br><span class="line">  NOTE           0x0002c4 0x00000000004002c4 0x00000000004002c4 0x000044 0x000044 R   0x4</span><br><span class="line">  GNU_EH_FRAME   0x002004 0x0000000000402004 0x0000000000402004 0x00002c 0x00002c R   0x4</span><br><span class="line">  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RWE 0x10</span><br><span class="line">  GNU_RELRO      0x002e50 0x0000000000403e50 0x0000000000403e50 0x0001b0 0x0001b0 R   0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br><span class="line">   01     .interp </span><br><span class="line">   02     .interp .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn </span><br><span class="line">   03     .init .text .fini </span><br><span class="line">   04     .rodata .eh_frame_hdr .eh_frame </span><br><span class="line">   05     .init_array .fini_array .dynamic .got .got.plt .data .bss </span><br><span class="line"></span><br><span class="line">   06     .dynamic </span><br><span class="line"></span><br><span class="line">   07     .note.gnu.build-id .note.ABI-tag </span><br><span class="line">   08     .eh_frame_hdr </span><br><span class="line">   09     </span><br><span class="line">   10     .init_array .fini_array .dynamic .got </span><br></pre></td></tr></table></figure>

<h4 id="PT-INTERP"><a href="#PT-INTERP" class="headerlink" title="PT_INTERP"></a>PT_INTERP</h4><p>The PT_INTERP segment contains the .interp section, which provides the name of the interpreter that is to be used to load the binary.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000400040 0x0000000000400040 0x000268 0x000268 R   0x8</span><br><span class="line">  INTERP         0x0002a8 0x00000000004002a8 0x00000000004002a8 0x00001c 0x00001c R   0x1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br><span class="line">   01     .interp </span><br></pre></td></tr></table></figure>

<h3 id="p-flag"><a href="#p-flag" class="headerlink" title="p_flag"></a>p_flag</h3><p>The flags specify the runtime access permissions for the segment.</p>
<h4 id="PF-X"><a href="#PF-X" class="headerlink" title="PF_X"></a>PF_X</h4><p>The PF_X flag indicates that the segment is executable and is set for code segments (readelf displays it as an E rather than an X in the Flg column</p>
<h4 id="PF-W"><a href="#PF-W" class="headerlink" title="PF_W"></a>PF_W</h4><p>The PF_W flag means that the segment is writable, and it is normally set only for writable data segments, never for code segments.</p>
<h4 id="PF-R"><a href="#PF-R" class="headerlink" title="PF_R"></a>PF_R</h4><p>PF_R means that the segment is readable, as is normally the case for both code and data segments.</p>
<h3 id="p-offset-p-vaddr-and-p-filesz"><a href="#p-offset-p-vaddr-and-p-filesz" class="headerlink" title="p_offset, p_vaddr, and p_filesz"></a>p_offset, p_vaddr, and p_filesz</h3><p>They specify the file offset at which the segment starts, the virtual address at which it is to be loaded, and the file size of the segment, respectively. </p>
<h3 id="p-paddr"><a href="#p-paddr" class="headerlink" title="p_paddr"></a>p_paddr</h3><p>On modern operating systems such as Linux, this field is unused and set to zero since they execute all binaries in virtual memory.</p>
<h3 id="p-memsz"><a href="#p-memsz" class="headerlink" title="p_memsz"></a>p_memsz</h3><p><code>p_filesz</code> is the file size of the segment and <code>p_memsz</code> is the size in memory. To understand this, recall that some sections only indicate the need to allocate some bytes in memory but don’t actually occupy these bytes in the binary file. For instance, the <code>.bss</code> section contains zero-initialized data. Since all data in this section is known to be zero anyway, there’s no need to actually include all these zeros in the binary. However, when loading the segment containing <code>.bss</code> into virtual memory, all the bytes in <code>.bss</code> should be allocated. Thus, it’s possible for <code>p_memsz</code> to be larger than <code>p_filesz</code>. When this happens, the loader adds the extra bytes at the end of the segment when loading the binary and initializes them to zero.</p>
<h3 id="p-align"><a href="#p-align" class="headerlink" title="p_align"></a>p_align</h3><p>It indicates the required memory alignment (in bytes) for the segment. An alignment value of 0 or 1 indicates that no particular alignment is required. If <code>p_align</code> isn’t set to 0 or 1, then its value must be a power of 2, and <code>p_vaddr</code> must be equal to <code>p_offset</code>, modulo p_align.</p>
<h1 id="Hash-Table"><a href="#Hash-Table" class="headerlink" title="Hash Table"></a>Hash Table</h1><p><a target="_blank" rel="noopener" href="https://flapenguin.me/elf-dt-hash">https://flapenguin.me/elf-dt-hash</a></p>
<h1 id="Dynamic-Linking"><a href="#Dynamic-Linking" class="headerlink" title="Dynamic Linking"></a>Dynamic Linking</h1><p>The information for dynamic linking is provided in the .dynsym, .dynstr, .interp, .hash, .dynamic, .rel, .rela, .got and.plt sections.</p>
<h1 id="Relocation"><a href="#Relocation" class="headerlink" title="Relocation"></a>Relocation</h1><p>主要参考这篇文章：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/">Position Independent Code (PIC) in shared libraries - Eli Bendersky’s website</a></p>
</blockquote>
<blockquote>
<p>Relocation is the process of connecting symbolic references with symbolic definitions. For<br>example, when a program calls a function, the associated call instruction must transfer control<br>to the proper destination address at execution. In other words, relocatable files must have<br>information that describes how to modify their section contents, thus allowing executable and<br>shared object files to hold the right information for a process’s program image. Relocation<br>entries are these data.</p>
</blockquote>
<p>Transform a relocatable file into either an executable or a shared object file. The link editor merges one or more relocatable files to form the output. It first decides how to combine and locate the input files, then updates the symbol values, and finally performs the relocation. Relocations applied to executable or shared object files are similar and accomplish the same result.</p>
<p><em>relocations</em> are entries in binaries that are left to be filled in later – at link time by the toolchain linker or at runtime by the dynamic linker.</p>
<blockquote>
<p>Briefly, when the linker creates a shared library, it doesn’t know in advance where it might be loaded.</p>
<p>There are two main approaches to solve this problem in Linux ELF shared libraries:</p>
<ol>
<li>Load-time relocation</li>
<li>Position independent code (PIC)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/">Position Independent Code (PIC) in shared libraries - Eli Bendersky’s website</a></p>
</blockquote>
<h2 id="Static-Relocation"><a href="#Static-Relocation" class="headerlink" title="Static Relocation"></a>Static Relocation</h2><p>静态链接器</p>
<h2 id="Dynamic-Relocation"><a href="#Dynamic-Relocation" class="headerlink" title="Dynamic Relocation"></a>Dynamic Relocation</h2><p>动态链接器 <code>/lib/ld-linux.so</code> 重定位程序对共享库中符号的引用的过程。</p>
<h3 id="PIC-Variable"><a href="#PIC-Variable" class="headerlink" title="PIC Variable"></a>PIC Variable</h3><p>单独由 <code>.got</code> section实现。</p>
<h4 id="Example-PIC变量"><a href="#Example-PIC变量" class="headerlink" title="Example - PIC变量"></a>Example - PIC变量</h4><p>读取动态库中的全局变量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dataonly.h</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> myglob;</span><br><span class="line"><span class="type">int</span> <span class="title function_">ml_func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dataonly.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ml_func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> myglob + a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;dataonly.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    ml_func(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -fpic -shared -m32 -o libmlpic_dataonly.so dataonly.c</span><br><span class="line">gcc -m32 -o dataonlymain dataonlymain.c -L. -lmlpic_dataonly -g</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:. gdb dataonlymain</span></span><br><span class="line">(gdb) b ml_func</span><br></pre></td></tr></table></figure>

<p>从 .got 中取得 myglob 的绝对地址，.got中的绝对地址是 ld-linux.so 将 libmlpic_dataonly.so 加载后立刻解析出填充的。</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102847.png"></p>
<p>.got 是静态链接器和动态连接器协商的结果，静态链接器将所有对 myglob 的访问都改成从.got取绝对地址，动态链接器加载动态库时，填充对应的绝对地址。</p>
<h3 id="PIC-Function-Lazy-Binding"><a href="#PIC-Function-Lazy-Binding" class="headerlink" title="PIC Function (Lazy Binding)"></a>PIC Function (Lazy Binding)</h3><p>PIC函数符号的绝对地址不是像PIC变量一样直接填充到<code>.got</code>，而是通过 lazy binding 实现，又多绕一层。首先，动态库中函数比全局变量多，开销更大；其次，有很多动态库函数，比如处理错误的，有可能在运行时根本不会调用到。为优化效率，PIC函数借助PLT实现lazy binding。</p>
<blockquote>
<p>When a shared library refers to some function, the real address of that function is not known until load time. Resolving this address is called <em>binding</em>, and it’s something the dynamic loader does when it loads the shared library into the process’s memory space. This binding process is non-trivial, since the loader has to actually <em>look up</em> the function symbol in special tables <a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/#id13">[5]</a>.</p>
<p>So, resolving each function takes time. Not a lot of time, but it adds up since the amount of functions in libraries is typically much larger than the amount of global variables. Moreover, most of these resolutions are done in vain, because in a typical run of a program only a fraction of functions actually get called (think about various functions handling error and special conditions, which typically don’t get called at all).</p>
<p>So, to speed up this process, a clever lazy binding scheme was devised. “Lazy” is a generic name for a family of optimizations in computer programming, where work is delayed until the last moment when it’s actually needed, with the intention of avoiding doing this work if its results are never required during a specific run of a program. Good examples of laziness are <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Copy-on-write">copy-on-write</a> and <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Lazy_evaluation">lazy evaluation</a>.</p>
</blockquote>
<p>由<code>.plt</code> + <code>.got.plt</code> 两个section配合实现。</p>
<p>函数首次调用时：</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102952.png" alt="image.png"></p>
<p>上图的 GOT 是 <code>.got.plt</code></p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220103009.png" alt="image.png"></p>
<p>后续的函数调用：</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220103030.png" alt="image.png"></p>
<h4 id="Example-PIC函数"><a href="#Example-PIC函数" class="headerlink" title="Example - PIC函数"></a>Example - PIC函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ml_util_func</span><span class="params">(<span class="type">int</span> a)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ml_func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dynamic linker 听好了，你找到 ml_util_func 的绝对地址后，给我写入 0x2008 这个地址。</p>
<blockquote>
<p>The last line means that the dynamic loader should place the value (address) of symbol ml_util_func into 0x2008 (which, recall, is the GOT entry for this function).</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">readelf -r libmlpic.so</span></span><br><span class="line">[...] snip output</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.plt&#x27; at offset 0x328 contains 3 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00002000  00000107 R_386_JUMP_SLOT   00000000   __cxa_finalize</span><br><span class="line">00002004  00000207 R_386_JUMP_SLOT   00000000   __gmon_start__</span><br><span class="line">00002008  00000707 R_386_JUMP_SLOT   0000046c   ml_util_func</span><br></pre></td></tr></table></figure>





<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://refspecs.linuxbase.org/elf/elf.pdf">ELF标准定义文档</a></p>
</li>
<li><p>动态链接详解 - 你说起一个什么名的文章 - 知乎<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/263094043">https://zhuanlan.zhihu.com/p/263094043</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gnuemacs/p/14523720.html">https://www.cnblogs.com/gnuemacs/p/14523720.html</a></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/21/note/linux/ld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/21/note/linux/ld/" class="post-title-link" itemprop="url">Linux ld</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-21 10:14:08" itemprop="dateCreated datePublished" datetime="2024-02-21T10:14:08+08:00">2024-02-21</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>19 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://sourceware.org/binutils/docs/ld/index.html">LD用户手册</a></p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240221073200.png" alt="image.png"></p>
<h1 id="Linker-Script"><a href="#Linker-Script" class="headerlink" title="Linker Script"></a>Linker Script</h1><p>主要作用是描述源目标文件的section怎么在最终生成的文件中排布。</p>
<p>linker script是必需的，如果没指明，则用默认的。</p>
<p>怎么查看默认的linker script？<br>文档中说用 <code>ld --verbose</code>，但ubuntu-20.04 wsl执行后报错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ld --verbose</span><br><span class="line">ld: fatal error: no input files</span><br></pre></td></tr></table></figure>

<p>用GDB跟下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  <span class="built_in">gldelf_x86_64_get_script</span> (isfile=<span class="number">0x7fffffffdfb4</span>) at eelf_x86_64.c:<span class="number">158</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x0000555555589ec9</span> <span class="function">in <span class="title">main</span> <span class="params">(argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;)</span> at ./ldmain.c:<span class="number">402</span></span></span><br></pre></td></tr></table></figure>

<p>发现linker script是由 <code>ld/genscripts.sh</code> 生成，截取<code>genscripts.sh</code>中的片段如下（针对某个cpu架构，有多个链接脚本可选，根据链接器所传参数使用对应的链接脚本。这里只关注链接可执行文件时用到的x后缀脚本，即 <code>elf_x86_64.x</code>）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DATA_ALIGNMENT=<span class="variable">$&#123;DATA_ALIGNMENT_&#125;</span></span><br><span class="line">RELOCATING=<span class="string">&quot; &quot;</span></span><br><span class="line">LD_FLAG=</span><br><span class="line">( <span class="built_in">echo</span> <span class="string">&quot;/* Default linker script, for normal executables */&quot;</span></span><br><span class="line">  source_sh <span class="variable">$&#123;CUSTOMIZER_SCRIPT&#125;</span></span><br><span class="line">  source_sh <span class="variable">$&#123;srcdir&#125;</span>/scripttempl/<span class="variable">$&#123;SCRIPT_NAME&#125;</span>.sc</span><br><span class="line">) | sed -e <span class="string">&#x27;/^ *$/d;s/[	 ]*$//&#x27;</span> &gt; ldscripts/<span class="variable">$&#123;EMULATION_NAME&#125;</span>.x</span><br><span class="line"></span><br><span class="line">LD_FLAG=textonly</span><br><span class="line">( <span class="built_in">echo</span> <span class="string">&quot;/* Script for -z separate-code */&quot;</span></span><br><span class="line">  source_sh <span class="variable">$&#123;CUSTOMIZER_SCRIPT&#125;</span></span><br><span class="line">  source_sh <span class="variable">$&#123;srcdir&#125;</span>/scripttempl/<span class="variable">$&#123;SCRIPT_NAME&#125;</span>.sc</span><br><span class="line">) | sed -e <span class="string">&#x27;/^ *$/d;s/[	 ]*$//&#x27;</span> &gt; ldscripts/<span class="variable">$&#123;EMULATION_NAME&#125;</span>.xe</span><br></pre></td></tr></table></figure>

<p>在 Ubuntu-20.04 中，这些linker scripts放在 <code>/lib/x86_64-linux-gnu/ldscripts/</code> 下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ll /lib/x86_64-linux-gnu/ldscripts/elf_x86_64.x</span><br><span class="line">elf_x86_64.x     elf_x86_64.xce   elf_x86_64.xdce  elf_x86_64.xdwe  elf_x86_64.xr    elf_x86_64.xsce  elf_x86_64.xswe  elf_x86_64.xwe   </span><br><span class="line">elf_x86_64.xbn   elf_x86_64.xd    elf_x86_64.xde   elf_x86_64.xe    elf_x86_64.xs    elf_x86_64.xse   elf_x86_64.xu    </span><br><span class="line">elf_x86_64.xc    elf_x86_64.xdc   elf_x86_64.xdw   elf_x86_64.xn    elf_x86_64.xsc   elf_x86_64.xsw   elf_x86_64.xw  </span><br></pre></td></tr></table></figure>

<p>当前ld版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ld --version</span><br><span class="line">GNU gold (GNU Binutils <span class="keyword">for</span> Ubuntu 2.34) 1.16</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">This program is free software; you may redistribute it under the terms of</span><br><span class="line">the GNU General Public License version 3 or (at your option) a later version.</span><br><span class="line">This program has absolutely no warranty.</span><br></pre></td></tr></table></figure>

<p>可执行文件默认的链接脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line">/* Default linker script, for normal executables */</span><br><span class="line">/* Copyright (C) 2014-2020 Free Software Foundation, Inc.</span><br><span class="line">   Copying and distribution of this script, with or without modification,</span><br><span class="line">   are permitted in any medium without royalty provided the copyright</span><br><span class="line">   notice and this notice are preserved.  */</span><br><span class="line">OUTPUT_FORMAT(&quot;elf64-x86-64&quot;, &quot;elf64-x86-64&quot;,</span><br><span class="line">	      &quot;elf64-x86-64&quot;)</span><br><span class="line">OUTPUT_ARCH(i386:x86-64)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">SEARCH_DIR(&quot;=/usr/local/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/usr/lib/x86_64-linux-gnu&quot;); SEARCH_DIR(&quot;=/usr/lib/x86_64-linux-gnu64&quot;); SEARCH_DIR(&quot;=/usr/local/lib64&quot;); SEARCH_DIR(&quot;=/lib64&quot;); SEARCH_DIR(&quot;=/usr/lib64&quot;); SEARCH_DIR(&quot;=/usr/local/lib&quot;); SEARCH_DIR(&quot;=/lib&quot;); SEARCH_DIR(&quot;=/usr/lib&quot;); SEARCH_DIR(&quot;=/usr/x86_64-linux-gnu/lib64&quot;); SEARCH_DIR(&quot;=/usr/x86_64-linux-gnu/lib&quot;);</span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">  /* Read-only sections, merged into text segment: */</span><br><span class="line">  PROVIDE (__executable_start = SEGMENT_START(&quot;text-segment&quot;, 0x400000)); . = SEGMENT_START(&quot;text-segment&quot;, 0x400000) + SIZEOF_HEADERS;</span><br><span class="line">  .interp         : &#123; *(.interp) &#125;</span><br><span class="line">  .note.gnu.build-id  : &#123; *(.note.gnu.build-id) &#125;</span><br><span class="line">  .hash           : &#123; *(.hash) &#125;</span><br><span class="line">  .gnu.hash       : &#123; *(.gnu.hash) &#125;</span><br><span class="line">  .dynsym         : &#123; *(.dynsym) &#125;</span><br><span class="line">  .dynstr         : &#123; *(.dynstr) &#125;</span><br><span class="line">  .gnu.version    : &#123; *(.gnu.version) &#125;</span><br><span class="line">  .gnu.version_d  : &#123; *(.gnu.version_d) &#125;</span><br><span class="line">  .gnu.version_r  : &#123; *(.gnu.version_r) &#125;</span><br><span class="line">  .rela.init      : &#123; *(.rela.init) &#125;</span><br><span class="line">  .rela.text      : &#123; *(.rela.text .rela.text.* .rela.gnu.linkonce.t.*) &#125;</span><br><span class="line">  .rela.fini      : &#123; *(.rela.fini) &#125;</span><br><span class="line">  .rela.rodata    : &#123; *(.rela.rodata .rela.rodata.* .rela.gnu.linkonce.r.*) &#125;</span><br><span class="line">  .rela.data.rel.ro   : &#123; *(.rela.data.rel.ro .rela.data.rel.ro.* .rela.gnu.linkonce.d.rel.ro.*) &#125;</span><br><span class="line">  .rela.data      : &#123; *(.rela.data .rela.data.* .rela.gnu.linkonce.d.*) &#125;</span><br><span class="line">  .rela.tdata	  : &#123; *(.rela.tdata .rela.tdata.* .rela.gnu.linkonce.td.*) &#125;</span><br><span class="line">  .rela.tbss	  : &#123; *(.rela.tbss .rela.tbss.* .rela.gnu.linkonce.tb.*) &#125;</span><br><span class="line">  .rela.ctors     : &#123; *(.rela.ctors) &#125;</span><br><span class="line">  .rela.dtors     : &#123; *(.rela.dtors) &#125;</span><br><span class="line">  .rela.got       : &#123; *(.rela.got) &#125;</span><br><span class="line">  .rela.bss       : &#123; *(.rela.bss .rela.bss.* .rela.gnu.linkonce.b.*) &#125;</span><br><span class="line">  .rela.ldata     : &#123; *(.rela.ldata .rela.ldata.* .rela.gnu.linkonce.l.*) &#125;</span><br><span class="line">  .rela.lbss      : &#123; *(.rela.lbss .rela.lbss.* .rela.gnu.linkonce.lb.*) &#125;</span><br><span class="line">  .rela.lrodata   : &#123; *(.rela.lrodata .rela.lrodata.* .rela.gnu.linkonce.lr.*) &#125;</span><br><span class="line">  .rela.ifunc     : &#123; *(.rela.ifunc) &#125;</span><br><span class="line">  .rela.plt       :</span><br><span class="line">    &#123;</span><br><span class="line">      *(.rela.plt)</span><br><span class="line">      PROVIDE_HIDDEN (__rela_iplt_start = .);</span><br><span class="line">      *(.rela.iplt)</span><br><span class="line">      PROVIDE_HIDDEN (__rela_iplt_end = .);</span><br><span class="line">    &#125;</span><br><span class="line">  .init           :</span><br><span class="line">  &#123;</span><br><span class="line">    KEEP (*(SORT_NONE(.init)))</span><br><span class="line">  &#125;</span><br><span class="line">  .plt            : &#123; *(.plt) *(.iplt) &#125;</span><br><span class="line">.plt.got        : &#123; *(.plt.got) &#125;</span><br><span class="line">.plt.sec        : &#123; *(.plt.sec) &#125;</span><br><span class="line">  .text           :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.text.unlikely .text.*_unlikely .text.unlikely.*)</span><br><span class="line">    *(.text.exit .text.exit.*)</span><br><span class="line">    *(.text.startup .text.startup.*)</span><br><span class="line">    *(.text.hot .text.hot.*)</span><br><span class="line">    *(SORT(.text.sorted.*))</span><br><span class="line">    *(.text .stub .text.* .gnu.linkonce.t.*)</span><br><span class="line">    /* .gnu.warning sections are handled specially by elf.em.  */</span><br><span class="line">    *(.gnu.warning)</span><br><span class="line">  &#125;</span><br><span class="line">  .fini           :</span><br><span class="line">  &#123;</span><br><span class="line">    KEEP (*(SORT_NONE(.fini)))</span><br><span class="line">  &#125;</span><br><span class="line">  PROVIDE (__etext = .);</span><br><span class="line">  PROVIDE (_etext = .);</span><br><span class="line">  PROVIDE (etext = .);</span><br><span class="line">  .rodata         : &#123; *(.rodata .rodata.* .gnu.linkonce.r.*) &#125;</span><br><span class="line">  .rodata1        : &#123; *(.rodata1) &#125;</span><br><span class="line">  .eh_frame_hdr   : &#123; *(.eh_frame_hdr) *(.eh_frame_entry .eh_frame_entry.*) &#125;</span><br><span class="line">  .eh_frame       : ONLY_IF_RO &#123; KEEP (*(.eh_frame)) *(.eh_frame.*) &#125;</span><br><span class="line">  .gcc_except_table   : ONLY_IF_RO &#123; *(.gcc_except_table .gcc_except_table.*) &#125;</span><br><span class="line">  .gnu_extab   : ONLY_IF_RO &#123; *(.gnu_extab*) &#125;</span><br><span class="line">  /* These sections are generated by the Sun/Oracle C++ compiler.  */</span><br><span class="line">  .exception_ranges   : ONLY_IF_RO &#123; *(.exception_ranges*) &#125;</span><br><span class="line">  /* Adjust the address for the data segment.  We want to adjust up to</span><br><span class="line">     the same address within the page on the next page up.  */</span><br><span class="line">  . = DATA_SEGMENT_ALIGN (CONSTANT (MAXPAGESIZE), CONSTANT (COMMONPAGESIZE));</span><br><span class="line">  /* Exception handling  */</span><br><span class="line">  .eh_frame       : ONLY_IF_RW &#123; KEEP (*(.eh_frame)) *(.eh_frame.*) &#125;</span><br><span class="line">  .gnu_extab      : ONLY_IF_RW &#123; *(.gnu_extab) &#125;</span><br><span class="line">  .gcc_except_table   : ONLY_IF_RW &#123; *(.gcc_except_table .gcc_except_table.*) &#125;</span><br><span class="line">  .exception_ranges   : ONLY_IF_RW &#123; *(.exception_ranges*) &#125;</span><br><span class="line">  /* Thread Local Storage sections  */</span><br><span class="line">  .tdata	  :</span><br><span class="line">   &#123;</span><br><span class="line">     PROVIDE_HIDDEN (__tdata_start = .);</span><br><span class="line">     *(.tdata .tdata.* .gnu.linkonce.td.*)</span><br><span class="line">   &#125;</span><br><span class="line">  .tbss		  : &#123; *(.tbss .tbss.* .gnu.linkonce.tb.*) *(.tcommon) &#125;</span><br><span class="line">  .preinit_array    :</span><br><span class="line">  &#123;</span><br><span class="line">    PROVIDE_HIDDEN (__preinit_array_start = .);</span><br><span class="line">    KEEP (*(.preinit_array))</span><br><span class="line">    PROVIDE_HIDDEN (__preinit_array_end = .);</span><br><span class="line">  &#125;</span><br><span class="line">  .init_array    :</span><br><span class="line">  &#123;</span><br><span class="line">    PROVIDE_HIDDEN (__init_array_start = .);</span><br><span class="line">    KEEP (*(SORT_BY_INIT_PRIORITY(.init_array.*) SORT_BY_INIT_PRIORITY(.ctors.*)))</span><br><span class="line">    KEEP (*(.init_array EXCLUDE_FILE (*crtbegin.o *crtbegin?.o *crtend.o *crtend?.o ) .ctors))</span><br><span class="line">    PROVIDE_HIDDEN (__init_array_end = .);</span><br><span class="line">  &#125;</span><br><span class="line">  .fini_array    :</span><br><span class="line">  &#123;</span><br><span class="line">    PROVIDE_HIDDEN (__fini_array_start = .);</span><br><span class="line">    KEEP (*(SORT_BY_INIT_PRIORITY(.fini_array.*) SORT_BY_INIT_PRIORITY(.dtors.*)))</span><br><span class="line">    KEEP (*(.fini_array EXCLUDE_FILE (*crtbegin.o *crtbegin?.o *crtend.o *crtend?.o ) .dtors))</span><br><span class="line">    PROVIDE_HIDDEN (__fini_array_end = .);</span><br><span class="line">  &#125;</span><br><span class="line">  .ctors          :</span><br><span class="line">  &#123;</span><br><span class="line">    /* gcc uses crtbegin.o to find the start of</span><br><span class="line">       the constructors, so we make sure it is</span><br><span class="line">       first.  Because this is a wildcard, it</span><br><span class="line">       doesn&#x27;t matter if the user does not</span><br><span class="line">       actually link against crtbegin.o; the</span><br><span class="line">       linker won&#x27;t look for a file to match a</span><br><span class="line">       wildcard.  The wildcard also means that it</span><br><span class="line">       doesn&#x27;t matter which directory crtbegin.o</span><br><span class="line">       is in.  */</span><br><span class="line">    KEEP (*crtbegin.o(.ctors))</span><br><span class="line">    KEEP (*crtbegin?.o(.ctors))</span><br><span class="line">    /* We don&#x27;t want to include the .ctor section from</span><br><span class="line">       the crtend.o file until after the sorted ctors.</span><br><span class="line">       The .ctor section from the crtend file contains the</span><br><span class="line">       end of ctors marker and it must be last */</span><br><span class="line">    KEEP (*(EXCLUDE_FILE (*crtend.o *crtend?.o ) .ctors))</span><br><span class="line">    KEEP (*(SORT(.ctors.*)))</span><br><span class="line">    KEEP (*(.ctors))</span><br><span class="line">  &#125;</span><br><span class="line">  .dtors          :</span><br><span class="line">  &#123;</span><br><span class="line">    KEEP (*crtbegin.o(.dtors))</span><br><span class="line">    KEEP (*crtbegin?.o(.dtors))</span><br><span class="line">    KEEP (*(EXCLUDE_FILE (*crtend.o *crtend?.o ) .dtors))</span><br><span class="line">    KEEP (*(SORT(.dtors.*)))</span><br><span class="line">    KEEP (*(.dtors))</span><br><span class="line">  &#125;</span><br><span class="line">  .jcr            : &#123; KEEP (*(.jcr)) &#125;</span><br><span class="line">  .data.rel.ro : &#123; *(.data.rel.ro.local* .gnu.linkonce.d.rel.ro.local.*) *(.data.rel.ro .data.rel.ro.* .gnu.linkonce.d.rel.ro.*) &#125;</span><br><span class="line">  .dynamic        : &#123; *(.dynamic) &#125;</span><br><span class="line">  .got            : &#123; *(.got) *(.igot) &#125;</span><br><span class="line">  . = DATA_SEGMENT_RELRO_END (SIZEOF (.got.plt) &gt;= 24 ? 24 : 0, .);</span><br><span class="line">  .got.plt        : &#123; *(.got.plt) *(.igot.plt) &#125;</span><br><span class="line">  .data           :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.data .data.* .gnu.linkonce.d.*)</span><br><span class="line">    SORT(CONSTRUCTORS)</span><br><span class="line">  &#125;</span><br><span class="line">  .data1          : &#123; *(.data1) &#125;</span><br><span class="line">  _edata = .; PROVIDE (edata = .);</span><br><span class="line">  . = .;</span><br><span class="line">  __bss_start = .;</span><br><span class="line">  .bss            :</span><br><span class="line">  &#123;</span><br><span class="line">   *(.dynbss)</span><br><span class="line">   *(.bss .bss.* .gnu.linkonce.b.*)</span><br><span class="line">   *(COMMON)</span><br><span class="line">   /* Align here to ensure that the .bss section occupies space up to</span><br><span class="line">      _end.  Align after .bss to ensure correct alignment even if the</span><br><span class="line">      .bss section disappears because there are no input sections.</span><br><span class="line">      FIXME: Why do we need it? When there is no .bss section, we do not</span><br><span class="line">      pad the .data section.  */</span><br><span class="line">   . = ALIGN(. != 0 ? 64 / 8 : 1);</span><br><span class="line">  &#125;</span><br><span class="line">  .lbss   :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.dynlbss)</span><br><span class="line">    *(.lbss .lbss.* .gnu.linkonce.lb.*)</span><br><span class="line">    *(LARGE_COMMON)</span><br><span class="line">  &#125;</span><br><span class="line">  . = ALIGN(64 / 8);</span><br><span class="line">  . = SEGMENT_START(&quot;ldata-segment&quot;, .);</span><br><span class="line">  .lrodata   ALIGN(CONSTANT (MAXPAGESIZE)) + (. &amp; (CONSTANT (MAXPAGESIZE) - 1)) :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.lrodata .lrodata.* .gnu.linkonce.lr.*)</span><br><span class="line">  &#125;</span><br><span class="line">  .ldata   ALIGN(CONSTANT (MAXPAGESIZE)) + (. &amp; (CONSTANT (MAXPAGESIZE) - 1)) :</span><br><span class="line">  &#123;</span><br><span class="line">    *(.ldata .ldata.* .gnu.linkonce.l.*)</span><br><span class="line">    . = ALIGN(. != 0 ? 64 / 8 : 1);</span><br><span class="line">  &#125;</span><br><span class="line">  . = ALIGN(64 / 8);</span><br><span class="line">  _end = .; PROVIDE (end = .);</span><br><span class="line">  . = DATA_SEGMENT_END (.);</span><br><span class="line">  /* Stabs debugging sections.  */</span><br><span class="line">  .stab          0 : &#123; *(.stab) &#125;</span><br><span class="line">  .stabstr       0 : &#123; *(.stabstr) &#125;</span><br><span class="line">  .stab.excl     0 : &#123; *(.stab.excl) &#125;</span><br><span class="line">  .stab.exclstr  0 : &#123; *(.stab.exclstr) &#125;</span><br><span class="line">  .stab.index    0 : &#123; *(.stab.index) &#125;</span><br><span class="line">  .stab.indexstr 0 : &#123; *(.stab.indexstr) &#125;</span><br><span class="line">  .comment       0 : &#123; *(.comment) &#125;</span><br><span class="line">  .gnu.build.attributes : &#123; *(.gnu.build.attributes .gnu.build.attributes.*) &#125;</span><br><span class="line">  /* DWARF debug sections.</span><br><span class="line">     Symbols in the DWARF debugging sections are relative to the beginning</span><br><span class="line">     of the section so we begin them at 0.  */</span><br><span class="line">  /* DWARF 1 */</span><br><span class="line">  .debug          0 : &#123; *(.debug) &#125;</span><br><span class="line">  .line           0 : &#123; *(.line) &#125;</span><br><span class="line">  /* GNU DWARF 1 extensions */</span><br><span class="line">  .debug_srcinfo  0 : &#123; *(.debug_srcinfo) &#125;</span><br><span class="line">  .debug_sfnames  0 : &#123; *(.debug_sfnames) &#125;</span><br><span class="line">  /* DWARF 1.1 and DWARF 2 */</span><br><span class="line">  .debug_aranges  0 : &#123; *(.debug_aranges) &#125;</span><br><span class="line">  .debug_pubnames 0 : &#123; *(.debug_pubnames) &#125;</span><br><span class="line">  /* DWARF 2 */</span><br><span class="line">  .debug_info     0 : &#123; *(.debug_info .gnu.linkonce.wi.*) &#125;</span><br><span class="line">  .debug_abbrev   0 : &#123; *(.debug_abbrev) &#125;</span><br><span class="line">  .debug_line     0 : &#123; *(.debug_line .debug_line.* .debug_line_end) &#125;</span><br><span class="line">  .debug_frame    0 : &#123; *(.debug_frame) &#125;</span><br><span class="line">  .debug_str      0 : &#123; *(.debug_str) &#125;</span><br><span class="line">  .debug_loc      0 : &#123; *(.debug_loc) &#125;</span><br><span class="line">  .debug_macinfo  0 : &#123; *(.debug_macinfo) &#125;</span><br><span class="line">  /* SGI/MIPS DWARF 2 extensions */</span><br><span class="line">  .debug_weaknames 0 : &#123; *(.debug_weaknames) &#125;</span><br><span class="line">  .debug_funcnames 0 : &#123; *(.debug_funcnames) &#125;</span><br><span class="line">  .debug_typenames 0 : &#123; *(.debug_typenames) &#125;</span><br><span class="line">  .debug_varnames  0 : &#123; *(.debug_varnames) &#125;</span><br><span class="line">  /* DWARF 3 */</span><br><span class="line">  .debug_pubtypes 0 : &#123; *(.debug_pubtypes) &#125;</span><br><span class="line">  .debug_ranges   0 : &#123; *(.debug_ranges) &#125;</span><br><span class="line">  /* DWARF Extension.  */</span><br><span class="line">  .debug_macro    0 : &#123; *(.debug_macro) &#125;</span><br><span class="line">  .debug_addr     0 : &#123; *(.debug_addr) &#125;</span><br><span class="line">  .gnu.attributes 0 : &#123; KEEP (*(.gnu.attributes)) &#125;</span><br><span class="line">  /DISCARD/ : &#123; *(.note.GNU-stack) *(.gnu_debuglink) *(.gnu.lto_*) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Relocation-重定向"><a href="#Relocation-重定向" class="headerlink" title="Relocation 重定向"></a>Relocation 重定向</h1><blockquote>
<p>A relocation is an action which the linker must take when linking.</p>
</blockquote>
<h2 id="静态重定向"><a href="#静态重定向" class="headerlink" title="静态重定向"></a>静态重定向</h2><h2 id="动态重定向"><a href="#动态重定向" class="headerlink" title="动态重定向"></a>动态重定向</h2><p>运行时由动态链接器(ld.so)修改符号的值，用gdb可观察该行为。</p>
<p>gdb抓取动态重定向调用栈，详见：<a target="_blank" rel="noopener" href="https://stackoverflow.com/a/69490442/11850070">https://stackoverflow.com/a/69490442/11850070</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x00007ffff7fe01e0</span> in _dl_fixup (l=&lt;optimized out&gt;, reloc_arg=&lt;optimized out&gt;) at ../sysdeps/x86_64/dl-machine.h:<span class="number">242</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00007ffff7fe7c3e</span> in _dl_runtime_resolve_xsavec () at ../sysdeps/x86_64/dl-trampoline.h:<span class="number">126</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0x00000000004005a2</span> in <span class="title function_">main</span> <span class="params">()</span> at t.c:5</span><br></pre></td></tr></table></figure>

<p>符号 <code>_dl_fixup</code> 在 ld.so 中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/glibc/build/install/lib$ nm ld-2.32.so | grep _dl_fixup</span><br><span class="line">000000000000f970 t _dl_fixup</span><br></pre></td></tr></table></figure>

<p>一个 <code>link_map</code> 对应一个so？</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="http://chuquan.me/2018/06/03/linking-static-linking-dynamic-linking/#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5">http://chuquan.me/2018/06/03/linking-static-linking-dynamic-linking/#%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/21/note/linux/readelf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/21/note/linux/readelf/" class="post-title-link" itemprop="url">Linux readelf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-21 10:14:08" itemprop="dateCreated datePublished" datetime="2024-02-21T10:14:08+08:00">2024-02-21</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h1><p><code>-h</code> 打印 elf header<br><code>-l</code> 打印 program headers<br><code>-S</code> 打印 section headers<br><code>-x section_name</code> Hexdump the contents of section<br><code>-W --wide</code> 输出宽度超过80个字符也不换行</p>
<h1 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h1><h2 id="Dump-section-header-table"><a href="#Dump-section-header-table" class="headerlink" title="Dump section header table"></a>Dump section header table</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">readelf -S -W a.o</span></span><br><span class="line">There are 13 section headers, starting at offset 0x298:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .text             PROGBITS        0000000000000000 000040 000010 00  AX  0   0  1</span><br><span class="line">  [ 2] .rela.text        RELA            0000000000000000 0001f8 000018 18   I 10   1  8</span><br><span class="line">  [ 3] .data             PROGBITS        0000000000000000 000050 000000 00  WA  0   0  1</span><br><span class="line">  [ 4] .bss              NOBITS          0000000000000000 000050 000000 00  WA  0   0  1</span><br><span class="line">  [ 5] .comment          PROGBITS        0000000000000000 000050 00002c 01  MS  0   0  1</span><br><span class="line">  [ 6] .note.GNU-stack   PROGBITS        0000000000000000 00007c 000000 00      0   0  1</span><br><span class="line">  [ 7] .note.gnu.property NOTE            0000000000000000 000080 000020 00   A  0   0  8</span><br><span class="line">  [ 8] .eh_frame         PROGBITS        0000000000000000 0000a0 000038 00   A  0   0  8</span><br><span class="line">  [ 9] .rela.eh_frame    RELA            0000000000000000 000210 000018 18   I 10   8  8</span><br><span class="line">  [10] .symtab           SYMTAB          0000000000000000 0000d8 000108 18     11   9  8</span><br><span class="line">  [11] .strtab           STRTAB          0000000000000000 0001e0 000012 00      0   0  1</span><br><span class="line">  [12] .shstrtab         STRTAB          0000000000000000 000228 00006c 00      0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure>

<h2 id="Dump-content-of-a-section"><a href="#Dump-content-of-a-section" class="headerlink" title="Dump content of a section"></a>Dump content of a section</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">readelf -x .rela.text a.o</span></span><br><span class="line"></span><br><span class="line">Hex dump of section &#x27;.rela.text&#x27;:</span><br><span class="line">  0x00000000 0a000000 00000000 02000000 0a000000 ................</span><br><span class="line">  0x00000010 fcffffff ffffffff                   ........</span><br></pre></td></tr></table></figure>

<h2 id="Dump-relocation-entries"><a href="#Dump-relocation-entries" class="headerlink" title="Dump relocation entries"></a>Dump relocation entries</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">readelf -r a.o</span></span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.text&#x27; at offset 0x1f8 contains 1 entry:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">00000000000a  000a00000002 R_X86_64_PC32     0000000000000000 foo - 4</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rela.eh_frame&#x27; at offset 0x210 contains 1 entry:</span><br><span class="line">  Offset          Info           Type           Sym. Value    Sym. Name + Addend</span><br><span class="line">000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">折纸飞向麦田</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
