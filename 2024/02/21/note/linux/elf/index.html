<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="In computing, the Executable and Linkable Format (ELF, formerly named Extensible Linking Format), is a common standard file format for executable files, object code, shared libraries, and core dumps.">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux ELF文件分析">
<meta property="og:url" content="http://example.com/2024/02/21/note/linux/elf/index.html">
<meta property="og:site_name" content="折纸飞向麦田的博客">
<meta property="og:description" content="In computing, the Executable and Linkable Format (ELF, formerly named Extensible Linking Format), is a common standard file format for executable files, object code, shared libraries, and core dumps.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102739.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102811.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240222200546.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102847.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102952.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220103009.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220103030.png">
<meta property="article:published_time" content="2024-02-21T09:34:51.043Z">
<meta property="article:modified_time" content="2024-02-28T12:36:06.262Z">
<meta property="article:author" content="折纸飞向麦田">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102739.png">


<link rel="canonical" href="http://example.com/2024/02/21/note/linux/elf/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2024/02/21/note/linux/elf/","path":"2024/02/21/note/linux/elf/","title":"Linux ELF文件分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux ELF文件分析 | 折纸飞向麦田的博客</title>
  

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?81afe862f494d24a95a49966a87c3b00"></script>







  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">折纸飞向麦田的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%80%E6%BA%90%E5%B7%A5%E5%85%B7"><span class="nav-number">1.</span> <span class="nav-text">开源工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ELF%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="nav-number">2.</span> <span class="nav-text">ELF文件类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ELF%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%A6%82%E8%A7%88"><span class="nav-number">3.</span> <span class="nav-text">ELF文件内容概览</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Symbol"><span class="nav-number">4.</span> <span class="nav-text">Symbol</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ELF-Header"><span class="nav-number">5.</span> <span class="nav-text">ELF Header</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%B1-ELF-Header-%E5%AE%9A%E4%BD%8D-Section-Header-Table"><span class="nav-number">5.1.</span> <span class="nav-text">由 ELF Header 定位 Section Header Table</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E8%80%8C%E7%94%B1-Section-Header-%E5%AE%9A%E4%BD%8D-Section"><span class="nav-number">5.2.</span> <span class="nav-text">进而由 Section Header 定位 Section</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Section"><span class="nav-number">6.</span> <span class="nav-text">Section</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Section-Header-Table"><span class="nav-number">6.1.</span> <span class="nav-text">Section Header Table</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-name"><span class="nav-number">6.1.1.</span> <span class="nav-text">sh_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-type"><span class="nav-number">6.1.2.</span> <span class="nav-text">sh_type</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SHT-PROGBITS"><span class="nav-number">6.1.2.1.</span> <span class="nav-text">SHT_PROGBITS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SHT-SYMTAB"><span class="nav-number">6.1.2.2.</span> <span class="nav-text">SHT_SYMTAB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SHT-DYNSYM"><span class="nav-number">6.1.2.3.</span> <span class="nav-text">SHT_DYNSYM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SHT-STRTAB"><span class="nav-number">6.1.2.4.</span> <span class="nav-text">SHT_STRTAB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SHT-REL-SHT-RELA"><span class="nav-number">6.1.2.5.</span> <span class="nav-text">SHT_REL &#x2F; SHT_RELA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SHT-DYNAMIC"><span class="nav-number">6.1.2.6.</span> <span class="nav-text">SHT_DYNAMIC</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-flags"><span class="nav-number">6.1.3.</span> <span class="nav-text">sh_flags</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SHF-WRITE"><span class="nav-number">6.1.3.1.</span> <span class="nav-text">SHF_WRITE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SHF-ALLOC"><span class="nav-number">6.1.3.2.</span> <span class="nav-text">SHF_ALLOC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SHF-EXECINSTR"><span class="nav-number">6.1.3.3.</span> <span class="nav-text">SHF_EXECINSTR</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-addr"><span class="nav-number">6.1.4.</span> <span class="nav-text">sh_addr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-offset"><span class="nav-number">6.1.5.</span> <span class="nav-text">sh_offset</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-size"><span class="nav-number">6.1.6.</span> <span class="nav-text">sh_size</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-info"><span class="nav-number">6.1.7.</span> <span class="nav-text">sh_info</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-addralign"><span class="nav-number">6.1.8.</span> <span class="nav-text">sh_addralign</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sh-entsize"><span class="nav-number">6.1.9.</span> <span class="nav-text">sh_entsize</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sections"><span class="nav-number">6.2.</span> <span class="nav-text">Sections</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Index-0-Section"><span class="nav-number">6.2.1.</span> <span class="nav-text">Index 0 Section</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data"><span class="nav-number">6.2.2.</span> <span class="nav-text">.data</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#plt"><span class="nav-number">6.2.3.</span> <span class="nav-text">.plt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#got"><span class="nav-number">6.2.4.</span> <span class="nav-text">.got</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#got-plt"><span class="nav-number">6.2.5.</span> <span class="nav-text">.got.plt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rela-text-rel-text"><span class="nav-number">6.2.6.</span> <span class="nav-text">.rela.text &#x2F; .rel.text</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dynamic"><span class="nav-number">6.2.7.</span> <span class="nav-text">.dynamic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#interp"><span class="nav-number">6.2.8.</span> <span class="nav-text">.interp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hash"><span class="nav-number">6.2.9.</span> <span class="nav-text">.hash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dynsym"><span class="nav-number">6.2.10.</span> <span class="nav-text">.dynsym</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dynstr"><span class="nav-number">6.2.11.</span> <span class="nav-text">.dynstr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#init"><span class="nav-number">6.2.12.</span> <span class="nav-text">.init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fini"><span class="nav-number">6.2.13.</span> <span class="nav-text">.fini</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Segment"><span class="nav-number">7.</span> <span class="nav-text">Segment</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Program-Header-Table"><span class="nav-number">7.1.</span> <span class="nav-text">Program Header Table</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#p-type"><span class="nav-number">7.1.1.</span> <span class="nav-text">p_type</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PT-PHDR"><span class="nav-number">7.1.1.1.</span> <span class="nav-text">PT_PHDR</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PT-LOAD"><span class="nav-number">7.1.1.2.</span> <span class="nav-text">PT_LOAD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PT-DYNAMIC"><span class="nav-number">7.1.1.3.</span> <span class="nav-text">PT_DYNAMIC</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PT-INTERP"><span class="nav-number">7.1.1.4.</span> <span class="nav-text">PT_INTERP</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#p-flag"><span class="nav-number">7.1.2.</span> <span class="nav-text">p_flag</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PF-X"><span class="nav-number">7.1.2.1.</span> <span class="nav-text">PF_X</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PF-W"><span class="nav-number">7.1.2.2.</span> <span class="nav-text">PF_W</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PF-R"><span class="nav-number">7.1.2.3.</span> <span class="nav-text">PF_R</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#p-offset-p-vaddr-and-p-filesz"><span class="nav-number">7.1.3.</span> <span class="nav-text">p_offset, p_vaddr, and p_filesz</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#p-paddr"><span class="nav-number">7.1.4.</span> <span class="nav-text">p_paddr</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#p-memsz"><span class="nav-number">7.1.5.</span> <span class="nav-text">p_memsz</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#p-align"><span class="nav-number">7.1.6.</span> <span class="nav-text">p_align</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hash-Table"><span class="nav-number">8.</span> <span class="nav-text">Hash Table</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Dynamic-Linking"><span class="nav-number">9.</span> <span class="nav-text">Dynamic Linking</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Relocation"><span class="nav-number">10.</span> <span class="nav-text">Relocation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Static-Relocation"><span class="nav-number">10.1.</span> <span class="nav-text">Static Relocation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dynamic-Relocation"><span class="nav-number">10.2.</span> <span class="nav-text">Dynamic Relocation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PIC-Variable"><span class="nav-number">10.2.1.</span> <span class="nav-text">PIC Variable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Example-PIC%E5%8F%98%E9%87%8F"><span class="nav-number">10.2.1.1.</span> <span class="nav-text">Example - PIC变量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PIC-Function-Lazy-Binding"><span class="nav-number">10.2.2.</span> <span class="nav-text">PIC Function (Lazy Binding)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Example-PIC%E5%87%BD%E6%95%B0"><span class="nav-number">10.2.2.1.</span> <span class="nav-text">Example - PIC函数</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83%EF%BC%9A"><span class="nav-number">11.</span> <span class="nav-text">参考：</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">折纸飞向麦田</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/21/note/linux/elf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="折纸飞向麦田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux ELF文件分析 | 折纸飞向麦田的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux ELF文件分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-02-21 17:34:51" itemprop="dateCreated datePublished" datetime="2024-02-21T17:34:51+08:00">2024-02-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-02-28 20:36:06" itemprop="dateModified" datetime="2024-02-28T20:36:06+08:00">2024-02-28</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>56 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computing">computing</a>, the <strong>Executable and Linkable Format</strong> (<strong>ELF</strong>, formerly named <strong>Extensible Linking Format</strong>), is a common standard <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/File_format">file format</a> for <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Executable">executable</a> files, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Object_code">object code</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shared_library">shared libraries</a>, and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Core_dump">core dumps</a>. – wikipedia</p>
</blockquote>
<p>ELF主宰了Linux下的二进制文件格式，值得深入学习下。</p>
<h1 id="开源工具"><a href="#开源工具" class="headerlink" title="开源工具"></a>开源工具</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/eliben/pyelftools">pyelftools</a> - A pure-Python library for parsing and analyzing ELF files and DWARF debugging information.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/BR903/ELFkickers">ELFkickers</a>- A collection of programs that access and manipulate ELF files.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/elftoolchain/elftoolchain">elftoolchain</a>- Essential development tools and libraries for building and analyzing ELF based program images.</li>
</ul>
<h1 id="ELF文件类型"><a href="#ELF文件类型" class="headerlink" title="ELF文件类型"></a>ELF文件类型</h1><ul>
<li>Object files (<code>.o</code>).</li>
<li>Executable files (no standard Linux extension).</li>
<li>Archive files (<code>.a</code>).</li>
<li>Shared object files (<code>.so</code>).</li>
<li>Core dumps.</li>
</ul>
<h1 id="ELF文件内容概览"><a href="#ELF文件内容概览" class="headerlink" title="ELF文件内容概览"></a>ELF文件内容概览</h1><p>An ELF file contains the following parts:</p>
<ul>
<li>ELF header. Points to the position of the section header table and the program header table.</li>
<li>Section header table (optional on executable). Each has <code>e_shnum</code> section headers, each pointing to the position of a section.</li>
<li>N sections, with <code>N &lt;= e_shnum</code> (optional on executable)</li>
<li>Program header table (only on executable). Each has <code>e_phnum</code> program headers, each pointing to the position of a segment.</li>
<li>N segments, with <code>N &lt;= e_phnum</code> (only on executable)</li>
</ul>
<p>object file with three sections:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">            +-------------------+</span><br><span class="line">            | ELF header        |---+</span><br><span class="line">+---------&gt; +-------------------+   | e_shoff</span><br><span class="line">|           |                   |&lt;--+</span><br><span class="line">| Section   | Section header 0  |</span><br><span class="line">|           |                   |---+ sh_offset</span><br><span class="line">| Header    +-------------------+   |</span><br><span class="line">|           | Section header 1  |---|--+ sh_offset</span><br><span class="line">| Table     +-------------------+   |  |</span><br><span class="line">|           | Section header 2  |---|--|--+</span><br><span class="line">+---------&gt; +-------------------+   |  |  |</span><br><span class="line">            | Section 0         |&lt;--+  |  |</span><br><span class="line">            +-------------------+      |  | sh_offset</span><br><span class="line">            | Section 1         |&lt;-----+  |</span><br><span class="line">            +-------------------+         |</span><br><span class="line">            | Section 2         |&lt;--------+</span><br><span class="line">            +-------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ELF可执行文件运行时：<br><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102739.png" alt="image.png"></p>
<h1 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint32_t</span>	st_name;		<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_info;	<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;	<span class="comment">/* Symbol visibility */</span></span><br><span class="line">  <span class="type">uint16_t</span>	st_shndx;		<span class="comment">/* Section index */</span></span><br><span class="line">  <span class="type">uint64_t</span>	st_value;		<span class="comment">/* Symbol value */</span></span><br><span class="line">  <span class="type">uint64_t</span>	st_size;		<span class="comment">/* Symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定长24字节</span></span><br></pre></td></tr></table></figure>

<h1 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h1><p>查看ELF Header</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/demo$ readelf -h hello_world.o</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2<span class="string">&#x27;s complement, little endian</span></span><br><span class="line"><span class="string">  Version:                           1 (current)</span></span><br><span class="line"><span class="string">  OS/ABI:                            UNIX - System V</span></span><br><span class="line"><span class="string">  ABI Version:                       0</span></span><br><span class="line"><span class="string">  Type:                              REL (Relocatable file)</span></span><br><span class="line"><span class="string">  Machine:                           Advanced Micro Devices X86-64</span></span><br><span class="line"><span class="string">  Version:                           0x1</span></span><br><span class="line"><span class="string">  Entry point address:               0x0</span></span><br><span class="line"><span class="string">  Start of program headers:          0 (bytes into file)</span></span><br><span class="line"><span class="string">  Start of section headers:          64 (bytes into file)</span></span><br><span class="line"><span class="string">  Flags:                             0x0</span></span><br><span class="line"><span class="string">  Size of this header:               64 (bytes)</span></span><br><span class="line"><span class="string">  Size of program headers:           0 (bytes)</span></span><br><span class="line"><span class="string">  Number of program headers:         0</span></span><br><span class="line"><span class="string">  Size of section headers:           64 (bytes)</span></span><br><span class="line"><span class="string">  Number of section headers:         7</span></span><br><span class="line"><span class="string">  Section header string table index: 3</span></span><br></pre></td></tr></table></figure>

<p>对应的二进制流</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/demo$ hd hello_world.o</span><br><span class="line">00000000  7f 45 4c 46 02 01 01 00  00 00 00 00 00 00 00 00  |.ELF............|</span><br><span class="line">00000010  01 00 3e 00 01 00 00 00  00 00 00 00 00 00 00 00  |..&gt;.............|</span><br><span class="line">00000020  00 00 00 00 00 00 00 00  40 00 00 00 00 00 00 00  |........@.......|</span><br><span class="line">00000030  00 00 00 00 40 00 00 00  00 00 40 00 07 00 03 00  |....@.....@.....|</span><br></pre></td></tr></table></figure>

<p>c结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT (16)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	e_ident[EI_NIDENT];	<span class="comment">/* Magic number and other info */</span></span><br><span class="line">  Elf64_Half	e_type;			<span class="comment">/* Object file type */</span></span><br><span class="line">  Elf64_Half	e_machine;		<span class="comment">/* Architecture */</span></span><br><span class="line">  Elf64_Word	e_version;		<span class="comment">/* Object file version */</span></span><br><span class="line">  Elf64_Addr	e_entry;		<span class="comment">/* Entry point virtual address */</span></span><br><span class="line">  Elf64_Off	e_phoff;		<span class="comment">/* Program header table file offset */</span></span><br><span class="line">  Elf64_Off	e_shoff;		<span class="comment">/* Section header table file offset */</span></span><br><span class="line">  Elf64_Word	e_flags;		<span class="comment">/* Processor-specific flags */</span></span><br><span class="line">  Elf64_Half	e_ehsize;		<span class="comment">/* ELF header size in bytes */</span></span><br><span class="line">  Elf64_Half	e_phentsize;		<span class="comment">/* Program header table entry size */</span></span><br><span class="line">  Elf64_Half	e_phnum;		<span class="comment">/* Program header table entry count */</span></span><br><span class="line">  Elf64_Half	e_shentsize;		<span class="comment">/* Section header table entry size */</span></span><br><span class="line">  Elf64_Half	e_shnum;		<span class="comment">/* Section header table entry count */</span></span><br><span class="line">  Elf64_Half	e_shstrndx;		<span class="comment">/* Section header string table index */</span></span><br><span class="line">&#125; Elf64_Ehdr;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; whatis Elf64_Half</span><br><span class="line">type = <span class="type">uint16_t</span></span><br><span class="line">&gt;&gt;&gt; whatis Elf64_Word</span><br><span class="line">type = <span class="type">uint32_t</span></span><br><span class="line">&gt;&gt;&gt; whatis Elf64_Addr</span><br><span class="line">type = <span class="type">uint64_t</span></span><br><span class="line">&gt;&gt;&gt; whatis Elf64_Off</span><br><span class="line">type = <span class="type">uint64_t</span></span><br></pre></td></tr></table></figure>

<h2 id="由-ELF-Header-定位-Section-Header-Table"><a href="#由-ELF-Header-定位-Section-Header-Table" class="headerlink" title="由 ELF Header 定位 Section Header Table"></a>由 ELF Header 定位 Section Header Table</h2><p>ELF Header 通过如下4个字段指明 section header table 的位置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf -h a.out | egrep &quot;[s|S]ection&quot;</span></span><br><span class="line">  Start of section headers:          74152 (bytes into file)</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         34</span><br><span class="line">  Section header string table index: 33</span><br></pre></td></tr></table></figure>

<p>由上述信息可知：Section header string table section (<code>.shstrtab</code>) 位于 section header table 下标为 33 位置，由于所有的 section header 长度为定长 64 字节，由此可计算出该section header的起始地址为 <code>74152 + 33 * 64 = 76264</code>, 即如下字节流：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># xxd -s 76264 -l 64 a.out </span><br><span class="line">00129e8: 1100 0000 0300 0000 0000 0000 0000 0000  ................</span><br><span class="line">00129f8: 0000 0000 0000 0000 5f20 0100 0000 0000  ........_ ......</span><br><span class="line">0012a08: 4301 0000 0000 0000 0000 0000 0000 0000  C...............</span><br><span class="line">0012a18: 0100 0000 0000 0000 0000 0000 0000 0000  ................</span><br></pre></td></tr></table></figure>

<p>期望这64字节能与<code>readelf</code>给出的结果匹配上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf -S -W a.out</span></span><br><span class="line"></span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf </span><br><span class="line">  [33] .shstrtab         STRTAB          0000000000000000 01205f 000143 00      0   0  1</span><br></pre></td></tr></table></figure>

<p>把 section header 结构再搬过来，试着逐字段对比</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_name;      <span class="comment">/* Section name (string tbl index) */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_type;      <span class="comment">/* Section type */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_flags;     <span class="comment">/* Section flags */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_addr;      <span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_offset;    <span class="comment">/* Section file offset*/</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_size;      <span class="comment">/* Section size in bytes */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_link;      <span class="comment">/* Link to another section */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_info;      <span class="comment">/* Additional section information */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_addralign; <span class="comment">/* Section alignment */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_entsize;   <span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf64_Shdr;</span><br></pre></td></tr></table></figure>

<p>第 1-4 字节，<code>sh_name</code>，转换为大端10进制为 <code>0x11 = 3</code>，表示 <code>.shstrtab</code> 中第三个字符串就是当前section的名称。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00129e8: [1100 0000] 0300 0000 0000 0000 0000 0000  ................</span><br></pre></td></tr></table></figure>

<p>匹配上 <code>readelf</code> 结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@ZLPC-WangQingJia demo]# readelf -x .shstrtab a.out </span><br><span class="line"></span><br><span class="line">Hex dump of section &#x27;.shstrtab&#x27;:</span><br><span class="line">  0x00000000 002e7379 6d746162 002e7374 72746162 ..symtab..strtab</span><br><span class="line">  0x00000010 002e7368 73747274 6162002e 696e7465 ..shstrtab..inte</span><br><span class="line">  0x00000020 7270002e 6e6f7465 2e414249 2d746167 rp..note.ABI-tag</span><br></pre></td></tr></table></figure>

<p>第 5-8 字节，<code>sh_type = 0x03</code> ，类型是字符串表，匹配上 <code>readelf</code> 结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00129e8: 1100 0000 [0300 0000] 0000 0000 0000 0000  ................</span><br><span class="line"></span><br><span class="line">#define SHT_STRTAB    3   /* String table */</span><br></pre></td></tr></table></figure>

<p>第 25-32 字节，<code>sh_offset = 0x01205f</code> 正好匹配上 <code>readelf</code> 的 Off 列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00129e8: 1100 0000 0300 0000 0000 0000 0000 0000  ................</span><br><span class="line">00129f8: 0000 0000 0000 0000 [5f20 0100 0000 0000]  ........_ ......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf </span><br><span class="line">[33] .shstrtab         STRTAB          0000000000000000 01205f 000143 00      0   0  1</span><br></pre></td></tr></table></figure>


<h2 id="进而由-Section-Header-定位-Section"><a href="#进而由-Section-Header-定位-Section" class="headerlink" title="进而由 Section Header 定位 Section"></a>进而由 Section Header 定位 Section</h2><p>由 <code>.shstrtab</code> 的 section header 可知该section位于ELF文件的 <code>[0x01205f, 0x01205f+0x143=0x121A2]</code> 范围</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># readelf -S -W a.out</span></span><br><span class="line"></span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf </span><br><span class="line">  [33] .shstrtab         STRTAB          0000000000000000 01205f 000143 00      0   0  1</span><br></pre></td></tr></table></figure>

<p>验证：结果完全吻合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@ZLPC-WangQingJia demo]# xxd -s 0x01205f -l 0x143 a.out</span><br><span class="line">001205f: 002e 7379 6d74 6162 002e 7374 7274 6162  ..symtab..strtab</span><br><span class="line">001206f: 002e 7368 7374 7274 6162 002e 696e 7465  ..shstrtab..inte</span><br><span class="line">001207f: 7270 002e 6e6f 7465 2e41 4249 2d74 6167  rp..note.ABI-tag</span><br><span class="line">001208f: 002e 6e6f 7465 2e67 6e75 2e62 7569 6c64  ..note.gnu.build</span><br><span class="line">001209f: 2d69 6400 2e67 6e75 2e68 6173 6800 2e64  -id..gnu.hash..d</span><br><span class="line">00120af: 796e 7379 6d00 2e64 796e 7374 7200 2e67  ynsym..dynstr..g</span><br><span class="line">00120bf: 6e75 2e76 6572 7369 6f6e 002e 676e 752e  nu.version..gnu.</span><br><span class="line">00120cf: 7665 7273 696f 6e5f 7200 2e72 656c 612e  version_r..rela.</span><br><span class="line">00120df: 6479 6e00 2e72 656c 612e 706c 7400 2e69  dyn..rela.plt..i</span><br><span class="line">00120ef: 6e69 7400 2e74 6578 7400 2e66 696e 6900  nit..text..fini.</span><br><span class="line">00120ff: 2e72 6f64 6174 6100 2e65 685f 6672 616d  .rodata..eh_fram</span><br><span class="line">001210f: 655f 6864 7200 2e65 685f 6672 616d 6500  e_hdr..eh_frame.</span><br><span class="line">001211f: 2e69 6e69 745f 6172 7261 7900 2e66 696e  .init_array..fin</span><br><span class="line">001212f: 695f 6172 7261 7900 2e64 796e 616d 6963  i_array..dynamic</span><br><span class="line">001213f: 002e 676f 7400 2e67 6f74 2e70 6c74 002e  ..got..got.plt..</span><br><span class="line">001214f: 6461 7461 002e 6273 7300 2e63 6f6d 6d65  data..bss..comme</span><br><span class="line">001215f: 6e74 002e 6465 6275 675f 6172 616e 6765  nt..debug_arange</span><br><span class="line">001216f: 7300 2e64 6562 7567 5f69 6e66 6f00 2e64  s..debug_info..d</span><br><span class="line">001217f: 6562 7567 5f61 6262 7265 7600 2e64 6562  ebug_abbrev..deb</span><br><span class="line">001218f: 7567 5f6c 696e 6500 2e64 6562 7567 5f73  ug_line..debug_s</span><br><span class="line">001219f: 7472 00                                  tr.</span><br><span class="line"></span><br><span class="line">[root@ZLPC-WangQingJia demo]# readelf -x .shstrtab a.out </span><br><span class="line">Hex dump of section &#x27;.shstrtab&#x27;:</span><br><span class="line">  0x00000000 002e7379 6d746162 002e7374 72746162 ..symtab..strtab</span><br><span class="line">  0x00000010 002e7368 73747274 6162002e 696e7465 ..shstrtab..inte</span><br><span class="line">  0x00000020 7270002e 6e6f7465 2e414249 2d746167 rp..note.ABI-tag</span><br><span class="line">  0x00000030 002e6e6f 74652e67 6e752e62 75696c64 ..note.gnu.build</span><br><span class="line">  0x00000040 2d696400 2e676e75 2e686173 68002e64 -id..gnu.hash..d</span><br><span class="line">  0x00000050 796e7379 6d002e64 796e7374 72002e67 ynsym..dynstr..g</span><br><span class="line">  0x00000060 6e752e76 65727369 6f6e002e 676e752e nu.version..gnu.</span><br><span class="line">  0x00000070 76657273 696f6e5f 72002e72 656c612e version_r..rela.</span><br><span class="line">  0x00000080 64796e00 2e72656c 612e706c 74002e69 dyn..rela.plt..i</span><br><span class="line">  0x00000090 6e697400 2e746578 74002e66 696e6900 nit..text..fini.</span><br><span class="line">  0x000000a0 2e726f64 61746100 2e65685f 6672616d .rodata..eh_fram</span><br><span class="line">  0x000000b0 655f6864 72002e65 685f6672 616d6500 e_hdr..eh_frame.</span><br><span class="line">  0x000000c0 2e696e69 745f6172 72617900 2e66696e .init_array..fin</span><br><span class="line">  0x000000d0 695f6172 72617900 2e64796e 616d6963 i_array..dynamic</span><br><span class="line">  0x000000e0 002e676f 74002e67 6f742e70 6c74002e ..got..got.plt..</span><br><span class="line">  0x000000f0 64617461 002e6273 73002e63 6f6d6d65 data..bss..comme</span><br><span class="line">  0x00000100 6e74002e 64656275 675f6172 616e6765 nt..debug_arange</span><br><span class="line">  0x00000110 73002e64 65627567 5f696e66 6f002e64 s..debug_info..d</span><br><span class="line">  0x00000120 65627567 5f616262 72657600 2e646562 ebug_abbrev..deb</span><br><span class="line">  0x00000130 75675f6c 696e6500 2e646562 75675f73 ug_line..debug_s</span><br><span class="line">  0x00000140 747200                              tr.</span><br></pre></td></tr></table></figure>


<h1 id="Section"><a href="#Section" class="headerlink" title="Section"></a>Section</h1><blockquote>
<p>Strictly speaking, the division into sections is intended to provide a convenient organization for use by the linker. Sections are intended to provide a view for the linker only.</p>
</blockquote>
<p>由 <code>section header table</code> 定义 sections.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/demo$ readelf -S hello_world.o</span><br><span class="line">There are 7 section headers, starting at offset 0x40:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .data             PROGBITS         0000000000000000  00000200</span><br><span class="line">       000000000000000d  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 2] .text             PROGBITS         0000000000000000  00000210</span><br><span class="line">       0000000000000027  0000000000000000  AX       0     0     16</span><br><span class="line">  [ 3] .shstrtab         STRTAB           0000000000000000  00000240</span><br><span class="line">       0000000000000032  0000000000000000           0     0     1</span><br><span class="line">  [ 4] .symtab           SYMTAB           0000000000000000  00000280</span><br><span class="line">       00000000000000a8  0000000000000018           5     6     8</span><br><span class="line">  [ 5] .strtab           STRTAB           0000000000000000  00000330</span><br><span class="line">       000000000000002b  0000000000000000           0     0     1</span><br><span class="line">  [ 6] .rela.text        RELA             0000000000000000  00000360</span><br><span class="line">       0000000000000018  0000000000000018           4     2     8</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br></pre></td></tr></table></figure>

<h2 id="Section-Header-Table"><a href="#Section-Header-Table" class="headerlink" title="Section Header Table"></a>Section Header Table</h2><p>Section header entry(fixed size) is defined as <code>Elf64_Shdr</code> in <code>/usr/include/elf.h</code><br>Section header table is an array of <code>Elf64_Shdr</code> structs.<br>Each entry describes a section.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_name;      <span class="comment">/* Section name (string tbl index) */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_type;      <span class="comment">/* Section type */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_flags;     <span class="comment">/* Section flags */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_addr;      <span class="comment">/* Section virtual addr at execution */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_offset;    <span class="comment">/* Section file offset*/</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_size;      <span class="comment">/* Section size in bytes */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_link;      <span class="comment">/* Link to another section */</span></span><br><span class="line">	<span class="type">uint32_t</span> sh_info;      <span class="comment">/* Additional section information */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_addralign; <span class="comment">/* Section alignment */</span></span><br><span class="line">	<span class="type">uint64_t</span> sh_entsize;   <span class="comment">/* Entry size if section holds table */</span></span><br><span class="line">&#125; Elf64_Shdr;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单个section header为64字节</span></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -h hello_world.o</span><br><span class="line"></span><br><span class="line">Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">Class:                             ELF64</span><br><span class="line">Data:                              2&#x27;s complement, little endian</span><br><span class="line">Version:                           1 (current)</span><br><span class="line">OS/ABI:                            UNIX - System V</span><br><span class="line">ABI Version:                       0</span><br><span class="line">Type:                              REL (Relocatable file)</span><br><span class="line">Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">Version:                           0x1</span><br><span class="line">Entry point address:               0x0</span><br><span class="line">Start of program headers:          0 (bytes into file)</span><br><span class="line">Start of section headers:          64 (bytes into file)</span><br><span class="line">Flags:                             0x0</span><br><span class="line">Size of this header:               64 (bytes)</span><br><span class="line">Size of program headers:           0 (bytes)</span><br><span class="line">Number of program headers:         0</span><br><span class="line">Size of section headers:           64 (bytes)</span><br><span class="line">Number of section headers:         7</span><br><span class="line">Section header string table index: 3</span><br></pre></td></tr></table></figure>

<p>Files used during linking must have a section header table; Because sections are intended to provide a view for the linker only, the section header table is an optional part of the ELF format. ELF files that don’t need linking aren’t required to have a section header table. If no sec-<br>tion header table is present, the e_shoff field in the executable header is set to zero.</p>
<h3 id="sh-name"><a href="#sh-name" class="headerlink" title="sh_name"></a>sh_name</h3><p>If set, it contains an index into the <code>.shstrtab</code> (section header string table). If the index is zero, it means the section doesn’t have a name.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># readelf -x .shstrtab a.out </span><br><span class="line"></span><br><span class="line">Hex dump of section &#x27;.shstrtab&#x27;:</span><br><span class="line">  0x00000000 002e7379 6d746162 002e7374 72746162 ..symtab..strtab</span><br><span class="line">  0x00000010 002e7368 73747274 6162002e 696e7465 ..shstrtab..inte</span><br><span class="line">  0x00000020 7270002e 6e6f7465 2e414249 2d746167 rp..note.ABI-tag</span><br><span class="line">  0x00000030 002e6e6f 74652e67 6e752e62 75696c64 ..note.gnu.build</span><br><span class="line">  0x00000040 2d696400 2e676e75 2e686173 68002e64 -id..gnu.hash..d</span><br><span class="line">  0x00000050 796e7379 6d002e64 796e7374 72002e67 ynsym..dynstr..g</span><br><span class="line">  0x00000060 6e752e76 65727369 6f6e002e 676e752e nu.version..gnu.</span><br><span class="line">  0x00000070 76657273 696f6e5f 72002e72 656c612e version_r..rela.</span><br><span class="line">  0x00000080 64796e00 2e72656c 612e706c 74002e69 dyn..rela.plt..i</span><br><span class="line">  0x00000090 6e697400 2e746578 74002e66 696e6900 nit..text..fini.</span><br><span class="line">  0x000000a0 2e726f64 61746100 2e65685f 6672616d .rodata..eh_fram</span><br><span class="line">  0x000000b0 655f6864 72002e65 685f6672 616d6500 e_hdr..eh_frame.</span><br><span class="line">  0x000000c0 2e696e69 745f6172 72617900 2e66696e .init_array..fin</span><br><span class="line">  0x000000d0 695f6172 72617900 2e64796e 616d6963 i_array..dynamic</span><br><span class="line">  0x000000e0 002e676f 74002e67 6f742e70 6c74002e ..got..got.plt..</span><br><span class="line">  0x000000f0 64617461 002e6273 73002e63 6f6d6d65 data..bss..comme</span><br><span class="line">  0x00000100 6e74002e 64656275 675f6172 616e6765 nt..debug_arange</span><br><span class="line">  0x00000110 73002e64 65627567 5f696e66 6f002e64 s..debug_info..d</span><br><span class="line">  0x00000120 65627567 5f616262 72657600 2e646562 ebug_abbrev..deb</span><br><span class="line">  0x00000130 75675f6c 696e6500 2e646562 75675f73 ug_line..debug_s</span><br><span class="line">  0x00000140 747200                              tr.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="sh-type"><a href="#sh-type" class="headerlink" title="sh_type"></a>sh_type</h3><p>Every section has a type, indicated by an integer field called <code>sh_type</code>, that tells the linker something about the structure of a section’s contents.</p>
<h4 id="SHT-PROGBITS"><a href="#SHT-PROGBITS" class="headerlink" title="SHT_PROGBITS"></a>SHT_PROGBITS</h4><p>Contain program data, such as machine instructions or constants. These sections have no particular structure for the linker to parse.</p>
<h4 id="SHT-SYMTAB"><a href="#SHT-SYMTAB" class="headerlink" title="SHT_SYMTAB"></a>SHT_SYMTAB</h4><p>Static symbol tables. Symbol tables contain symbols in a well-defined format (struct Elf64_Sym in elf.h)</p>
<h4 id="SHT-DYNSYM"><a href="#SHT-DYNSYM" class="headerlink" title="SHT_DYNSYM"></a>SHT_DYNSYM</h4><p>Symbol tables used by the dynamic linker.</p>
<h4 id="SHT-STRTAB"><a href="#SHT-STRTAB" class="headerlink" title="SHT_STRTAB"></a>SHT_STRTAB</h4><p>String tables, which simply contain an array of NULL-terminated strings, with the first byte in the string table set to NULL by convention.</p>
<h4 id="SHT-REL-SHT-RELA"><a href="#SHT-REL-SHT-RELA" class="headerlink" title="SHT_REL &#x2F; SHT_RELA"></a>SHT_REL &#x2F; SHT_RELA</h4><p>Sections with type SHT_REL or SHT_RELA are particularly important for the linker because they contain relocation entries in a well-defined format (struct Elf64_Rel and struct Elf64_Rela in elf.h), which the linker can parse to perform the necessary relocations in other sections. Each relocation entry tells the linker about a particular location in the binary where a relocation is needed and which symbol the relocation should be resolved to.</p>
<h4 id="SHT-DYNAMIC"><a href="#SHT-DYNAMIC" class="headerlink" title="SHT_DYNAMIC"></a>SHT_DYNAMIC</h4><p>Sections of type SHT_DYNAMIC contain information needed for dynamic linking. This information is formatted using struct Elf64_Dyn as specified in elf.h.</p>
<h3 id="sh-flags"><a href="#sh-flags" class="headerlink" title="sh_flags"></a>sh_flags</h3><h4 id="SHF-WRITE"><a href="#SHF-WRITE" class="headerlink" title="SHF_WRITE"></a>SHF_WRITE</h4><p>SHF_WRITE indicates that the section is writable at runtime. </p>
<h4 id="SHF-ALLOC"><a href="#SHF-ALLOC" class="headerlink" title="SHF_ALLOC"></a>SHF_ALLOC</h4><blockquote>
<p>The SHF_ALLOC flag indicates that the contents of the section are to be loaded into virtual memory when executing the binary (though the actual loading happens using the segment view of the binary, not the section view).</p>
</blockquote>
<h4 id="SHF-EXECINSTR"><a href="#SHF-EXECINSTR" class="headerlink" title="SHF_EXECINSTR"></a>SHF_EXECINSTR</h4><blockquote>
<p>SHF_EXECINSTR tells you that the section contains executable instructions, which is useful to know when disassembling a binary.</p>
</blockquote>
<h3 id="sh-addr"><a href="#sh-addr" class="headerlink" title="sh_addr"></a>sh_addr</h3><p>virtual address of section.</p>
<p>the linker sometimes needs to know at which addresses partic-<br>ular pieces of code and data will end up at runtime to do relocations. The<br>sh_addr field provides this information. Sections that aren’t intended to be<br>loaded into virtual memory when setting up the process have an sh_addr<br>value of zero.</p>
<h3 id="sh-offset"><a href="#sh-offset" class="headerlink" title="sh_offset"></a>sh_offset</h3><p>The byte offset from the beginning of the file to the first byte in the section.</p>
<h3 id="sh-size"><a href="#sh-size" class="headerlink" title="sh_size"></a>sh_size</h3><p>size (in bytes) of the section</p>
<h3 id="sh-info"><a href="#sh-info" class="headerlink" title="sh_info"></a>sh_info</h3><blockquote>
<p>The sh_info field contains additional information about the section. The<br>meaning of the additional information varies depending on the section type.<br>For instance, for relocation sections, sh_info denotes the index of the section<br>to which the relocations are to be applied.</p>
</blockquote>
<h3 id="sh-addralign"><a href="#sh-addralign" class="headerlink" title="sh_addralign"></a>sh_addralign</h3><blockquote>
<p>Some sections may need to be aligned in memory in a particular way for effi-<br>ciency of memory accesses. For example, a section may need to be loaded<br>at some address that is a multiple of 8 bytes or 16 bytes. These alignment<br>requirements are specified in the sh_addralign field. For instance, if this field<br>is set to 16, it means the base address of the section (as chosen by the linker)<br>must be some multiple of 16. The values 0 and 1 are reserved to indicate no<br>special alignment needs.</p>
</blockquote>
<h3 id="sh-entsize"><a href="#sh-entsize" class="headerlink" title="sh_entsize"></a>sh_entsize</h3><p>Some sections, such as symbol tables or relocation tables, contain a table of well-defined data structures (such as Elf64_Sym or Elf64_Rela). For such sections, the sh_entsize field indicates the size in bytes of each entry in the table. When the field is unused, it is set to zero</p>
<h2 id="Sections"><a href="#Sections" class="headerlink" title="Sections"></a>Sections</h2><h3 id="Index-0-Section"><a href="#Index-0-Section" class="headerlink" title="Index 0 Section"></a>Index 0 Section</h3><p>magic section</p>
<h3 id="data"><a href="#data" class="headerlink" title=".data"></a>.data</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [24] .data             PROGBITS        0000000000002000 001000 000010 00  WA  0   0  8</span><br></pre></td></tr></table></figure>

<h3 id="plt"><a href="#plt" class="headerlink" title=".plt"></a>.plt</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [13] .plt              PROGBITS        0000000000000550 000550 000050 10  AX  0   0 16</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line">0000000000000550 &lt;.plt&gt;:</span><br><span class="line"> 550:    ff 35 8a 1a 00 00        pushq  0x1a8a(%rip)        # 1fe0 &lt;_GLOBAL_OFFSET_TABLE_+0x8&gt;</span><br><span class="line"> 556:    f2 ff 25 8b 1a 00 00     bnd jmpq *0x1a8b(%rip)        # 1fe8 &lt;_GLOBAL_OFFSET_TABLE_+0x10&gt;</span><br><span class="line"> 55d:    0f 1f 00                 nopl   (%rax)</span><br><span class="line"> 560:    f3 0f 1e fa              endbr64 </span><br><span class="line"> 564:    68 00 00 00 00           pushq  $0x0</span><br><span class="line"> 569:    f2 e9 e1 ff ff ff        bnd jmpq 550 &lt;_init+0x28&gt;</span><br><span class="line"> 56f:    90                       nop</span><br><span class="line"> 570:    f3 0f 1e fa              endbr64 </span><br><span class="line"> 574:    68 01 00 00 00           pushq  $0x1</span><br><span class="line"> 579:    f2 e9 d1 ff ff ff        bnd jmpq 550 &lt;_init+0x28&gt;</span><br><span class="line"> 57f:    90                       nop</span><br><span class="line"> 580:    f3 0f 1e fa              endbr64 </span><br><span class="line"> 584:    f2 ff 25 65 1a 00 00     bnd jmpq *0x1a65(%rip)        # 1ff0 &lt;__cxa_finalize@GLIBC_2.2.5&gt;</span><br><span class="line"> 58b:    0f 1f 04 00              nopl   (%rax,%rax,1)</span><br><span class="line"> 58f:    90                       nop</span><br><span class="line"> 590:    f3 0f 1e fa              endbr64 </span><br><span class="line"> 594:    f2 ff 25 5d 1a 00 00     bnd jmpq *0x1a5d(%rip)        # 1ff8 &lt;putchar@GLIBC_2.2.5&gt;</span><br><span class="line"> 59b:    0f 1f 04 00              nopl   (%rax,%rax,1)</span><br><span class="line"> 59f:    90                       nop</span><br></pre></td></tr></table></figure>

<h3 id="got"><a href="#got" class="headerlink" title=".got"></a>.got</h3><p>A GOT is simply a table of addresses, residing in the data section. The GOT entry, in turn, will contain the absolute address of the variable:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [22] .got              PROGBITS        0000000000001fb0 000fb0 000028 00  WA  0   0  8</span><br></pre></td></tr></table></figure>

<h3 id="got-plt"><a href="#got-plt" class="headerlink" title=".got.plt"></a>.got.plt</h3><p><code>.got.plt</code> 的前三项是有特殊意义的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GOT[0]：保存的是“.dynamic”节的地址，这个节描述了本模块动态链接相关的信息</span><br><span class="line">GOT[1]：保存的是本模块的link_map结构的地址，动态链接器利用该地址来对符号进行解析。</span><br><span class="line">GOT[2]：保存的是_dl_runtime_resolve()的地址。</span><br></pre></td></tr></table></figure>

<p>其中第二项和第三项由动态链接器在装载共享模块的时候负责将它们初始化。</p>
<p><code>.got.plt</code>的其余项分别对应每个外部函数的引用</p>
<p><code>.got.plt</code> contains the addresses of the external <em>functions</em> used by the program.</p>
<p>PLT(Procedure Linkage Table) which is, put simply, used to call external procedures&#x2F;functions whose address isn’t known in the time of linking, and is left to be resolved by the dynamic linker at run time.</p>
<p>for code, things are a bit more complicated.</p>
<p>Whenever a function from a shared library is called, the linker makes us jump to an address in the PLT.</p>
<p>The first time the function is called, the PLT code uses offsets stored in the GOT to decide the actual final location of the function, and then:</p>
<ul>
<li>stores this pre-calculated value</li>
<li>jumps there</li>
</ul>
<p>The next times the function is called, the value has already been calculated, so it just jumps there directly.</p>
<p>Due to this lazy resolution mechanism:</p>
<ul>
<li>programs can start running quickly even if the shared libraries have a lot of symbols</li>
<li>we can replace functions on the fly by playing with the <code>LD_PRELOAD</code> variable</li>
</ul>
<h3 id="rela-text-rel-text"><a href="#rela-text-rel-text" class="headerlink" title=".rela.text &#x2F; .rel.text"></a>.rela.text &#x2F; .rel.text</h3><p><a target="_blank" rel="noopener" href="https://ourbigbook.com/cirosantilli/elf-hello-world#cirosantilli/elf-hello-world/rela-text">https://ourbigbook.com/cirosantilli/elf-hello-world#cirosantilli/elf-hello-world/rela-text</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr    r_offset;        <span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword    r_info;            <span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">  Elf64_Sxword    r_addend;        <span class="comment">/* Addend */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102811.png" alt="image.png"></p>
<p>Besides <code>sh_type == SHT_RELA</code>, there also exists <code>SHT_REL</code>, which would have section name <code>.text.rel</code>.</p>
<p>Those represent the same <code>struct</code>, but without the addend, e.g.:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Addr  r_offset;</span><br><span class="line">    Elf64_Xword r_info;</span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<p>The ELF standard says that in many cases the both can be used, and it is just a matter of convenience.</p>
<h3 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h3><p>专门用于动态链接</p>
<p>动态链接ELF中<code>最重要的结构</code>应该是 **<code>.dynamic</code>**，这个节里面保存了<code>动态链接器</code>所需要的<code>基本信息</code>，比如依赖于哪些<code>共享对象</code>、<code>动态链接符号表</code>的位置、<code>动态链接重定位表</code>的位置、<code>共享对象初始化代码</code>的地址等。</p>
<p>The <code>.dynamic</code> section is comprised of <code>Elf64_Dyn</code> or <code>Elf32_Dyn</code> entries, not direct references to libraries. Some of these entries, identified by their <code>.d_tag</code> field (e.g., <code>DT_NEEDED</code> for required libraries or <code>DT_RPATH</code> for library search paths), point to strings within the <code>.dynstr</code> section via offsets. The dynamic loader uses these entries to determine actions such as loading additional libraries or specifying library search paths, interpreting the referenced strings according to the entries’ types and values.</p>
<p>使用<code>readelf</code>工具可以查看<code>“.dynamic”节</code>的内容：</p>
<ul>
<li><blockquote>
<p>-d –dynamic           Display the dynamic section (if present)</p>
</blockquote>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -d a.out</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0x750 contains 25 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000c (INIT)                       0x8048328</span><br><span class="line"> 0x0000000d (FINI)                       0x8048650</span><br><span class="line"> 0x00000019 (INIT_ARRAY)                 0x8049744</span><br><span class="line"> 0x0000001b (INIT_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x0000001a (FINI_ARRAY)                 0x8049748</span><br><span class="line"> 0x0000001c (FINI_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x00000004 (HASH)                       0x804818c</span><br><span class="line"> 0x6ffffef5 (GNU_HASH)                   0x80481c0</span><br><span class="line"> 0x00000005 (STRTAB)                     0x8048260</span><br><span class="line"> 0x00000006 (SYMTAB)                     0x80481e0</span><br><span class="line"> 0x0000000a (STRSZ)                      95 (bytes)</span><br><span class="line"> 0x0000000b (SYMENT)                     16 (bytes)</span><br><span class="line"> 0x00000015 (DEBUG)                      0x0</span><br><span class="line"> 0x00000003 (PLTGOT)                     0x8049844</span><br><span class="line"> 0x00000002 (PLTRELSZ)                   48 (bytes)</span><br><span class="line"> 0x00000014 (PLTREL)                     REL</span><br><span class="line"> 0x00000017 (JMPREL)                     0x80482f8</span><br><span class="line"> 0x00000011 (REL)                        0x80482f0</span><br><span class="line"> 0x00000012 (RELSZ)                      8 (bytes)</span><br><span class="line"> 0x00000013 (RELENT)                     8 (bytes)</span><br><span class="line"> 0x6ffffffe (VERNEED)                    0x80482d0</span><br><span class="line"> 0x6fffffff (VERNEEDNUM)                 1</span><br><span class="line"> 0x6ffffff0 (VERSYM)                     0x80482c0</span><br><span class="line"> 0x00000000 (NULL)                       0x0</span><br></pre></td></tr></table></figure>

<h3 id="interp"><a href="#interp" class="headerlink" title=".interp"></a>.interp</h3><p>有动态库的可执行文件才有这个section</p>
<p>This section holds the path name of a program interpreter.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ZLPC-WangQingJia home]# readelf -x .interp pyelftools/test/testfiles_for_unittests/simple_mipsel.elf</span><br><span class="line"></span><br><span class="line">Hex dump of section &#x27;.interp&#x27;:</span><br><span class="line">  0x00400194 2f6c6962 2f6c642e 736f2e31 00       /lib/ld.so.1.</span><br></pre></td></tr></table></figure>

<h3 id="hash"><a href="#hash" class="headerlink" title=".hash"></a>.hash</h3><p>给<code>ld.so</code> 查询动态符号用的哈希表</p>
<p><a target="_blank" rel="noopener" href="https://flapenguin.me/elf-dt-hash">https://flapenguin.me/elf-dt-hash</a></p>
<h3 id="dynsym"><a href="#dynsym" class="headerlink" title=".dynsym"></a>.dynsym</h3><p>This section holds the dynamic linking symbol table</p>
<p>The <code>.dynsym</code> section of an ELF file consists of fixed-length records, either of type <code>Elf32_Sym</code> or <code>Elf64_Sym</code>, depending on the architecture. These records are unable to directly contain the symbol names due to their variable length nature. Instead, they include an offset within the <code>.dynstr</code> section (in the <code>.st_name</code> field), where the actual symbol name is located. Therefore, it is incorrect to say that <code>.dynsym</code> directly contains symbol names like “<a href="mailto:&#x73;&#x65;&#x74;&#115;&#111;&#x63;&#x6b;&#111;&#112;&#116;&#64;&#x47;&#76;&#x49;&#66;&#67;&#95;&#x32;&#46;&#x30;">&#x73;&#x65;&#x74;&#115;&#111;&#x63;&#x6b;&#111;&#112;&#116;&#64;&#x47;&#76;&#x49;&#66;&#67;&#95;&#x32;&#46;&#x30;</a>.” It accurately contains an <code>Elf32_Sym</code> or <code>Elf64_Sym</code> entry for an imported symbol such as <code>setsockopt</code>, which refers to the symbol name’s offset in the <code>.dynstr</code> section.</p>
<h3 id="dynstr"><a href="#dynstr" class="headerlink" title=".dynstr"></a>.dynstr</h3><p>This section holds strings needed for dynamic linking</p>
<h3 id="init"><a href="#init" class="headerlink" title=".init"></a>.init</h3><p>This section holds executable instructions that contribute to the process initialization code. When a program starts to run, the system executes the code in this section before calling the main program entry point (called main for C programs).</p>
<h3 id="fini"><a href="#fini" class="headerlink" title=".fini"></a>.fini</h3><p>This section holds executable instructions that contribute to the process termination code. When a program exits normally, the system executes the code in this section.</p>
<h1 id="Segment"><a href="#Segment" class="headerlink" title="Segment"></a>Segment</h1><p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240222200546.png" alt="image.png"></p>
<p>One ore more sections will be put inside a single segment by the linker.</p>
<p>segments, which are used at execution time (as opposed to sections, which are used at link time). Contains information about how each segment should be loaded into memory by the OS, notably location and permissions.</p>
<p>segment: exists after linking, in the executable file.</p>
<blockquote>
<p>The program header table provides a segment view of the binary, as opposed to<br>the section view provided by the section header table. The section view of an<br>ELF binary, which I discussed earlier, is meant for static linking purposes<br>only. In contrast, the segment view, which I’ll discuss next, is used by the<br>operating system and dynamic linker when loading an ELF into a process for<br>execution to locate the relevant code and data and decide what to load into<br>virtual memory.</p>
</blockquote>
<p>由 <code>program header table</code> 定义 segments。由于 segment 提供运行时视角，因此只有可执行目标文件才有这个，不可执行的目标文件没有。</p>
<h2 id="Program-Header-Table"><a href="#Program-Header-Table" class="headerlink" title="Program Header Table"></a>Program Header Table</h2><p>Only appears in the executable. Contains information of how the executable should be put into the process virtual memory.</p>
<p>The executable is generated from object files by the linker. The main jobs that the linker does are:</p>
<ul>
<li>determine which sections of the object files will go into which segments of the executable.<br>  In Binutils, this comes down to parsing a linker script, and dealing with a bunch of defaults. You can get the linker script used with <code>ld --verbose</code>, and set a custom one with <code>ld -T</code>.</li>
<li>do relocation according to the <code>.rela.text</code> section. This depends on how the multiple sections are put into memory.</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word	p_type;			<span class="comment">/* Segment type */</span></span><br><span class="line">  Elf64_Word	p_flags;		<span class="comment">/* Segment flags */</span></span><br><span class="line">  Elf64_Off	p_offset;		<span class="comment">/* Segment file offset */</span></span><br><span class="line">  Elf64_Addr	p_vaddr;		<span class="comment">/* Segment virtual address */</span></span><br><span class="line">  Elf64_Addr	p_paddr;		<span class="comment">/* Segment physical address */</span></span><br><span class="line">  Elf64_Xword	p_filesz;		<span class="comment">/* Segment size in file */</span></span><br><span class="line">  Elf64_Xword	p_memsz;		<span class="comment">/* Segment size in memory */</span></span><br><span class="line">  Elf64_Xword	p_align;		<span class="comment">/* Segment alignment */</span></span><br><span class="line">&#125; Elf64_Phdr;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:~/demo$ readelf -l hello_world.out </span><br><span class="line"></span><br><span class="line">Elf file type is EXEC (Executable file)</span><br><span class="line">Entry point 0x4000b0</span><br><span class="line">There are 2 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           0x0000000000000000 0x0000000000400000 0x0000000000400000</span><br><span class="line">                 0x00000000000000d7 0x00000000000000d7  R E    0x1000</span><br><span class="line">  LOAD           0x00000000000000d7 0x00000000004010d7 0x00000000004010d7</span><br><span class="line">                 0x000000000000000e 0x000000000000000e  RW     0x1000</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .text </span><br><span class="line">   01     .data </span><br></pre></td></tr></table></figure>

<h3 id="p-type"><a href="#p-type" class="headerlink" title="p_type"></a>p_type</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># /usr/include/elf.h</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Legal values for p_type (segment type).  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    PT_NULL        0        <span class="comment">/* Program header table entry unused */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOAD        1        <span class="comment">/* Loadable program segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_DYNAMIC    2        <span class="comment">/* Dynamic linking information */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_INTERP    3        <span class="comment">/* Program interpreter */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_NOTE        4        <span class="comment">/* Auxiliary information */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_SHLIB    5        <span class="comment">/* Reserved */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_PHDR        6        <span class="comment">/* Entry for header table itself */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_TLS        7        <span class="comment">/* Thread-local storage segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    PT_NUM        8        <span class="comment">/* Number of defined types */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOOS        0x60000000    <span class="comment">/* Start of OS-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_GNU_EH_FRAME    0x6474e550    <span class="comment">/* GCC .eh_frame_hdr segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_GNU_STACK    0x6474e551    <span class="comment">/* Indicates stack executability */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_GNU_RELRO    0x6474e552    <span class="comment">/* Read-only after relocation */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOSUNW    0x6ffffffa</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_SUNWBSS    0x6ffffffa    <span class="comment">/* Sun Specific segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_SUNWSTACK    0x6ffffffb    <span class="comment">/* Stack segment */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_HISUNW    0x6fffffff</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_HIOS        0x6fffffff    <span class="comment">/* End of OS-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_LOPROC    0x70000000    <span class="comment">/* Start of processor-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PT_HIPROC    0x7fffffff    <span class="comment">/* End of processor-specific */</span></span></span><br></pre></td></tr></table></figure>

<h4 id="PT-PHDR"><a href="#PT-PHDR" class="headerlink" title="PT_PHDR"></a>PT_PHDR</h4><blockquote>
<p>PT_PHDR segment, which encompasses the program header table.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000400040 0x0000000000400040 0x000268 0x000268 R   0x8</span><br><span class="line"></span><br><span class="line">Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br></pre></td></tr></table></figure>

<h4 id="PT-LOAD"><a href="#PT-LOAD" class="headerlink" title="PT_LOAD"></a>PT_LOAD</h4><blockquote>
<p>Segments of type PT_LOAD, as the name implies, are intended to be loaded<br>into memory when setting up the process. The size of the loadable chunk<br>and the address to load it at are described in the rest of the program header.<br>As you can see in the readelf output, there are usually at least two PT_LOAD<br>segments—one encompassing the nonwritable sections and one containing<br>the writable data sections.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000400040 0x0000000000400040 0x000268 0x000268 R   0x8</span><br><span class="line">  INTERP         0x0002a8 0x00000000004002a8 0x00000000004002a8 0x00001c 0x00001c R   0x1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line">  LOAD           0x000000 0x0000000000400000 0x0000000000400000 0x000400 0x000400 R   0x1000</span><br><span class="line">  LOAD           0x001000 0x0000000000401000 0x0000000000401000 0x0001d5 0x0001d5 R E 0x1000</span><br><span class="line">  LOAD           0x002000 0x0000000000402000 0x0000000000402000 0x0000d0 0x0000d0 R   0x1000</span><br><span class="line">  LOAD           0x002e50 0x0000000000403e50 0x0000000000403e50 0x0001d8 0x0001e0 RW  0x1000</span><br><span class="line">  DYNAMIC        0x002e60 0x0000000000403e60 0x0000000000403e60 0x000190 0x000190 RW  0x8</span><br><span class="line">  NOTE           0x0002c4 0x00000000004002c4 0x00000000004002c4 0x000044 0x000044 R   0x4</span><br><span class="line">  GNU_EH_FRAME   0x002004 0x0000000000402004 0x0000000000402004 0x00002c 0x00002c R   0x4</span><br><span class="line">  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RWE 0x10</span><br><span class="line">  GNU_RELRO      0x002e50 0x0000000000403e50 0x0000000000403e50 0x0001b0 0x0001b0 R   0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br><span class="line">   01     .interp </span><br><span class="line">   02     .interp .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn </span><br><span class="line">   03     .init .text .fini </span><br><span class="line">   04     .rodata .eh_frame_hdr .eh_frame </span><br><span class="line">   05     .init_array .fini_array .dynamic .got .got.plt .data .bss </span><br><span class="line">   06     .dynamic </span><br><span class="line">   07     .note.gnu.build-id .note.ABI-tag </span><br><span class="line">   08     .eh_frame_hdr </span><br><span class="line">   09     </span><br><span class="line">   10     .init_array .fini_array .dynamic .got </span><br></pre></td></tr></table></figure>

<h4 id="PT-DYNAMIC"><a href="#PT-DYNAMIC" class="headerlink" title="PT_DYNAMIC"></a>PT_DYNAMIC</h4><p><code>PT_DYNAMIC</code> segment contains the <code>.dynamic</code> section, which tells the interpreter how to parse and prepare the binary for execution. </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">wqj@WQJ:/home/cpp/build/self_mutate$ readelf --wide --segments demo</span><br><span class="line"></span><br><span class="line">Elf file type is EXEC (Executable file)</span><br><span class="line">Entry point 0x401020</span><br><span class="line">There are 11 program headers, starting at offset 64</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000400040 0x0000000000400040 0x000268 0x000268 R   0x8       0</span><br><span class="line">  INTERP         0x0002a8 0x00000000004002a8 0x00000000004002a8 0x00001c 0x00001c R   0x1       1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line">  LOAD           0x000000 0x0000000000400000 0x0000000000400000 0x000400 0x000400 R   0x1000    2</span><br><span class="line">  LOAD           0x001000 0x0000000000401000 0x0000000000401000 0x0001d5 0x0001d5 R E 0x1000    3</span><br><span class="line">  LOAD           0x002000 0x0000000000402000 0x0000000000402000 0x0000d0 0x0000d0 R   0x1000    4</span><br><span class="line">  LOAD           0x002e50 0x0000000000403e50 0x0000000000403e50 0x0001d8 0x0001e0 RW  0x1000    5</span><br><span class="line"></span><br><span class="line">  DYNAMIC        0x002e60 0x0000000000403e60 0x0000000000403e60 0x000190 0x000190 RW  0x8       6</span><br><span class="line"></span><br><span class="line">  NOTE           0x0002c4 0x00000000004002c4 0x00000000004002c4 0x000044 0x000044 R   0x4</span><br><span class="line">  GNU_EH_FRAME   0x002004 0x0000000000402004 0x0000000000402004 0x00002c 0x00002c R   0x4</span><br><span class="line">  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RWE 0x10</span><br><span class="line">  GNU_RELRO      0x002e50 0x0000000000403e50 0x0000000000403e50 0x0001b0 0x0001b0 R   0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br><span class="line">   01     .interp </span><br><span class="line">   02     .interp .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn </span><br><span class="line">   03     .init .text .fini </span><br><span class="line">   04     .rodata .eh_frame_hdr .eh_frame </span><br><span class="line">   05     .init_array .fini_array .dynamic .got .got.plt .data .bss </span><br><span class="line"></span><br><span class="line">   06     .dynamic </span><br><span class="line"></span><br><span class="line">   07     .note.gnu.build-id .note.ABI-tag </span><br><span class="line">   08     .eh_frame_hdr </span><br><span class="line">   09     </span><br><span class="line">   10     .init_array .fini_array .dynamic .got </span><br></pre></td></tr></table></figure>

<h4 id="PT-INTERP"><a href="#PT-INTERP" class="headerlink" title="PT_INTERP"></a>PT_INTERP</h4><p>The PT_INTERP segment contains the .interp section, which provides the name of the interpreter that is to be used to load the binary.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align</span><br><span class="line">  PHDR           0x000040 0x0000000000400040 0x0000000000400040 0x000268 0x000268 R   0x8</span><br><span class="line">  INTERP         0x0002a8 0x00000000004002a8 0x00000000004002a8 0x00001c 0x00001c R   0x1</span><br><span class="line">      [Requesting program interpreter: /lib64/ld-linux-x86-64.so.2]</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     </span><br><span class="line">   01     .interp </span><br></pre></td></tr></table></figure>

<h3 id="p-flag"><a href="#p-flag" class="headerlink" title="p_flag"></a>p_flag</h3><p>The flags specify the runtime access permissions for the segment.</p>
<h4 id="PF-X"><a href="#PF-X" class="headerlink" title="PF_X"></a>PF_X</h4><p>The PF_X flag indicates that the segment is executable and is set for code segments (readelf displays it as an E rather than an X in the Flg column</p>
<h4 id="PF-W"><a href="#PF-W" class="headerlink" title="PF_W"></a>PF_W</h4><p>The PF_W flag means that the segment is writable, and it is normally set only for writable data segments, never for code segments.</p>
<h4 id="PF-R"><a href="#PF-R" class="headerlink" title="PF_R"></a>PF_R</h4><p>PF_R means that the segment is readable, as is normally the case for both code and data segments.</p>
<h3 id="p-offset-p-vaddr-and-p-filesz"><a href="#p-offset-p-vaddr-and-p-filesz" class="headerlink" title="p_offset, p_vaddr, and p_filesz"></a>p_offset, p_vaddr, and p_filesz</h3><p>They specify the file offset at which the segment starts, the virtual address at which it is to be loaded, and the file size of the segment, respectively. </p>
<h3 id="p-paddr"><a href="#p-paddr" class="headerlink" title="p_paddr"></a>p_paddr</h3><p>On modern operating systems such as Linux, this field is unused and set to zero since they execute all binaries in virtual memory.</p>
<h3 id="p-memsz"><a href="#p-memsz" class="headerlink" title="p_memsz"></a>p_memsz</h3><p><code>p_filesz</code> is the file size of the segment and <code>p_memsz</code> is the size in memory. To understand this, recall that some sections only indicate the need to allocate some bytes in memory but don’t actually occupy these bytes in the binary file. For instance, the <code>.bss</code> section contains zero-initialized data. Since all data in this section is known to be zero anyway, there’s no need to actually include all these zeros in the binary. However, when loading the segment containing <code>.bss</code> into virtual memory, all the bytes in <code>.bss</code> should be allocated. Thus, it’s possible for <code>p_memsz</code> to be larger than <code>p_filesz</code>. When this happens, the loader adds the extra bytes at the end of the segment when loading the binary and initializes them to zero.</p>
<h3 id="p-align"><a href="#p-align" class="headerlink" title="p_align"></a>p_align</h3><p>It indicates the required memory alignment (in bytes) for the segment. An alignment value of 0 or 1 indicates that no particular alignment is required. If <code>p_align</code> isn’t set to 0 or 1, then its value must be a power of 2, and <code>p_vaddr</code> must be equal to <code>p_offset</code>, modulo p_align.</p>
<h1 id="Hash-Table"><a href="#Hash-Table" class="headerlink" title="Hash Table"></a>Hash Table</h1><p><a target="_blank" rel="noopener" href="https://flapenguin.me/elf-dt-hash">https://flapenguin.me/elf-dt-hash</a></p>
<h1 id="Dynamic-Linking"><a href="#Dynamic-Linking" class="headerlink" title="Dynamic Linking"></a>Dynamic Linking</h1><p>The information for dynamic linking is provided in the .dynsym, .dynstr, .interp, .hash, .dynamic, .rel, .rela, .got and.plt sections.</p>
<h1 id="Relocation"><a href="#Relocation" class="headerlink" title="Relocation"></a>Relocation</h1><p>主要参考这篇文章：</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/">Position Independent Code (PIC) in shared libraries - Eli Bendersky’s website</a></p>
</blockquote>
<blockquote>
<p>Relocation is the process of connecting symbolic references with symbolic definitions. For<br>example, when a program calls a function, the associated call instruction must transfer control<br>to the proper destination address at execution. In other words, relocatable files must have<br>information that describes how to modify their section contents, thus allowing executable and<br>shared object files to hold the right information for a process’s program image. Relocation<br>entries are these data.</p>
</blockquote>
<p>Transform a relocatable file into either an executable or a shared object file. The link editor merges one or more relocatable files to form the output. It first decides how to combine and locate the input files, then updates the symbol values, and finally performs the relocation. Relocations applied to executable or shared object files are similar and accomplish the same result.</p>
<p><em>relocations</em> are entries in binaries that are left to be filled in later – at link time by the toolchain linker or at runtime by the dynamic linker.</p>
<blockquote>
<p>Briefly, when the linker creates a shared library, it doesn’t know in advance where it might be loaded.</p>
<p>There are two main approaches to solve this problem in Linux ELF shared libraries:</p>
<ol>
<li>Load-time relocation</li>
<li>Position independent code (PIC)</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/">Position Independent Code (PIC) in shared libraries - Eli Bendersky’s website</a></p>
</blockquote>
<h2 id="Static-Relocation"><a href="#Static-Relocation" class="headerlink" title="Static Relocation"></a>Static Relocation</h2><p>静态链接器</p>
<h2 id="Dynamic-Relocation"><a href="#Dynamic-Relocation" class="headerlink" title="Dynamic Relocation"></a>Dynamic Relocation</h2><p>动态链接器 <code>/lib/ld-linux.so</code> 重定位程序对共享库中符号的引用的过程。</p>
<h3 id="PIC-Variable"><a href="#PIC-Variable" class="headerlink" title="PIC Variable"></a>PIC Variable</h3><p>单独由 <code>.got</code> section实现。</p>
<h4 id="Example-PIC变量"><a href="#Example-PIC变量" class="headerlink" title="Example - PIC变量"></a>Example - PIC变量</h4><p>读取动态库中的全局变量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dataonly.h</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> myglob;</span><br><span class="line"><span class="type">int</span> <span class="title function_">ml_func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dataonly.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ml_func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> myglob + a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;dataonly.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    ml_func(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -fpic -shared -m32 -o libmlpic_dataonly.so dataonly.c</span><br><span class="line">gcc -m32 -o dataonlymain dataonlymain.c -L. -lmlpic_dataonly -g</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:. gdb dataonlymain</span></span><br><span class="line">(gdb) b ml_func</span><br></pre></td></tr></table></figure>

<p>从 .got 中取得 myglob 的绝对地址，.got中的绝对地址是 ld-linux.so 将 libmlpic_dataonly.so 加载后立刻解析出填充的。</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102847.png"></p>
<p>.got 是静态链接器和动态连接器协商的结果，静态链接器将所有对 myglob 的访问都改成从.got取绝对地址，动态链接器加载动态库时，填充对应的绝对地址。</p>
<h3 id="PIC-Function-Lazy-Binding"><a href="#PIC-Function-Lazy-Binding" class="headerlink" title="PIC Function (Lazy Binding)"></a>PIC Function (Lazy Binding)</h3><p>PIC函数符号的绝对地址不是像PIC变量一样直接填充到<code>.got</code>，而是通过 lazy binding 实现，又多绕一层。首先，动态库中函数比全局变量多，开销更大；其次，有很多动态库函数，比如处理错误的，有可能在运行时根本不会调用到。为优化效率，PIC函数借助PLT实现lazy binding。</p>
<blockquote>
<p>When a shared library refers to some function, the real address of that function is not known until load time. Resolving this address is called <em>binding</em>, and it’s something the dynamic loader does when it loads the shared library into the process’s memory space. This binding process is non-trivial, since the loader has to actually <em>look up</em> the function symbol in special tables <a target="_blank" rel="noopener" href="https://eli.thegreenplace.net/2011/11/03/position-independent-code-pic-in-shared-libraries/#id13">[5]</a>.</p>
<p>So, resolving each function takes time. Not a lot of time, but it adds up since the amount of functions in libraries is typically much larger than the amount of global variables. Moreover, most of these resolutions are done in vain, because in a typical run of a program only a fraction of functions actually get called (think about various functions handling error and special conditions, which typically don’t get called at all).</p>
<p>So, to speed up this process, a clever lazy binding scheme was devised. “Lazy” is a generic name for a family of optimizations in computer programming, where work is delayed until the last moment when it’s actually needed, with the intention of avoiding doing this work if its results are never required during a specific run of a program. Good examples of laziness are <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Copy-on-write">copy-on-write</a> and <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Lazy_evaluation">lazy evaluation</a>.</p>
</blockquote>
<p>由<code>.plt</code> + <code>.got.plt</code> 两个section配合实现。</p>
<p>函数首次调用时：</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220102952.png" alt="image.png"></p>
<p>上图的 GOT 是 <code>.got.plt</code></p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220103009.png" alt="image.png"></p>
<p>后续的函数调用：</p>
<p><img src="https://raw.githubusercontent.com/wangqingjia1999/img/master/20240220103030.png" alt="image.png"></p>
<h4 id="Example-PIC函数"><a href="#Example-PIC函数" class="headerlink" title="Example - PIC函数"></a>Example - PIC函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ml_util_func</span><span class="params">(<span class="type">int</span> a)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ml_func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dynamic linker 听好了，你找到 ml_util_func 的绝对地址后，给我写入 0x2008 这个地址。</p>
<blockquote>
<p>The last line means that the dynamic loader should place the value (address) of symbol ml_util_func into 0x2008 (which, recall, is the GOT entry for this function).</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">readelf -r libmlpic.so</span></span><br><span class="line">[...] snip output</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.plt&#x27; at offset 0x328 contains 3 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00002000  00000107 R_386_JUMP_SLOT   00000000   __cxa_finalize</span><br><span class="line">00002004  00000207 R_386_JUMP_SLOT   00000000   __gmon_start__</span><br><span class="line">00002008  00000707 R_386_JUMP_SLOT   0000046c   ml_util_func</span><br></pre></td></tr></table></figure>





<h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://refspecs.linuxbase.org/elf/elf.pdf">ELF标准定义文档</a></p>
</li>
<li><p>动态链接详解 - 你说起一个什么名的文章 - 知乎<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/263094043">https://zhuanlan.zhihu.com/p/263094043</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gnuemacs/p/14523720.html">https://www.cnblogs.com/gnuemacs/p/14523720.html</a></p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/linux/" rel="tag"># linux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/02/21/note/linux/readelf/" rel="prev" title="Linux readelf">
                  <i class="fa fa-angle-left"></i> Linux readelf
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/02/23/note/linux/xxd/" rel="next" title="Linux xxd">
                  Linux xxd <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">折纸飞向麦田</span>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
